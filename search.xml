<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title><![CDATA[Socket program]]></title>
    <url>%2Fsocket-program%2F</url>
    <content type="text"><![CDATA[TCP(Transmission Control Protocol) æ˜¯ç”± IETF çš„ RFC 793 å®šä¹‰çš„ä¸€ç§é¢å‘è¿žæŽ¥çš„ã€å¯é çš„ã€åŸºäºŽå­—èŠ‚æµçš„ä¼ è¾“å±‚é€šä¿¡åè®®ã€‚ TCP æŠ¥æ–‡æ®µTCP æ•°æ®è¢«å°è£…åœ¨ä¸€ä¸ª IP æ•°æ®æŠ¥ä¸­ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š ä¸‹å›¾æ˜¯ TCP é¦–éƒ¨çš„æ•°æ®æ ¼å¼ï¼Œå¦‚æžœä¸è®¡ä»»é€‰å­—æ®µï¼Œå®ƒé€šå¸¸æ˜¯20ä¸ªå­—èŠ‚ï¼š ä¸‹é¢ä»‹ç»é‡è¦çš„å‡ ä¸ªæ•°æ®ï¼š 32ä½åºå·ï¼šè¡¨ç¤ºæ•°æ®å½“å‰å‘é€çš„ç¬¬ä¸€ä¸ªå­—èŠ‚åœ¨å­—èŠ‚æµä¸­çš„åºå· 32ä½ç¡®è®¤å·ï¼šè¡¨ç¤ºå‘é€ç«¯æ‰€æœŸæœ›æ”¶åˆ°çš„ä¸‹ä¸€ä¸ªåºå·ï¼Œå› æ­¤è¯¥åºå·ä½ä¸Šä¸€æ¬¡æ”¶åˆ°çš„åºå·åŠ ä¸€ 6ä¸ªç‰¹æ®Šæ ‡å¿—bit: (æŒ‰ç…§æŽ’åˆ—é¡ºåº) URG: ç´§æ€¥æŒ‡é’ˆæœ‰æ•ˆ ACKï¼šç¡®è®¤åºå·æœ‰æ•ˆ PSHï¼šæŽ¥æ”¶æ–¹åº”è¯¥å°½å¿«å°†è¿™ä¸ªæŠ¥æ–‡æ®µäº¤ç»™åº”ç”¨å±‚ RSTï¼šé‡å»ºè¿žæŽ¥ SYNï¼šåŒæ­¥åºå·ï¼Œç”¨æ¥å‘èµ·ä¸€ä¸ªè¿žæŽ¥ FINï¼šå‘é€ç«¯å®Œæˆä»»åŠ¡ï¼Œå…³é—­å‘é€ç«¯åˆ°æŽ¥æ”¶ç«¯è¿žæŽ¥ å…¶ä½™çš„è§£é‡Šè¯·å‚è€ƒ TCP/IP åè®®è¯¦è§£ã€‚ TCP è¿žæŽ¥çš„çŠ¶æ€å›¾ TCP è¿žæŽ¥çš„å»ºç«‹ä¸Žç»ˆæ­¢TCP æ˜¯ä¸€ä¸ªé¢å‘è¿žæŽ¥çš„é€šä¿¡åè®®ï¼Œè¿™è¦æ±‚é€šä¿¡åŒæ–¹åœ¨è¿›è¡Œé€šä¿¡ä¹‹å‰ï¼Œéœ€è¦å…ˆå»ºç«‹å…¶è¿žæŽ¥ã€‚åœ¨å¸¸è§çš„å®¢æˆ·ç«¯ã€æœåŠ¡å™¨æ¨¡å¼çš„ç¨‹åºä¸­ï¼Œé€šå¸¸æ˜¯æœåŠ¡å™¨ç»‘å®šç«¯å£ï¼Œå¹¶åœ¨è¯¥ç«¯å£ä¸Šç›‘å¬å®¢æˆ·ç«¯è¿žæŽ¥è¯·æ±‚ï¼›å®¢æˆ·ç«¯ä¸»åŠ¨å‘æœåŠ¡å™¨å‘èµ·è¿žæŽ¥è¯·æ±‚ï¼Œå¾…æœåŠ¡å™¨å“åº”åŽï¼ŒåŒæ–¹å»ºç«‹èµ·ä¸€æ¡é€šä¿¡é“¾è·¯ã€‚ å»ºç«‹TCP è¿žæŽ¥å»ºç«‹æ—¶é€šä¿¡åŒæ–¹çš„åˆ†ç»„æŠ¥æ–‡å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š å¦‚å›¾æ‰€ç¤ºï¼Œå®¢æˆ·ç«¯è°ƒç”¨connectï¼Œæ­¤æ—¶å®¢æˆ·ç«¯å‘é€SYNæŠ¥æ–‡ï¼›æœåŠ¡ç«¯è°ƒç”¨acceptæŽ¥å—è¯¥è¿žæŽ¥è¯·æ±‚ï¼ŒåŒæ—¶å‘é€SYNå’ŒACKï¼›ç­‰åˆ°å®¢æˆ·ç«¯å“åº”äº†ACKåŽï¼ŒåŒæ–¹å»ºç«‹èµ·å®Œæ•´è¿žæŽ¥ã€‚ å°†ä¸Šè¿°è¿‡ç¨‹æ˜ å°„åˆ°TCPçŠ¶æ€å›¾ä¸Šè¿›è¡Œè§‚å¯Ÿï¼Œåœ¨æœåŠ¡å™¨ç«¯ï¼š åˆšå¼€å§‹æœåŠ¡å™¨å¤„äºŽCLOSEDçŠ¶æ€ã€‚ æœåŠ¡å™¨åˆå§‹åŒ–æ—¶ç»‘å®šäº†å…·ä½“çš„ç«¯å£ï¼Œå¹¶è°ƒç”¨ listenç›‘å¬è¯¥ç«¯å£ï¼Œè¿›å…¥äº†LISTENçŠ¶æ€ã€‚ æœåŠ¡ç«¯æŽ¥æ”¶åˆ°äº†æ¥è‡ªå®¢æˆ·ç«¯çš„SYNæŠ¥æ–‡ï¼Œå‘é€SYNå’ŒACKç»™å®¢æˆ·ç«¯ï¼Œç„¶åŽè¿›å…¥SYN_RCVDçŠ¶æ€ã€‚ å½“æœåŠ¡ç«¯æŽ¥æ”¶åˆ°äº†å®¢æˆ·ç«¯å‘é€çš„ACKæ—¶ï¼Œè¿›å…¥ESTABLISHEDçŠ¶æ€ã€‚ å®¢æˆ·ç«¯æ–¹é¢ï¼š å¼€å§‹åŒæ ·å¤„äºŽCLOSEDçŠ¶æ€ã€‚ åº”ç”¨ä¸»åŠ¨è°ƒç”¨connectå‘èµ·è¿žæŽ¥ï¼Œå‘é€SYNæŠ¥æ–‡ç»™æœåŠ¡å™¨ï¼Œç„¶åŽè¿›å…¥ SYN_SENDçŠ¶æ€ã€‚ å½“æ”¶åˆ°æœåŠ¡å™¨çš„SYNå’ŒACKåŽï¼Œå‘é€å¯¹åº”çš„ACKç»™æœåŠ¡å™¨ï¼Œå¹¶è¿›å…¥ESTABLISHEDçŠ¶æ€ã€‚ å½“åŒæ–¹éƒ½è¿›å…¥ESTABLISHEDçŠ¶æ€æ—¶ï¼Œè¡¨ç¤ºè¿žæŽ¥å·²ç»å»ºç«‹æˆåŠŸã€‚ å¦‚æžœï¼Œå®¢æˆ·ç«¯åœ¨å‘é€äº†SYNæŠ¥æ–‡åŽï¼Œç­‰å¾…è¶…æ—¶ï¼Œé‡è¯•å‡ æ¬¡åŽï¼Œä¾¿ä¼šè§¦å‘ Timeoutè¿›å…¥CLOSED ï¼Œåœ¨åº”ç”¨å±‚åˆ™è¡¨ç¤ºä¸ºconnectå‡½æ•°è°ƒç”¨å¤±è´¥ã€‚ å…³é—­è¿žæŽ¥FINæŠ¥æ–‡ç”¨äºŽé€šçŸ¥å¯¹æ–¹å…³é—­æœ¬æ–¹å‘çš„è¿žæŽ¥ã€‚ç”±äºŽTCPæ˜¯ä¸€ä¸ªå…¨åŒå·¥çš„é€šä¿¡åè®®ï¼Œåƒç®¡é“ä¸€æ ·ï¼Œæ”¯æŒå…³é—­æŸä¸€æ–¹å‘ä¸Šçš„è¿žæŽ¥ï¼Œæ‰€ä»¥åœ¨TCPä¸­å…³é—­è¿žæŽ¥éœ€è¦åŒæ–¹éƒ½å‘é€FINæŠ¥æ–‡ã€‚æ­¤æ—¶åˆ†ç»„æŠ¥æ–‡å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š å½“æŸä¸€æ–¹å…³é—­è¿žæŽ¥æ—¶ï¼Œå‘é€FINæŠ¥æ–‡ç»™å¦ä¸€æ–¹ï¼Œå¯¹æ–¹å›žå¤ACKï¼ŒåŒæ—¶ä¹Ÿå‘é€ FINæŠ¥æ–‡ï¼›ç­‰åˆ°åŒæ–¹éƒ½æ”¶åˆ°æœ€åŽçš„ACKåŽï¼Œè¿žæŽ¥å…³é—­ã€‚å½“ç„¶ï¼Œå¦‚æžœå¦ä¸€æ–¹åªå›žå¤äº†ACKè€Œæ²¡æœ‰å‘é€FINæŠ¥æ–‡ï¼Œåˆ™è¡¨ç¤ºå¯¹æ–¹ä»ç„¶æƒ³è¦å‘é€æ•°æ®ï¼Œè¿™ç§æƒ…å†µç§°ä¸ºTCPçš„åŠå…³é—­ã€‚åªæœ‰å½“åŒæ–¹éƒ½å‘é€äº†FINå¹¶æŽ¥æ”¶åˆ°å¯¹æ–¹çš„ACKåŽï¼Œæ‰ç®—çœŸæ­£çš„è¿žæŽ¥å…³é—­ã€‚æ‰€ä»¥ä¸Šå›¾ä¸­Serverç«¯çš„FINæŠ¥æ–‡å¯ä»¥åœ¨æŽ¥æ”¶åˆ°Clientçš„FINæŠ¥æ–‡åŽï¼Œéš”ä¸€æ®µæ—¶é—´å†å‘é€ã€‚ åœ¨çŠ¶æ€å›¾ä¸­å¯¹åº”äº†ä¸»åŠ¨å…³é—­å’Œè¢«åŠ¨å…³é—­ï¼Œé¦–å…ˆè§‚å¯Ÿä¸»åŠ¨å…³é—­ï¼š å½“åº”ç”¨è°ƒç”¨closeåŽï¼Œå‘é€FINæŠ¥æ–‡ç»™å¯¹æ–¹ï¼Œå¹¶ç”±ESTABLISHEDçŠ¶æ€è¿›å…¥FIN_WAIT_1çŠ¶æ€ã€‚ æ”¶åˆ°ACKæŠ¥æ–‡åŽï¼Œè¿›å…¥FIN_WAIT_2çŠ¶æ€ã€‚ ç­‰å¾…å¯¹æ–¹çš„FINæŠ¥æ–‡åˆ°è¾¾ï¼Œå¹¶å‘é€ACKç»™å¯¹æ–¹ï¼Œè¿›å…¥TIME_WAITçŠ¶æ€ã€‚ å¦‚æžœåœ¨ FIN_WAIT_1çŠ¶æ€ç›´æŽ¥æŽ¥æ”¶åˆ°FINå’ŒACKï¼Œåˆ™ç›´æŽ¥è¿›å…¥TIME_WAITçŠ¶æ€ã€‚ TIME_WAITçŠ¶æ€ç­‰å¾…äº†2 MSLåŽï¼Œè¿›å…¥CLOSEDçŠ¶æ€ï¼Œæ­¤æ—¶è¿žæŽ¥å…³é—­ã€‚ è¢«åŠ¨å…³é—­åˆ™ç®€å•å¾—å¤šï¼š å½“æ”¶åˆ°å¯¹æ–¹çš„FINæŠ¥æ–‡åŽï¼Œå‘é€ACKå¹¶ç”±ESTABLISHEDè¿›å…¥ CLOSE_WAITçŠ¶æ€ã€‚ ç”¨æˆ·å±‚è°ƒç”¨closeåŽï¼Œå‘é€FINæŠ¥æ–‡åŒæ—¶è¿›å…¥LAST_ACKçŠ¶æ€ã€‚ æŽ¥æ”¶åˆ°å¯¹æ–¹çš„ ACK åŽï¼Œè¿›å…¥CLOSEDçŠ¶æ€ï¼Œè¿žæŽ¥å…³é—­ã€‚ TIME_WAITçŠ¶æ€å¯èƒ½æ—¶çŠ¶æ€å›¾ä¸­æœ€ä¸æ˜“æ‡‚çš„åœ°æ–¹ï¼Œå®ƒä¹Ÿè¢«ç§°ä¸º 2 MSL çŠ¶æ€ã€‚æ¯ä¸€ä¸ªå…·ä½“TCPå®žçŽ°å¿…é¡»é€‰æ‹©ä¸€ä¸ªæŠ¥æ–‡æ®µæœ€å¤§ç”Ÿå­˜æ—¶é—´MSL(Maximum Segment Lifetime)ï¼Œè¡¨ç¤ºä»»ä½•æŠ¥æ–‡æ®µè¢«ä¸¢å¼ƒå‰èƒ½åœ¨ç½‘ç»œä¸­å­˜æ´»çš„æ—¶é—´ã€‚å½“TCPæ‰§è¡Œä¸»åŠ¨å…³é—­å¹¶å‘é€äº†ACKç»™å¯¹æ–¹è¿›å…¥TIME_WAITçŠ¶æ€åŽï¼Œè¯¥è¿žæŽ¥å¿…é¡»åœ¨TIME_WAITçŠ¶æ€åœç•™2å€çš„MSLã€‚è¿™æ ·å¯ä»¥ä¿è¯TCPåœ¨è¶…æ—¶åŽå†æ¬¡å‘é€æœ€åŽçš„ACKæŠ¥æ–‡ä»¥é˜²æ­¢è¿™ä¸ªACKæŠ¥æ–‡ä¸¢å¤±ã€‚ä½¿ç”¨2 MSLçš„å¦å¤–ä¸€ç‚¹æ˜¯ï¼Œå½“å‰çš„socketå…³é—­åŽï¼Œå¯èƒ½ç«‹å³è¢«ç”¨äºŽå»ºç«‹å¦ä¸€ä¸ªTCPè¿žæŽ¥ï¼Œè€Œç½‘ç»œä¸­å¯èƒ½å­˜åœ¨ç€å°šæœªåˆ°è¾¾å…·æœ‰TIME_WAITçŠ¶æ€ä¸€æ–¹çš„åŒ…ï¼Œéœ€è¦ä¿è¯è¿™äº›åŒ…ä¸ä¼šå½±å“åˆ°æŽ¥ä¸‹æ¥å³å°†å»ºç«‹çš„è¿žæŽ¥ã€‚2 MSLçš„æ—¶é—´é—´éš”ä¸­ä¸å…è®¸socketè¢«é‡æ–°ä½¿ç”¨ï¼ŒåŒæ—¶ä¹Ÿèƒ½å¤Ÿä¿è¯æ¶ˆè€—æŽ‰ç½‘ç»œä¸­çš„åŒ…ã€‚æ‰€ä»¥TIME_WAITçŠ¶æ€å­˜åœ¨æœ‰ä¸¤ä¸ªç†ç”±ï¼š å¯é åœ°å®žçŽ° TCP å…¨åŒå·¥è¿žæŽ¥çš„ç»ˆæ­¢ å…è®¸è€çš„é‡å¤çš„åŒ…åœ¨ç½‘ç»œä¸­æ¶ˆé€ å…³äºŽLAST_ACKçŠ¶æ€å’ŒTIME_WAITEçŠ¶æ€ï¼Œä¸‹é¢å‡è®¾ï¼šä¸»åŠ¨å…³é—­çš„ä¸€ç«¯ä¸ºAï¼Œè¢«åŠ¨å…³é—­çš„ä¸€ç«¯ä¸ºBï¼Œæ ¹æ®Bæ˜¯å¦æ”¶åˆ°æœ€åŽçš„ACKåŒ…åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š Bå‘é€FINï¼Œè¿›å…¥LAST_ACKçŠ¶æ€ï¼ŒAæ”¶åˆ°è¿™ä¸ªFINåŒ…åŽå‘é€ACKåŒ…ï¼ŒBæ”¶åˆ°è¿™ä¸ªACKåŒ…ï¼Œç„¶åŽè¿›å…¥CLOSEDçŠ¶æ€ Bå‘é€FINï¼Œè¿›å…¥LAST_ACKçŠ¶æ€ï¼ŒAæ”¶åˆ°è¿™ä¸ªFINåŒ…åŽå‘é€ACKåŒ…ï¼Œç”±äºŽæŸç§åŽŸå› ï¼Œè¿™ä¸ªACKåŒ…ä¸¢å¤±äº†ï¼ŒBæ²¡æœ‰æ”¶åˆ°ACKåŒ…ï¼Œç„¶åŽBç­‰å¾…ACKåŒ…è¶…æ—¶ï¼Œåˆå‘Aå‘é€äº†ä¸€ä¸ªFINåŒ… å‡å¦‚è¿™ä¸ªæ—¶å€™ï¼ŒAè¿˜æ˜¯å¤„äºŽTIME_WAITçŠ¶æ€(ä¹Ÿå°±æ˜¯TIME_WAITæŒç»­çš„æ—¶é—´åœ¨2 MSLå†…)ã€‚Aæ”¶åˆ°è¿™ä¸ªFINåŒ…åŽå‘Bå‘é€äº†ä¸€ä¸ªACKåŒ…ï¼ŒBæ”¶åˆ°è¿™ä¸ªACKåŒ…è¿›å…¥CLOSEDçŠ¶æ€ å‡å¦‚è¿™ä¸ªæ—¶å€™ï¼ŒAå·²ç»ä»ŽTIME_WAITçŠ¶æ€å˜æˆäº†CLOSEDçŠ¶æ€ã€‚Aæ”¶åˆ°è¿™ä¸ªFINåŒ…åŽï¼Œè®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªé”™è¯¯çš„è¿žæŽ¥ï¼Œå‘Bå‘é€ä¸€ä¸ªRSTåŒ…ï¼Œå½“Bæ”¶åˆ°è¿™ä¸ªRSTåŒ…ï¼Œè¿›å…¥CLOSEDçŠ¶æ€ å‡å¦‚è¿™ä¸ªæ—¶å€™ï¼ŒAæŒ‚äº†ï¼ˆå‡å¦‚è¿™å°æœºå™¨ç‚¸æŽ‰äº†ï¼‰ã€‚Bæ²¡æœ‰æ”¶åˆ°Açš„å›žåº”ï¼Œé‚£ä¹ˆä¼šç»§ç»­å‘é€FINåŒ…ï¼Œä¹Ÿå°±æ˜¯è§¦å‘äº†TCPçš„é‡ä¼ æœºåˆ¶ï¼Œå¦‚æžœAè¿˜æ˜¯æ²¡æœ‰å›žåº”ï¼ŒBè¿˜ä¼šç»§ç»­å‘é€FINåŒ…ï¼Œç›´åˆ°é‡ä¼ è¶…æ—¶(è‡³äºŽè¿™ä¸ªæ—¶é—´æ˜¯å¤šé•¿éœ€è¦ä»”ç»†ç ”ç©¶)ï¼ŒBé‡ç½®è¿™ä¸ªè¿žæŽ¥ï¼Œè¿›å…¥CLOSEDçŠ¶æ€ï¼Œå‚è€ƒé“¾æŽ¥çœ‹è¿™é‡Œ Ref TCP program TCP/IP State Transition Diagram åœ¨tcpåè®®ä¸­å¤„äºŽlast_ackçŠ¶æ€çš„è¿žæŽ¥ï¼Œå¦‚æžœä¸€ç›´æ”¶ä¸åˆ°å¯¹æ–¹çš„ackï¼Œä¼šä¸€ç›´å¤„äºŽè¿™ä¸ªçŠ¶æ€å—ï¼Ÿ Coping with the TCP TIME-WAIT state on busy Linux servers Maximum_segment_lifetime TCP Retransmission: how many packets will be re-sent?]]></content>
  </entry>
  <entry>
    <title><![CDATA[Apache Kylinçš„Top-Nè¿‘ä¼¼é¢„è®¡ç®—]]></title>
    <url>%2FTopN-approximate-precomputation-of-Apache-Kylin%2F</url>
    <content type="text"><![CDATA[åœ¨å¤§æ•°æ®å¤„ç†åœºæ™¯ï¼Œç”±äºŽæ•°æ®é‡å·¨å¤§ï¼ŒæŸäº›åŠŸèƒ½ä¸¥æ ¼å‡†ç¡®å®žçŽ°å¯èƒ½ä¼šè€—è´¹å¯è§‚çš„èµ„æºï¼Œç”šè‡³æ— æ³•è®¡ç®—ã€‚è¿™ç§æƒ…å†µéœ€è¦ç‰ºç‰²ä¸€å®šçš„å‡†ç¡®æ€§æ¥æ¢å–çš„çµæ´»æ€§å’Œæ€§èƒ½ã€‚åœ¨æœ€è¿‘é¡¹ç›®ä¸­éœ€è¦å®šæ—¶è®¡ç®—Top Nï¼Œå¹¶æä¾›æ•°å¤©å†…çš„Top Nï¼Œç»è¿‡è€ƒè™‘åŽï¼Œè®¡åˆ’æ¯æ¬¡è®¡ç®—å‡ºTop N * Mï¼Œç„¶åŽåˆå¹¶å‡ºTop Nï¼Œå½“ç„¶Mè¶Šå¤§ï¼Œæœ€ç»ˆçš„ç»“æžœè¶Šå‡†ç¡®ã€‚ä½†æ˜¯è¿˜æ˜¯å¸Œæœ›æ‰¾åˆ°ä¸šç•Œå¤„ç†ç±»ä¼¼é—®é¢˜çš„æ–¹æ¡ˆï¼Œæœ€ç»ˆæ‰¾åˆ°äº†ä¸‹é¢è¿™ç¯‡æ–‡ç« ã€‚ Apache Kylinæ˜¯ä¸€ä¸ªå¼€æºçš„åˆ†å¸ƒå¼åˆ†æžå¼•æ“Žï¼Œæä¾›Hadoopä¹‹ä¸Šçš„SQLæŸ¥è¯¢æŽ¥å£åŠå¤šç»´åˆ†æžï¼ˆOLAPï¼‰èƒ½åŠ›ä»¥æ”¯æŒè¶…å¤§è§„æ¨¡æ•°æ®ã€‚å®ƒèƒ½åœ¨äºšç§’å†…æŸ¥è¯¢å·¨å¤§çš„æ•°æ®é›† ã€‚æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»Apache Kylin 1.5ä¸­çš„æ–°åŠŸèƒ½ï¼š Top-Né¢„è®¡ç®—ã€‚ å¤§å®¶éƒ½å¬è¿‡äºŒå…«å®šå¾‹ï¼Œè¿™æ˜¯åœ¨å¾ˆå¤šé¢†åŸŸå­˜åœ¨çš„è§„å¾‹ï¼Œä¾‹å¦‚ä¸–ç•Œä¸Š20%çš„äººå æœ‰äº†è¶…è¿‡80%çš„è´¢å¯Œï¼›20%æœ€å—æ¬¢è¿Žçš„å•†å“ï¼Œè´¡çŒ®è¶…è¿‡äº†80%çš„é”€å”®é¢ç­‰ç­‰ã€‚ äºŒå…«å®šå¾‹èƒŒåŽçš„è§„å¾‹æ˜¯Zipfåˆ†å¸ƒæ³•åˆ™ï¼Œå®ƒæ˜¯ç¾Žå›½å­¦è€…G.K.é½æ™®å¤«åœ¨ç»Ÿè®¡è‹±æ–‡å•è¯å‡ºçŽ°é¢‘çŽ‡æ—¶å‘çŽ°çš„è§„å¾‹ã€‚ç®€å•è¯´å°±æ˜¯å¦‚æžœæŠŠé¢‘çŽ‡å‡ºçŽ°æœ€é«˜çš„å•è¯çš„é¢‘çŽ‡çœ‹ä½œæ˜¯1çš„è¯ï¼Œç¬¬äºŒä¸ªå‡ºçŽ°çš„é¢‘çŽ‡æ˜¯äºŒåˆ†ä¹‹ä¸€ï¼Œç¬¬ä¸‰ä¸ªæ˜¯ä¸‰åˆ†ä¹‹ä¸€ï¼Œä¾æ­¤ç±»æŽ¨ï¼Œå‡ºçŽ°çš„é¢‘çŽ‡æ˜¯å®ƒæŽ’åçš„æŸæ¬¡å¹‚åˆ†ä¹‹ä¸€ã€‚ åœ¨äº’è”ç½‘æ—¶ä»£ï¼Œè¿˜æœ‰ä¸€ä¸ªçŸ¥åçš„ç†è®ºï¼é•¿å°¾æ•ˆåº”ï¼Œä¸¾ä¾‹æ¥è¯´å°±æ˜¯æŸä¸ªç½‘ç«™çš„ç”¨æˆ·æˆ–è€…å•†å“çš„æ•°é‡éžå¸¸çš„å¤šï¼Œä½†æ˜¯å¤§éƒ¨åˆ†éƒ½æ˜¯è®¿é—®é¢‘çŽ‡ï¼ˆæˆ–ä»·å€¼ï¼‰æžä½Žçš„ï¼Œè¿™æ¡å°¾å·´å¯ä»¥å¾ˆé•¿ã€‚é•¿å°¾çš„å­˜åœ¨å¯¹å¤§æ•°æ®åˆ†æžå¸¦æ¥æŒ‘æˆ˜ï¼Œå› ä¸ºå®ƒçš„åŸºæ•°ï¼ˆcardinalityï¼‰ç‰¹åˆ«é«˜ï¼Œå¦‚ä½•ä»Žä¸­å¿«é€Ÿæ‰¾åˆ°é«˜ä»·å€¼çš„å•†å“æˆ–è€…ç”¨æˆ·ï¼Œæ˜¯ä¸€ä¸ªè¿«åˆ‡è€Œéš¾åº¦å¾ˆé«˜çš„ä»»åŠ¡ã€‚ çŽ°åœ¨æ¥çœ‹ä¸€ä¸ªå…¸åž‹çš„Topï¼NæŸ¥è¯¢ç¤ºä¾‹ã€‚è¯¥æŸ¥è¯¢æ˜¯é€‰æ‹©åœ¨ 2015å¹´10æœˆ1æ—¥ï¼Œåœ°å€åœ¨åŒ—äº¬ï¼Œé”€å”®å•†å“æŒ‰ä»·æ ¼ä¹‹å’ŒæŽ’åºï¼ˆå€’åºï¼‰ï¼Œæ‰¾å‰100ä¸ªã€‚ åœ¨Kylin v1.5ä¹‹å‰ï¼ŒSQLä¸­çš„group byåˆ—ï¼Œéœ€å£°æ˜Žæˆç»´åº¦ï¼Œæ‰€ä»¥è¿™ä¸ªCubeçš„ç»´åº¦ä¸­è¦æœ‰æ—¥æœŸï¼Œåœ°ç‚¹å’Œå•†å“åï¼Œåº¦é‡æ˜¯SUM(PRICE) ã€‚å›¾3å±•ç¤ºäº†ä¸€ä¸ªè¿™æ ·è®¾è®¡Cubeã€‚å› ä¸ºå•†å“çš„åŸºæ•°å¾ˆå¤§ï¼Œè®¡ç®—çš„cuboidçš„è¡Œæ•°ä¼šå¾ˆå¤šï¼›è€Œåº¦é‡å€¼SUM(PRICE)æ˜¯éžæŽ’åºçš„ï¼Œå› æ­¤éœ€è¦å°†è¿™äº›çºªå½•éƒ½ä»Žå­˜å‚¨å™¨è¯»åˆ°KylinæŸ¥è¯¢å¼•æ“Žä¸­ï¼ˆå†…å­˜ï¼‰ï¼Œ ç„¶åŽå†æŽ’åºæ‰¾å‡ºæœ€é«˜çš„çºªå½•ï¼›è¿™æ ·çš„è§£å†³åŠžæ³•æ€»å¼€é”€è¾ƒå¤§ã€‚ é’ˆå¯¹ä¸Šé¢çš„æƒ…å½¢ï¼ŒKylinå¼€å‘å›¢é˜Ÿå†³å®šå¦è¾Ÿè¹Šå¾„æ¥å¤„ç†è¿™ç§æŸ¥è¯¢ï¼Œç ”ç©¶äº†å¤šç§Topï¼Nçš„è§£å†³æ–¹æ³•ï¼›ç”±äºŽåœ¨å¤§æ•°æ®çš„èƒŒæ™¯ä¸‹ï¼Œç®—æ³•è¦æ±‚ä¸€å®šæ˜¯å¯å¹¶å‘æ‰§è¡Œçš„ï¼Œè®¡ç®—ç»“æžœæ˜¯éœ€è¦å¯å†æ¬¡åˆå¹¶çš„ï¼Œè€Œè®¡ç®—ç»“æžœçš„å°‘é‡è¯¯å·®æ˜¯å¯ä»¥æŽ¥å—çš„ï¼› æœ€ç»ˆKyliné€‰æ‹©äº†Spaceï¼Savingç®—æ³•[1]ï¼Œä»¥åŠå®ƒçš„ä¸€ä¸ªè¡ç”Ÿç‰ˆParallel Spaceï¼Saving[2]ï¼Œå¹¶åœ¨æ­¤ä¹‹ä¸Šåšäº†ç‰¹å®šçš„ä¼˜åŒ–ã€‚è¿™ç§ç®—æ³•çš„ä¼˜åŠ¿æ˜¯ä½¿ç”¨è¾ƒå°‘çš„ç©ºé—´ï¼ŒåŒæ—¶ä¿è¯è¾ƒé«˜çš„ç²¾ç¡®åº¦ã€‚ æœ‰äº†Topï¼Nä¹‹åŽï¼ŒCubeçš„è®¾è®¡ä¼šæ¯”ä»¥å‰ç®€å•å¾ˆå¤šï¼Œå› ä¸ºåƒåˆšæ‰çš„å•†å“åä¼šè¢«æŒªåˆ°Measureä¸­åŽ»ï¼Œåœ¨Measureé‡ŒæŒ‰Sumå€¼åšå€’åºï¼Œåªä¿ç•™æœ€å¤§çš„è‹¥å¹²å€¼ã€‚ å€¼å¾—ä¸€æçš„æ˜¯éœ€è¦ç”¨å¤šå°‘ç©ºé—´è¿ç®—Topï¼Nã€‚ç®€å•æ¥è¯´å­˜å‚¨ç©ºé—´è¶Šå¤šå‡†ç¡®çŽ‡è¶Šé«˜ã€‚æˆ‘ä»¬é€šè¿‡ä½¿ç”¨ç”Ÿæˆä¸€äº›æ ·æœ¬æ•°æ®ç„¶åŽç”¨Spaceï¼Savingè®¡ç®—ï¼Œå¹¶ä¸”è·ŸçœŸå®žç»“æžœåšæ¯”è¾ƒï¼Œå‘çŽ°50å€ç©ºé—´å¯¹äºŽæ™®é€šçš„æ•°æ®åˆ†å¸ƒæ˜¯å¤Ÿç”¨çš„ã€‚ä¹Ÿå³ï¼Œç”¨æˆ·éœ€è¦Top 100çš„ç»“æžœï¼ŒKylinå¯¹äºŽæ¯ç§ç»„åˆæ¡ä»¶å€¼ï¼Œä¿ç•™Top 5000çš„çºªå½•, å¹¶ä¾›ä»¥åŽå†æ¬¡åˆå¹¶ã€‚è¿™æ ·å³ä½¿å¤šæ¬¡åˆå¹¶ï¼Œ Top100ä¾ç„¶æ˜¯æ¯”è¾ƒæŽ¥è¿‘çœŸå®žç»“æžœ ã€‚ Topï¼Nçš„ä¼˜ç‚¹ï¼šå› ä¸ºå®ƒåªä¿ç•™Topçš„è®°å½•ï¼Œä¼šè®©Cubeç©ºé—´å¤§å¹…åº¦å‡å°‘ï¼Œè€ŒæŸ¥è¯¢æ€§èƒ½å¤§å¤§æå‡ã€‚åœ¨ä¸€ä¸ªå…¸åž‹çš„ä¾‹å­é‡Œï¼Œæ”¹ç”¨Top-NåŽï¼ŒCubeçš„å¤§å°å‡å°‘äº†90%ï¼Œè€ŒæŸ¥è¯¢æ—¶é—´åˆ™åªæœ‰ä»¥å‰çš„10%ä¸åˆ°ã€‚ ç¼ºç‚¹æ˜¯å®ƒå¯èƒ½æ˜¯è¿‘ä¼¼çš„ç»“æžœï¼ˆå½“50å€ç©ºé—´ä¹Ÿæ— æ³•å®¹çº³æ‰€æœ‰åŸºæ•°çš„æ—¶å€™ï¼‰ã€‚å¦‚æžœä¸šåŠ¡åœºæ™¯éœ€è¦ç»å¯¹ç²¾ç¡®çš„è¯ï¼Œå®ƒå¯èƒ½ä¸é€‚åˆã€‚ Topï¼Nè¯¯å·®çŽ‡ç”±å¾ˆå¤šå› ç´ å†³å®šçš„ï¼š æ•°æ®çš„åˆ†å¸ƒï¼šæ•°æ®åˆ†å¸ƒè¶Šé™¡ï¼Œè¯¯å·®è¶Šå°ã€‚ ç®—æ³•ä½¿ç”¨çš„ç©ºé—´ï¼šå¦‚æžœå¯¹ç²¾åº¦è¦æ±‚é«˜çš„è¯ï¼Œå¯ä»¥é€‰æ‹©ç”¨æ›´å¤šçš„ç©ºé—´æ¢å–æ›´ç²¾å‡†çš„å‡†ç¡®çŽ‡ ã€‚åœ¨å®žé™…ä½¿ç”¨ä¸­ï¼Œå¯ä»¥åšä¸€äº›æ¯”è¾ƒä»¥äº†è§£è¯¯å·®æƒ…å†µã€‚ [1] Ahmed Metwally, et al. â€œEfficient computation of frequent and top-k elements in data streamsâ€. Proceeding ICDTâ€™05 Proceedings of the 10th international conference on Database Theory, 2005. [2] Massimo Cafaro, et al. â€œA parallel space saving algorithm for frequent items and the Hurwitz zeta distributionâ€. Proceeding arXiv: 1401.0702v12 [cs.DS] 19 Setp 2015. Ref Apache Kylinçš„Top-Nè¿‘ä¼¼é¢„è®¡ç®—]]></content>
  </entry>
  <entry>
    <title><![CDATA[Why numbering should start at zero]]></title>
    <url>%2FWhy-numbering-should-start-at-zero%2F</url>
    <content type="text"><![CDATA[To denote the subsequence of natural numbers 2, 3, â€¦, 12 without the pernicious three dots, four conventions are open to us a) 2 â‰¤ i &lt; 13 b) 1 &lt; i â‰¤ 12 c) 2 â‰¤ i â‰¤ 12 d) 1 &lt; i &lt; 13 Are there reasons to prefer one convention to the other? Yes, there are. The observation that conventions a) and b) have the advantage that the difference between the bounds as mentioned equals the length of the subsequence is valid. So is the observation that, as a consequence, in either convention two subsequences are adjacent means that the upper bound of the one equals the lower bound of the other. Valid as these observations are, they donâ€™t enable us to choose between a) and b); so let us start afresh. There is a smallest natural number. Exclusion of the lower bound â€”as in b) and d)â€” forces for a subsequence starting at the smallest natural number the lower bound as mentioned into the realm of the unnatural numbers. That is ugly, so for the lower bound we prefer the â‰¤ as in a) and c). Consider now the subsequences starting at the smallest natural number: inclusion of the upper bound would then force the latter to be unnatural by the time the sequence has shrunk to the empty one. That is ugly, so for the upper bound we prefer &lt; as in a) and d). We conclude that convention a) is to be preferred. Remark The programming language Mesa, developed at Xerox PARC, has special notations for intervals of integers in all four conventions. Extensive experience with Mesa has shown that the use of the other three conventions has been a constant source of clumsiness and mistakes, and on account of that experience Mesa programmers are now strongly advised not to use the latter three available features. I mention this experimental evidence â€”for what it is worthâ€” because some people feel uncomfortable with conclusions that have not been confirmed in practice. (End of Remark.) * * * When dealing with a sequence of length N, the elements of which we wish to distinguish by subscript, the next vexing question is what subscript value to assign to its starting element. Adhering to convention a) yields, when starting with subscript 1, the subscript range 1 â‰¤ i &lt; N+1; starting with 0, however, gives the nicer range 0 â‰¤ i &lt; N. So let us let our ordinals start at zero: an elementâ€™s ordinal (subscript) equals the number of elements preceding it in the sequence. And the moral of the story is that we had better regard â€”after all those centuries!â€” zero as a most natural number. Remark Many programming languages have been designed without due attention to this detail. In FORTRAN subscripts always start at 1; in ALGOL 60 and in PASCAL, convention c) has been adopted; the more recent SASL has fallen back on the FORTRAN convention: a sequence in SASL is at the same time a function on the positive integers. Pity! (End of Remark.) * * * The above has been triggered by a recent incident, when, in an emotional outburst, one of my mathematical colleagues at the University â€”not a computing scientistâ€” accused a number of younger computing scientists of â€œpedantryâ€ because â€”as they do by habitâ€” they started numbering at zero. He took consciously adopting the most sensible convention as a provocation. (Also the â€œEnd of â€¦â€ convention is viewed of as provocative; but the convention is useful: I know of a student who almost failed at an examination by the tacit assumption that the questions ended at the bottom of the first page.) I think Antony Jay is right when he states: â€œIn corporate religions as in others, the heretic must be cast out not because of the probability that he is wrong but because of the possibility that he is right.â€ Ref EWD831]]></content>
  </entry>
  <entry>
    <title><![CDATA[Docker:pid1 zombie and signal problem]]></title>
    <url>%2Fdocker-pid1-zombie-and-signal-problem%2F</url>
    <content type="text"><![CDATA[åœ¨ç±»Unixç³»ç»Ÿä¸­ï¼Œpidæ˜¯1çš„è¿›ç¨‹æ˜¯ä¸€ä¸ªå¾ˆç‰¹æ®Šçš„è¿›ç¨‹ã€‚ç±»Unixæ“ä½œç³»ç»Ÿçš„è¿›ç¨‹ç®¡ç†é‡‡ç”¨æ ‘å½¢ç»“æž„ï¼Œç”¨æˆ·ç©ºé—´ä¸­çš„å…¶ä»–è¿›ç¨‹éƒ½ç›´æŽ¥æˆ–é—´æŽ¥æ˜¯pid 1è¿›ç¨‹çš„å­è¿›ç¨‹ã€‚åœ¨Mac OSXä¸­è¯¥è¿›ç¨‹æ˜¯launchdï¼ŒLinuxä¸­æœ‰å¤šç§é€‰æ‹©ï¼Œä¾‹å¦‚systemdï¼Œä¸€èˆ¬å°†å…¶ç§°ä½œinitè¿›ç¨‹ã€‚å¦‚æžœinitè¿›ç¨‹æ„å¤–é€€å‡ºï¼Œå†…æ ¸ä¼španicã€‚ä¸ºäº†é¿å…æ„å¤–æ“ä½œï¼Œpidä¸º1çš„è¿›ç¨‹ä¸ä¼šä½¿ç”¨ç³»ç»Ÿé»˜è®¤çš„ä¿¡å·å¤„ç†å‡½æ•°ï¼Œè¦å¤„ç†ä¿¡å·ï¼Œå¿…é¡»æ˜¾å¼æŒ‡å®šä¿¡å·å¤„ç†å‡½æ•°ã€‚ initè¿›ç¨‹è¿˜æ‰¿æ‹…ç€ä¸€äº›å…¶ä»–èŒè´£ã€‚ç”±äºŽæ‰€æœ‰ç”¨æˆ·ç©ºé—´çš„è¿›ç¨‹éƒ½æ˜¯å…¶å­è¿›ç¨‹ï¼Œæ‰€ä»¥ï¼Œå½“è¿›ç¨‹ç»“æŸæ—¶ï¼Œå…¶éœ€è¦å¤„ç†è¿›ç¨‹çš„èµ„æºå›žæ”¶ã€‚å¦å¤–ï¼ŒæŸäº›æƒ…å†µä¸‹ï¼Œçˆ¶è¿›ç¨‹å¯èƒ½å…ˆäºŽå­è¿›ç¨‹é€€å‡ºï¼Œæ­¤æ—¶å­è¿›ç¨‹æ²¡æœ‰äº†çˆ¶è¿›ç¨‹å˜æˆæ‰€è°“çš„â€˜å­¤å„¿â€™è¿›ç¨‹ï¼Œinitè´Ÿè´£å°†æ­¤ç±»è¿›ç¨‹æ”¶å…»ä¸ºè‡ªå·±çš„å­è¿›ç¨‹ï¼Œå¹¶è´Ÿè´£åŽç»­çš„èµ„æºå›žæ”¶ã€‚ Linux pid namespaceæŠ€æœ¯å¯ä»¥å®žçŽ°pidèµ„æºçš„éš”ç¦»ï¼Œå¹¿æ³›åº”ç”¨äºŽå„ç§å®¹å™¨æŠ€æœ¯ä¸­ï¼Œä¾‹å¦‚dockerã€‚ä½†æ˜¯åœ¨dockerçš„æ—©æœŸç‰ˆæœ¬ä¸­å¯¹initè¿›ç¨‹å¤„ç†ä¸å½“å¼•èµ·äº†ä¸€äº›é—®é¢˜ï¼Œå°¤å…¶æ˜¯å½“å¤šè¿›ç¨‹ç¨‹åºè¿è¡Œåœ¨å®¹å™¨ä¸­æ—¶ã€‚ å®¹å™¨å¯åŠ¨æ—¶ï¼Œè¿è¡Œçš„ç¨‹åºé»˜è®¤ä¼šè¢«åˆ†é…ä¸ºpid 1ï¼Œä½†æ˜¯ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éƒ½æ²¡æœ‰å‡è®¾æˆ‘ä»¬çš„ç¨‹åºä¼šä»¥pid 1æ¥è¿è¡Œã€‚ è¿™é‡Œå¯èƒ½é¢ä¸´åƒµå°¸è¿›ç¨‹çš„é—®é¢˜ã€‚çœ‹ä¸‹é¢çš„ä¾‹å­ï¼Œè¯¥ç¨‹åºforkäº†ä¸¤æ¬¡ï¼Œä¸€å…±åˆ›å»ºäº†3ä¸ªè¿›ç¨‹ï¼šçˆ¶äº²ã€å„¿å­å’Œå­™å­è¿›ç¨‹ã€‚å„¿å­è¿›ç¨‹å…ˆç»“æŸï¼Œç”±äºŽçˆ¶è¿›ç¨‹æ²¡æœ‰ä»»ä½•å¤„ç†ï¼Œå„¿å­è¿›ç¨‹å˜æˆåƒµå°¸è¿›ç¨‹ï¼Œå­™å­è¿›ç¨‹å˜æˆå­¤å„¿è¿›ç¨‹ï¼Œç­‰å¾…è¢«æ”¶å…»ï¼› 1234567891011121314151617181920212223242526272829#include &lt;unistd.h&gt;#include &lt;stdio.h&gt;void main()&#123; pid_t pid = fork(); if (pid == 0) &#123; printf("[C] child process.\n"); //avoid buffer get into child process fflush(stdout); pid_t pid2 = fork(); if (pid2 == 0) &#123; printf("[C] 2nd fork, child process.\n"); sleep(15); &#125; else &#123; printf("[P] 2nd fork, child process pid: %d.\n", pid2); sleep(8); &#125; &#125; else &#123; printf("[P] child process pid: %d.\n", pid); sleep(20); &#125;&#125; ä»¥ä¸Šä»£ç è¿›è¡Œç¼–è¯‘åŽï¼Œç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶ä½äºŽ/tmp/test/a.outã€‚å°†è¯¥ç›®å½•æ˜ å°„åˆ°å®¹å™¨çš„/root/ç›®å½•ã€‚ docker run -itd â€“name foo â€“rm -v /tmp/test/:/root/ ubuntu /root/a.out ä»¥ä¸Šå‘½ä»¤æ‰§è¡ŒåŽï¼Œåœ¨å¦ä¸€ä¸ªçª—å£æ‰§è¡Œ docker exec -it foo /bin/bash è¿™æ ·ä¼šæ‰“å¼€ä¸€ä¸ªå®¹å™¨çš„bashç•Œé¢ï¼Œé€šè¿‡å®ƒå¯ä»¥è§‚å¯Ÿå®¹å™¨å†…ç¨‹åºçš„æ‰§è¡Œæƒ…å†µã€‚ä¸€å¼€å§‹ä¸‰ä¸ªè¿›ç¨‹éƒ½åœ¨æ‰§è¡Œã€‚ PPID PID PGID SID TTY TPGID STAT UID TIME COMMAND 0 8 8 8 pts/1 15 Ss 0 0:00 /bin/bash 8 15 15 8 pts/1 15 R+ 0 0:00 \_ ps -jxf 0 1 1 1 pts/0 1 Ss+ 0 0:00 /root/a.out 1 6 1 1 pts/0 1 S+ 0 0:00 /root/a.out 6 7 1 1 pts/0 1 S+ 0 0:00 \_ /root/a.out pid 6å„¿å­è¿›ç¨‹ç»“æŸï¼Œåƒµå°¸çŠ¶æ€ï¼Œpid 7å­™å­è¿›ç¨‹è¢«initè¿›ç¨‹æ”¶å…»ï¼Œå³pid 1è¿›ç¨‹ã€‚ PPID PID PGID SID TTY TPGID STAT UID TIME COMMAND 0 8 8 8 pts/1 22 Ss 0 0:00 /bin/bash 8 22 22 8 pts/1 22 R+ 0 0:00 \_ ps -jxf 0 1 1 1 pts/0 1 Ss+ 0 0:00 /root/a.out 1 6 1 1 pts/0 1 Z+ 0 0:00 [a.out] 1 7 1 1 pts/0 1 S+ 0 0:00 /root/a.out pid 7å­™å­è¿›ç¨‹ç»“æŸï¼Œç”±äºŽpid 1è¿›ç¨‹æ²¡æœ‰å¯¹å…¶å›žæ”¶èµ„æºï¼Œæ•…ä¹Ÿè¿›å…¥åƒµå°¸çŠ¶æ€ã€‚ PPID PID PGID SID TTY TPGID STAT UID TIME COMMAND 0 8 8 8 pts/1 23 Ss 0 0:00 /bin/bash 8 23 23 8 pts/1 23 R+ 0 0:00 \_ ps -jxf 0 1 1 1 pts/0 1 Ss+ 0 0:00 /root/a.out 1 6 1 1 pts/0 1 Z+ 0 0:00 [a.out] 1 7 1 1 pts/0 1 Z+ 0 0:00 [a.out] æœ€åŽå½“çˆ¶è¿›ç¨‹ç»“æŸåŽï¼Œæ•´ä¸ªå®¹å™¨ç»“æŸï¼Œæ‰€æœ‰èµ„æºè¢«æ¸…ç†ã€‚ è§£å†³ä»¥ä¸Šé—®é¢˜ï¼Œéœ€è¦å®¹å™¨å†…éƒ¨è¿è¡Œä¸€ä¸ªæœ‰æ•ˆçš„initè¿›ç¨‹ï¼Œä½¿ç”¨systemdè¿™ç§é«˜çº§ç¨‹åºä¼šä½¿å®¹å™¨è‡ƒè‚¿ï¼Œå¯ä»¥ä½¿ç”¨ä¸€äº›å¾ˆè½»ä¾¿çš„å®žçŽ°ï¼Œç”šè‡³è‡ªå·±å†™ä¸€ä¸ªæ»¡è¶³è‡ªå·±éœ€æ±‚çš„ç¨‹åºã€‚ çŽ°æœ‰çš„è§£å†³æ–¹æ¡ˆï¼š ä½¿ç”¨baseimage-docker ä½¿ç”¨dockerå†…ç½®çš„initå·¥å…·tiniï¼Œåœ¨docker runå‘½ä»¤åŠ ä¸Šå‚æ•°â€“initã€‚ Ref Docker and the pid 1zombie reaping problem Docker - init, zombies - why does it matter? The Curious Case of Pid Namespaces DOCKER DEMONS: PID-1, ORPHANS, ZOMBIES, AND SIGNALS Cannot kill or detach a docker container using Ctrl-C or Ctrl-\ My process became PID 1 and now signals behave strangely]]></content>
  </entry>
  <entry>
    <title><![CDATA[how to write resilient mongodb applications]]></title>
    <url>%2Fhow-to-write-resilient-mongodb-applications%2F</url>
    <content type="text"><![CDATA[å‰è¨€ï¼šæœ¬æ–‡ç¿»è¯‘è‡ªMongoDBå›¢é˜Ÿå·¥ç¨‹å¸ˆA. Jesse Jiryu Davisçš„åšå®¢æ–‡ç« ã€‚æ–‡ç« æè¿°äº†åœ¨é‡åˆ°é”™è¯¯æ—¶å¦‚ä½•å®‰å…¨çš„è¿›è¡Œé‡è¯•ã€‚è™½ç„¶è¿™é¡¹æŠ€æœ¯å·²è¢«MongoDB 3.6çš„æ–°å†…ç½®åŠŸèƒ½Retryable Writeså–ä»£ã€‚ å¯é‡å†™çš„å†™æ“ä½œæ¯”è¿™é‡Œæè¿°çš„æŠ€æœ¯ç®€å•å¾—å¤šã€‚ä½†æ˜¯ä½œè€…è§£å†³é—®é¢˜çš„æ–¹å¼è¿˜æ˜¯èƒ½ç»™æˆ‘ä»¬ä¸€äº›å¯å‘ã€‚ æœ‰ä¸€æ¬¡ï¼Œåœ¨2012å¹´åˆçš„ä¸€ä¸ªå¯’å†¬åˆåŽï¼Œæˆ‘é‡åˆ°äº†ä¸€ä½éžå¸¸ç”Ÿæ°”çš„MongoDBå®¢æˆ·ã€‚ ä»–æ¥åˆ°æˆ‘ä»¬çš„â€œMongoDB Office Hoursâ€åŠžå…¬å®¤ï¼Œä»–æœ‰ä¸€ä¸ªé—®é¢˜ï¼šâ€œæˆ‘æ€Žæ ·æ‰èƒ½ä½¿æˆ‘çš„åº”ç”¨ç¨‹åºåœ¨ç½‘ç»œé”™è¯¯ï¼Œä¸­æ–­å’Œå…¶ä»–å¼‚å¸¸æƒ…å†µä¸‹å…·æœ‰å¼¹æ€§ï¼Ÿæˆ‘å¯ä»¥æ¯æ¬¡é‡è¯•æ“ä½œç›´åˆ°æˆåŠŸï¼Ÿâ€œä»–è¦æ±‚çŸ¥é“ä¸ºä»€ä¹ˆæˆ‘ä»¬æ²¡æœ‰å‘å¸ƒä¸€ä¸ªé€‚ç”¨äºŽæ‰€æœ‰åº”ç”¨ç¨‹åºçš„ç®€å•æ˜Žæ™ºçš„ç­–ç•¥ã€‚ è¿™ä¸ªäººï¼Œæˆ‘ä¼šå«ä»–Ianï¼Œå¾ˆä¸é«˜å…´ï¼Œæˆ‘ä¹Ÿå¸®ä¸äº†ä»–ã€‚æˆ‘çš„å†…ç–šå·²ç»è®©æˆ‘å¿˜è®°äº†é‚£å¤©çš„ç»†èŠ‚ã€‚æˆ‘ä»¬ååœ¨ä¸€é—´æ²¡æœ‰çª—æˆ·çš„æˆ¿é—´é‡Œï¼Œè¿™æ˜¯æˆ‘ä»¬å”¯ä¸€å¯ä»¥åœ¨æˆ‘ä»¬çš„å°åŠžå…¬å®¤èŠå¤©çš„è‡ªç”±ç©ºé—´ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªè®¨åŽŒçš„è§å…‰ç¯ã€‚æˆ‘ä»¬å¹¶æŽ’ååœ¨æ¡Œå­çš„è¾¹ç¼˜ï¼Œå› ä¸ºæˆ¿é—´æ²¡æœ‰æ¤…å­ã€‚åœ¨Iançš„çœ¼ç›ä¸‹æœ‰æ·±æ·±çš„é»‘çœ¼åœˆï¼Œå°±åƒä»–å·²ç»ä¸ºè¿™ä¸ªé—®é¢˜æ‹…å¿ƒäº†ä¸€æ•´æ™šã€‚ â€œæˆ‘å¦‚ä½•ç¼–å†™å¼¹æ€§ä»£ç ï¼Ÿâ€ æˆ‘å”¯ä¸€å¯ä»¥å‘Šè¯‰Iançš„æ˜¯ï¼Œâ€œæˆ‘ä»¬æ— æ³•å‘å¸ƒä¸€ä¸ªç­–ç•¥æ¥å¤„ç†ç½‘ç»œé”™è¯¯å’Œä¸­æ–­ï¼Œå¹¶ä¸ºæ‚¨æŒ‡å‡ºé”™è¯¯ï¼Œå› ä¸ºæˆ‘ä»¬ä¸çŸ¥é“æ‚¨åº”ç”¨ç¨‹åºçš„ç»†èŠ‚ã€‚æ‚¨å¯ä»¥é€‰æ‹©å¾ˆå¤šä¸åŒçš„æ“ä½œæ–¹å¼ï¼Œåœ¨å»¶è¿Ÿå’Œå¯é æ€§ä¹‹é—´åšå‡ºæŠ˜ä¸­ï¼Œä»¥åŠåœ¨ä¸€ä¸ªæ“ä½œè‚¯èƒ½è¢«æ‰§è¡Œä¸¤æ¬¡çš„é£Žé™©ä¸Žå®Œå…¨ä¸åšè¿™ä¸¤è€…ä¹‹é—´è¿›è¡Œæƒè¡¡ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬æ²¡æœ‰å°è¯•å†™å‡ºä¸€ç§â€œä¸€åˆ€åˆ‡â€çš„ç­–ç•¥ã€‚å°±ç®—å¯ä»¥ï¼Œä½†æ˜¯ä¸åŒè¯­è¨€ä¸‹é©±åŠ¨çš„è¡Œä¸ºä¸åŒï¼Œæˆ‘ä»¬å¿…é¡»ä¸ºæ¯ç§è¯­è¨€å‘å¸ƒæŒ‡å—ã€‚â€œ æˆ‘å¯¹æˆ‘çš„å›žç­”å¹¶ä¸æ»¡æ„ï¼ŒIanä¹Ÿä¸€æ ·ã€‚ åœ¨æ­¤åŽçš„å‡ å¹´ä¸­ï¼Œæˆ‘åŠªåŠ›æƒ³å‡ºäº†ä¸€ä¸ªæ›´å¥½çš„ç­”æ¡ˆã€‚é¦–å…ˆæˆ‘å†™äº†æœåŠ¡å‘çŽ°å’Œç›‘æµ‹è§„èŒƒï¼Œæˆ‘ä»¬æ‰€æœ‰çš„é©±åŠ¨ç¨‹åºçŽ°åœ¨å·²ç»å®žçŽ°äº†ã€‚è¯¥è§„èŒƒæžå¤§åœ°æé«˜äº†é©±åŠ¨ç¨‹åºåœ¨é¢å¯¹ç½‘ç»œé”™è¯¯å’ŒæœåŠ¡å™¨æ•…éšœæ—¶çš„é²æ£’æ€§ã€‚åƒIanè¿™æ ·çš„æŠ•è¯‰çŽ°åœ¨æ¯”è¾ƒå°‘è§ï¼Œå› ä¸ºé©±åŠ¨å¾ˆå°‘ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚æ­¤å¤–ï¼Œæ‰€æœ‰é©±åŠ¨ç¨‹åºçŽ°åœ¨éƒ½è¡¨çŽ°ç›¸åŒï¼Œæˆ‘ä»¬ä½¿ç”¨æ ‡å‡†åŒ–çš„é€šç”¨æµ‹è¯•å¥—ä»¶éªŒè¯å…¶è¡Œä¸ºã€‚ å…¶æ¬¡ï¼Œæˆ‘å¼€å‘äº†ä¸€ç§åä¸ºâ€˜Black Pipeâ€™çš„æµ‹è¯•æŠ€æœ¯ï¼Œå› æ­¤Ianå¯ä»¥æµ‹è¯•ä»–çš„ä»£ç åœ¨ä¸ŽMongoDBäº¤äº’æ—¶å¦‚ä½•å“åº”ç½‘ç»œæ•…éšœï¼Œå‘½ä»¤é”™è¯¯æˆ–ä»»ä½•å…¶ä»–äº‹ä»¶ã€‚â€˜Black Pipeâ€™ä½¿ç”¨æ–¹ä¾¿ä¸”å‡†ç¡®;å®ƒä½¿å¾—é”™è¯¯æƒ…å†µå¯é‡çŽ°ä¸”æ˜“äºŽæµ‹è¯•ã€‚ çŽ°åœ¨å¯ä»¥å›žç­”Ianäº†ã€‚å¦‚æžœä»–ä»Šå¤©æ¥åˆ°æˆ‘ä»¬åœ¨æ—¶ä»£å¹¿åœºçš„å¤§åŠžå…¬å®¤ï¼Œä½ ä¼šå¦‚ä½•å›žç­”ä»–ï¼Ÿç¼–å†™å¼¹æ€§MongoDBåº”ç”¨ç¨‹åºçš„ç­–ç•¥æ˜¯ä»€ä¹ˆï¼Ÿ æˆ‘ä»¬ä¼šå‘Šè¯‰Ianï¼Œå¦‚ä½•åšåˆ°è¿™ä¸€ç‚¹ï¼š 123updateOne(&#123;'_id': '2016-06-28'&#125;, &#123;'$inc': &#123;'counter': 1&#125;&#125;, upsert=True) è¯¥æ“ä½œé€šè¿‡åœ¨_idä¸ºä»Šå¤©æ—¥æœŸçš„æ–‡æ¡£ä¸­é€’å¢žåä¸ºâ€œcounterâ€çš„å­—æ®µæ¥è®¡æ•°äº‹ä»¶å‘ç”Ÿçš„æ¬¡æ•°ã€‚å¦‚æžœè¿™æ˜¯ä»Šå¤©çš„ç¬¬ä¸€ä¸ªäº‹ä»¶ï¼Œå‚æ•°â€œupsert = Trueâ€å‘Šè¯‰MongoDBåˆ›å»ºæ–‡æ¡£ã€‚ ä»€ä¹ˆä¼šå‡ºé”™çž¬æ€é”™è¯¯å½“Ianå°†ä»–çš„updateOneæ¶ˆæ¯å‘é€åˆ°MongoDBæ—¶ï¼Œé©±åŠ¨ç¨‹åºå¯èƒ½ä¼šçœ‹åˆ°æ¥è‡ªç½‘ç»œå±‚çš„æš‚æ—¶é”™è¯¯ï¼Œä¾‹å¦‚TCPé‡ç½®æˆ–è¶…æ—¶ã€‚ çž¬æ€ç½‘ç»œé”™è¯¯ï¼Œæ•…éšœè½¬ç§»æˆ–é™çº§é©±åŠ¨ä¸çŸ¥é“æœåŠ¡å™¨æ˜¯å¦æ”¶åˆ°æ¶ˆæ¯ï¼Œæ‰€ä»¥Ianä¸çŸ¥é“ä»–çš„è®¡æ•°å™¨æ˜¯å¦å¢žåŠ ã€‚ è¿˜æœ‰å…¶ä»–çž¬æ€é”™è¯¯çœ‹èµ·æ¥ä¸Žç½‘ç»œæš‚æ—¶æ€§é—®é¢˜ç›¸åŒã€‚å¦‚æžœprimaryèŠ‚ç‚¹å‡ºçŽ°æ•…éšœï¼Œä¸‹æ¬¡å°è¯•å‘å…¶å‘é€æ¶ˆæ¯æ—¶ï¼Œé©±åŠ¨ç¨‹åºä¼šæ”¶åˆ°ç½‘ç»œé”™è¯¯ã€‚è¿™ä¸ªé”™è¯¯å¾ˆç®€çŸ­ï¼Œå› ä¸ºå‰¯æœ¬é›†ä¼šåœ¨å‡ ç§’é’Ÿå†…é€‰å‡ºä¸€ä¸ªæ–°çš„primaryèŠ‚ç‚¹ã€‚åŒæ ·ï¼Œå¦‚æžœprimaryæœåŠ¡å™¨é€€å‡ºï¼ˆå®ƒä»ç„¶æ­£å¸¸å·¥ä½œï¼Œä½†å·²ç»è¾žåŽ»å…¶primaryè§’è‰²ï¼‰ï¼Œå®ƒå°†å…³é—­æ‰€æœ‰è¿žæŽ¥ã€‚ä¸‹æ¬¡é©±åŠ¨ç¨‹åºå‘æœåŠ¡å™¨å‘é€æ¶ˆæ¯æ—¶ï¼Œå®ƒè®¤ä¸ºå®ƒæ˜¯primaryèŠ‚ç‚¹ï¼Œå®ƒä¼šä»ŽæœåŠ¡å™¨æ”¶åˆ°ç½‘ç»œé”™è¯¯æˆ–â€œnot masterâ€å›žå¤ã€‚ åœ¨æ‰€æœ‰æƒ…å†µä¸‹ï¼Œé©±åŠ¨ç¨‹åºéƒ½ä¼šå‘Iançš„åº”ç”¨ç¨‹åºæŠ›å‡ºè¿žæŽ¥é”™è¯¯ã€‚ æŒç»­çš„é”™è¯¯ä¹Ÿå¯èƒ½å­˜åœ¨æŒç»­çš„ç½‘ç»œä¸­æ–­ã€‚å½“é©±åŠ¨ç¨‹åºé¦–æ¬¡æ£€æµ‹åˆ°æ­¤é—®é¢˜æ—¶ï¼Œå®ƒçœ‹èµ·æ¥åƒä¸€ä¸ªæš‚æ—¶æ€§é—®é¢˜ï¼šé©±åŠ¨ç¨‹åºå‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œä½†æ˜¯æ— æ³•è¯»å–å“åº”ã€‚ Persistent Network Outage æŒç»­çš„ç½‘ç»œä¸­æ–­Ianå†ä¸€æ¬¡æ— æ³•åˆ†è¾¨æœåŠ¡å™¨æ˜¯å¦æŽ¥æ”¶åˆ°æ¶ˆæ¯å¹¶é€’å¢žè®¡æ•°å™¨ã€‚ ç½‘è·¯ä¸­æ–­ä¸Žç½‘ç»œæš‚æ—¶æ€§é—®é¢˜çš„åŒºåˆ«æ˜¯Ianè¯•å›¾å†æ¬¡æ“ä½œåªä¼šå¾—åˆ°å¦ä¸€ä¸ªç½‘ç»œé”™è¯¯ã€‚ä½†æ˜¯åªæœ‰ä»–å°è¯•åŽæ‰çŸ¥é“ã€‚ å‘½ä»¤é”™è¯¯å½“é©±åŠ¨ç¨‹åºå‘é€æ¶ˆæ¯æ—¶ï¼ŒMongoDBå¯èƒ½ä¼šè¿”å›žä¸€ä¸ªç‰¹å®šçš„é”™è¯¯ï¼Œè¡¨ç¤ºå·²æ”¶åˆ°å‘½ä»¤ä½†æ— æ³•æ‰§è¡Œã€‚ä¹Ÿè®¸å‘½ä»¤æ ¼å¼ä¸æ­£ç¡®ï¼ŒæœåŠ¡å™¨ç£ç›˜ç©ºé—´ä¸è¶³ï¼Œæˆ–Iançš„åº”ç”¨ç¨‹åºæœªè¢«æŽˆæƒã€‚ æ‰€ä»¥ï¼Œæœ‰ä¸‰ä¸ªä¸èƒ½å®Œå…¨å¯åŒºåˆ†çš„é”™è¯¯ï¼Œéœ€è¦Iançš„ä»£ç æœ‰ä¸åŒå›žåº”ã€‚ä½ ä¼šç»™Ianä»€ä¹ˆæ ·çš„ç­–ç•¥æ¥ä½¿ä»–çš„åº”ç”¨å…·æœ‰å¼¹æ€§ï¼Ÿ æ˜¯å› ä¸ºæˆ‘ä»¬æ²¡æœ‰äº‹åŠ¡å—ï¼Ÿæ‚¨å¯èƒ½æƒ³çŸ¥é“è¿™æ˜¯å¦æ˜¯åªæœ‰MongoDBæ‰æœ‰çš„é—®é¢˜ï¼Œå› ä¸ºå®ƒæ²¡æœ‰äº‹åŠ¡ã€‚å‡è®¾Ianä½¿ç”¨äº†ä¼ ç»Ÿçš„SQLæœåŠ¡å™¨ã€‚ä»–æ‰“å¼€ä¸€ä¸ªäº‹åŠ¡ï¼Œæ›´æ–°ä¸€è¡Œï¼Œå¹¶å‘é€COMMITæ¶ˆæ¯ã€‚ç„¶åŽæœ‰ä¸€ä¸ªç½‘ç»œä¸´æ—¶æ€§é”™è¯¯ã€‚ä»–æ— æ³•ä»ŽæœåŠ¡å™¨è¯»å–ç¡®è®¤æ¶ˆæ¯ã€‚ä»–çŸ¥é“äº¤æ˜“æ˜¯å¦å·²ç»å®žæ–½å—ï¼Ÿ ä¿è¯æ“ä½œåªæ‰§è¡Œä¸€æ¬¡ï¼Œä½¿ç”¨SQLæœåŠ¡å™¨ä¸Žä½¿ç”¨éžäº‹åŠ¡æ€§æœåŠ¡å™¨ï¼ˆå¦‚MongoDBï¼‰é¢ä¸´çš„é—®é¢˜ç›¸åŒã€‚ MongoDBé©±åŠ¨ç¨‹åºå¦‚ä½•å¤„ç†é”™è¯¯ï¼Ÿä¸ºäº†åˆ¶å®šæ‚¨çš„ç­–ç•¥ï¼Œæ‚¨éœ€è¦çŸ¥é“MongoDBé©±åŠ¨ç¨‹åºè‡ªå·±å¦‚ä½•å“åº”ä¸åŒç±»åž‹çš„é”™è¯¯ã€‚ æœåŠ¡å™¨å‘çŽ°å’Œç›‘æµ‹è§„èŒƒè¦æ±‚MongoDBé©±åŠ¨ç¨‹åºè·Ÿè¸ªæ¯ä¸ªè¿žæŽ¥åˆ°çš„æœåŠ¡å™¨çš„çŠ¶æ€ã€‚ä¾‹å¦‚ï¼Œå®ƒå¯èƒ½æ˜¯ä¸€ä¸ª3èŠ‚ç‚¹å‰¯æœ¬é›†ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š Server 1: Primary Server 2: Secondary Server 3: Secondary è¿™ä¸ªæ•°æ®ç»“æž„è¢«ç§°ä¸ºâ€œæ‹“æ‰‘æè¿°â€ã€‚å¦‚æžœåœ¨ä¸ŽæœåŠ¡å™¨äº¤è°ˆæ—¶å‡ºçŽ°ç½‘ç»œé”™è¯¯ï¼Œé©±åŠ¨ç¨‹åºä¼šå°†è¯¥æœåŠ¡å™¨çš„ç±»åž‹è®¾ç½®ä¸ºâ€œæœªçŸ¥â€ï¼Œç„¶åŽå¼•å‘å¼‚å¸¸ã€‚çŽ°åœ¨æ‹“æ‰‘æè¿°æ˜¯ï¼š Server 1: Unknown Server 2: Secondary Server 3: Secondary Ianå°è¯•çš„æ“ä½œä¸ä¼šè‡ªåŠ¨é‡è¯•; ç„¶è€Œï¼Œä¸‹ä¸€ä¸ªæ“ä½œä¼šè¢«é˜»å¡žï¼Œå› ä¸ºé©±åŠ¨ç¨‹åºæ­£åœ¨é‡æ–°å‘çŽ°ä¸»é©±åŠ¨å™¨ã€‚å®ƒæ¯ç§’é‡æ–°æ£€æŸ¥æ¯å°æœåŠ¡å™¨ä¸¤æ¬¡ï¼Œæœ€å¤šæŒç»­30ç§’ï¼Œç›´åˆ°é‡æ–°è¿žæŽ¥åˆ°ä¸»æœåŠ¡å™¨æˆ–æ£€æµ‹åˆ°æ–°ä¸»æœåŠ¡å™¨è¢«é€‰ä¸­ã€‚çŽ°åœ¨MongoDBçš„é€‰ä¸¾åªéœ€è¦ä¸€ä¸¤ç§’é’Ÿï¼Œç„¶åŽé©±åŠ¨ç¨‹åºåœ¨æ­¤ä¹‹åŽå¤§çº¦åŠç§’ä¼šæ”¶åˆ°é€‰ä¸¾ç»“æžœã€‚ å¦ä¸€æ–¹é¢ï¼Œå¦‚æžœç½‘ç»œæŒç»­ä¸­æ–­ï¼Œåˆ™åœ¨30ç§’ä¹‹åŽï¼Œé©±åŠ¨ç¨‹åºä¼šæŠ›å‡ºâ€œserver selection timeoutâ€ã€‚ åœ¨å‘½ä»¤é”™è¯¯çš„æƒ…å†µä¸‹ï¼Œé©±åŠ¨ç¨‹åºå¯¹æœåŠ¡å™¨çš„çœ‹æ³•æ²¡æœ‰æ”¹å˜ï¼šå¦‚æžœæœåŠ¡å™¨æ˜¯primaryæˆ–secondaryï¼Œå®ƒä»ç„¶æ˜¯ã€‚å› æ­¤ï¼Œé©±åŠ¨ç¨‹åºä¸ä¼šåœ¨æ‹“æ‰‘æè¿°ä¸­æ›´æ”¹æœåŠ¡å™¨çš„çŠ¶æ€ï¼Œåªä¼šå¼•å‘å¼‚å¸¸ã€‚ ï¼ˆè¦äº†è§£æœ‰å…³æœåŠ¡å™¨å‘çŽ°å’Œç›‘æµ‹è§„èŒƒçš„æ›´å¤šä¿¡æ¯ï¼Œè¯·é˜…è¯»æˆ‘çš„æ–‡ç« PyMongoï¼ŒPerlå’ŒCä¸­çš„æœåŠ¡å™¨å‘çŽ°å’Œç›‘æŽ§ï¼Œæˆ–è§‚çœ‹MongoDB World 2015ä¸Šçš„æ¼”è®²ï¼ŒMongoDBé©±åŠ¨ç¨‹åºå’Œé«˜å¯ç”¨æ€§ï¼šæ·±åº¦åˆ†æžã€‚åœ¨é‚£é‡Œæˆ‘è¯¦ç»†è®¨è®ºäº†è§„èŒƒä¸­æè¿°çš„æ•°æ®ç»“æž„ä»¥åŠè§„èŒƒå¦‚ä½•å‘Šè¯‰é©±åŠ¨ç¨‹åºå¯¹é”™è¯¯åšå‡ºååº”ï¼Œè¿™æ˜¯æœ¬æ–‡å…³äºŽå¼¹æ€§åº”ç”¨ç¨‹åºçš„ä¸€ä¸ªå¾ˆå¥½çš„èƒŒæ™¯ã€‚ï¼‰ é”™è¯¯çš„é‡è¯•ç­–ç•¥æˆ‘è§è¿‡ä¸€äº›ã€‚ ä¸è¦é‡è¯•é»˜è®¤æ˜¯æ ¹æœ¬ä¸é‡è¯•ã€‚è¿™ç§ç­–ç•¥åœ¨é‡åˆ°å‰é¢æè¿°çš„ä¸‰ç§é”™è¯¯æƒ…å†µæ—¶å¯èƒ½ä¼šå¤±è´¥ã€‚ çž¬æ€ç½‘ç»œé”™è¯¯ æŒç»­ä¸­æ–­ å‘½ä»¤é”™è¯¯ å¯èƒ½è®¡æ•°ä¸¢å¤± æ­£ç¡® æ­£ç¡® åœ¨å‘ç”Ÿçž¬æ—¶ç½‘ç»œé”™è¯¯çš„æƒ…å†µä¸‹ï¼ŒIanå°†æ¶ˆæ¯å‘é€åˆ°æœåŠ¡å™¨ï¼Œå¹¶ä¸”ä¸çŸ¥é“æœåŠ¡å™¨æ˜¯å¦æ”¶åˆ°å®ƒã€‚å¦‚æžœæ²¡æœ‰ï¼Œè¯¥äº‹ä»¶ä»Žä¸è®¡ç®—åœ¨å†…ã€‚ä»–çš„ä»£ç å¯èƒ½ä¼šè®°å½•é”™è¯¯ï¼Œç„¶åŽç»§ç»­å‰è¿›ã€‚ æœ‰è¶£çš„æ˜¯ï¼Œé¢å¯¹é•¿æœŸçš„ç½‘ç»œä¸­æ–­æˆ–å‘½ä»¤é”™è¯¯ï¼Œâ€œä¸è¦é‡è¯•â€æ˜¯æ­£ç¡®çš„ç­–ç•¥ï¼Œå› ä¸ºè¿™äº›æ˜¯éžçž¬æ€é”™è¯¯ï¼Œæ— æ³•é€šè¿‡é‡è¯•æ”¹å–„ã€‚ æ€»æ˜¯é‡è¯•ä¸€äº›ç¨‹åºå‘˜ç¼–å†™ä»£ç é‡è¯•ä»»ä½•å¤±è´¥çš„æ“ä½œäº”æ¬¡ï¼Œæˆ–è€…ï¼Œå¦‚æžœä»–ä»¬çœŸçš„å…³å¿ƒå¼¹æ€§ï¼Œåæ¬¡ã€‚æˆ‘åœ¨å¾ˆå¤šç”Ÿäº§åº”ç”¨ç¨‹åºä¸­éƒ½çœ‹åˆ°äº†è¿™ä¸€ç‚¹ã€‚ 123456789i = 0while True: try: do_operation() break except network error: i += 1 if i == MAX_RETRY_COUNT: throw åŽ»å¹´ï¼Œæˆ‘ä¸Žä¸€ä½åä¸ºSamçš„Rackspaceå·¥ç¨‹å¸ˆè¿›è¡Œäº†äº¤è°ˆã€‚ä»–æŽ¥æ‰‹äº†ä¸€ä¸ªåº”ç”¨äº†è¿™ä¸ªä¸å¥½çš„ç­–ç•¥çš„Pythonä»£ç åº“ï¼šå®ƒåªè¦æŽ¥æ”¶åˆ°ä»»ä½•å¼‚å¸¸å°±ä¼šä¸€éåˆä¸€éåœ°é‡è¯•ã€‚ Samè®¤ä¸ºè¿™æ˜¯æ„šè ¢çš„ã€‚ä»–æ³¨æ„åˆ°æˆ‘æœ€è¿‘æ ¹æ®æœåŠ¡å™¨å‘çŽ°å’Œç›‘æµ‹è§„èŒƒé‡æ–°ç¼–å†™äº†PyMongoçš„å®¢æˆ·ç«¯ä»£ç ï¼Œä»–æŽ¨æµ‹ä»–å¯ä»¥æ›´å¥½åœ°åˆ©ç”¨æ›´å¼ºå¤§çš„æ–°é©±åŠ¨ç¨‹åºã€‚åœ¨é‚£é‡Œæœ‰ä¸€ä¸ªæ›´èªæ˜Žçš„é‡è¯•ç­–ç•¥ï¼Œä½†ä»–ä¸çŸ¥é“å®ƒåˆ°åº•æ˜¯ä»€ä¹ˆã€‚äº‹å®žä¸Šï¼Œæ­£æ˜¯ä»Žæˆ‘ä¸ŽSamçš„å¯¹è¯ä¸­ï¼Œè¿™ç¯‡æ–‡ç« è¯žç”Ÿäº†ã€‚ Samçœ‹åˆ°äº†ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆIanä¸åº”è¯¥é‡è¯•æ¯æ¬¡æ“ä½œäº”åˆ°åæ¬¡ï¼Ÿ çž¬æ€ç½‘ç»œé”™è¯¯ æŒç»­ä¸­æ–­ å‘½ä»¤é”™è¯¯ å¯èƒ½è¿‡å¤šè®¡æ•° æµªè´¹æ—¶é—´ æµªè´¹æ—¶é—´ åœ¨ç½‘ç»œå‡ºçŽ°çž¬æ€é”™è¯¯çš„æƒ…å†µä¸‹ï¼ŒIanä¸ä¼šä¸¢å¤±è®¡æ•°ï¼ŒçŽ°åœ¨ä»–å¯èƒ½ä¼šè®¡æ•°è¿‡å¤šã€‚å› ä¸ºå¦‚æžœæœåŠ¡å™¨åœ¨å‘ç”Ÿç½‘ç»œé”™è¯¯ä¹‹å‰å…ˆè¯»å–å…¶ç¬¬ä¸€æ¡updateOneæ¶ˆæ¯ï¼Œåˆ™ç¬¬äºŒæ¡updateOneæ¶ˆæ¯ä¼šå†æ¬¡é€’å¢žè®¡æ•°å™¨ã€‚ å¦ä¸€æ–¹é¢ï¼Œåœ¨æŒç»­çš„ç½‘ç»œä¸­æ–­æœŸé—´ï¼Œå¤šæ¬¡é‡è¯•æ˜¯æµªè´¹æ—¶é—´ã€‚ç¬¬ä¸€æ¬¡ç½‘ç»œé”™è¯¯åŽï¼Œé©±åŠ¨ç¨‹åºå°†primaryæœåŠ¡å™¨æ ‡è®°ä¸ºâ€œunknownâ€; å½“Iané‡è¯•è¯¥æ“ä½œæ—¶ï¼Œå®ƒä¼šåœ¨é©±åŠ¨ç¨‹åºå°è¯•é‡æ–°è¿žæŽ¥æ—¶é˜»å¡žï¼Œæ¯ç§’æ£€æŸ¥ä¸¤æ¬¡ï¼ŒæŒç»­30ç§’ã€‚å¦‚æžœé©±åŠ¨ç¨‹åºä»£ç ä¸­çš„æ‰€æœ‰åŠªåŠ›éƒ½æ²¡æœ‰æˆåŠŸï¼Œé‚£ä¹ˆå†æ¬¡å°è¯•è¿›å…¥é©±åŠ¨ç¨‹åºçš„é‡è¯•å¾ªçŽ¯æ˜¯å¾’åŠ³çš„ã€‚è¿™ä¼šå¯¼è‡´ä»–çš„åº”ç”¨ç¨‹åºå‡ºçŽ°æŽ’é˜Ÿå’Œå»¶è¿Ÿã€‚ å‘½ä»¤é”™è¯¯ä¹Ÿæ˜¯å¦‚æ­¤ï¼šå¦‚æžœIançš„åº”ç”¨ç¨‹åºæœªè¢«æŽˆæƒï¼Œåˆ™é‡è¯•äº”æ¬¡ä¸ä¼šæ”¹å˜è¯¥æƒ…å†µã€‚ é‡è¯•ä¸€æ¬¡ç½‘ç»œé”™è¯¯çŽ°åœ¨æˆ‘ä»¬æ¯”è¾ƒæŽ¥è¿‘ä¸€ä¸ªæ˜Žæ™ºçš„ç­–ç•¥ã€‚åœ¨Ianåˆå§‹æ“ä½œå¤±è´¥å¹¶å‡ºçŽ°ç½‘ç»œé”™è¯¯åŽï¼ŒIanä¸çŸ¥é“é”™è¯¯æ˜¯æš‚æ—¶çš„è¿˜æ˜¯æŒä¹…çš„ï¼Œå› æ­¤ä»–åªé‡è¯•ä¸€æ¬¡æ“ä½œã€‚å•æ¬¡é‡è¯•è¿›å…¥é©±åŠ¨ç¨‹åºçš„30ç§’é‡è¯•å¾ªçŽ¯ã€‚å¦‚æžœç½‘ç»œé”™è¯¯æŒç»­30ç§’ï¼Œåˆ™å¯èƒ½ä¼šæŒç»­æ›´é•¿æ—¶é—´ï¼Œæ‰€ä»¥Ianæ”¾å¼ƒäº†ç»§ç»­é‡è¯•ã€‚ ä½†æ˜¯ï¼Œé¢å¯¹å‘½ä»¤é”™è¯¯ï¼Œä»–æ ¹æœ¬ä¸ä¼šé‡è¯•ã€‚ çž¬æ€ç½‘ç»œé”™è¯¯ æŒç»­ä¸­æ–­ å‘½ä»¤é”™è¯¯ å¯èƒ½è¿‡å¤šè®¡æ•° æ­£ç¡® æ­£ç¡® æ‰€ä»¥æˆ‘ä»¬åªå‰©ä¸‹ä¸€ç§æƒ…å†µè¿˜æœ‰é—®é¢˜ - Ianæ€Žä¹ˆé¿å…è¿‡å¤šè®¡æ•°çš„å¯èƒ½æ€§ï¼Ÿ é‡è¯•ç½‘ç»œé”™è¯¯ï¼Œä½¿æ“ä½œå¹‚ç­‰å¹‚ç­‰æ€§æ“ä½œæ— è®ºæ˜¯ä¸€æ¬¡è¿˜æ˜¯å¤šæ¬¡æ‰§è¡Œéƒ½å…·æœ‰ç›¸åŒçš„ç»“æžœã€‚å¦‚æžœIançš„æ‰€æœ‰æ“ä½œéƒ½æ˜¯å¹‚ç­‰çš„ï¼Œé‚£ä¹ˆä»–å¯ä»¥å®‰å…¨åœ°é‡è¯•å®ƒä»¬ï¼Œè€Œä¸ä¼šå‘ç”Ÿè¿‡å¤šè®¡æ•°æˆ–ä»»ä½•ç”±äºŽå‘é€æ¶ˆæ¯ä¸¤æ¬¡å¸¦æ¥çš„å…¶ä»–ç±»åž‹é”™è¯¯ã€‚ çž¬æ€ç½‘ç»œé”™è¯¯ æŒç»­ä¸­æ–­ å‘½ä»¤é”™è¯¯ æ­£ç¡® æ­£ç¡® æ­£ç¡® é‚£ä¹ˆIanåº”è¯¥å¦‚ä½•è®©ä»–çš„updateOneæ“ä½œå¹‚ç­‰ï¼Ÿ å¹‚ç­‰æ“ä½œMongoDBæœ‰å››ç§æ“ä½œï¼šæŸ¥æ‰¾ï¼Œæ’å…¥ï¼Œåˆ é™¤å’Œæ›´æ–°ã€‚å‰ä¸‰ä¸ªå¾ˆå®¹æ˜“å¹‚ç­‰æ€§; è®©æˆ‘ä»¬å…ˆæ¥å¤„ç†å®ƒä»¬ã€‚ FindæŸ¥è¯¢è‡ªç„¶æ˜¯å¹‚ç­‰çš„ã€‚ 1234try: doc = findOne()except network err: doc = findOne() ä¸¤æ¬¡æ£€ç´¢æ–‡æ¡£ä¸Žæ£€ç´¢ä¸€æ¬¡æ–‡æ¡£ç»“æžœä¸€æ ·ã€‚ Insertæ¯”æŸ¥è¯¢å›°éš¾ä¸€ç‚¹ï¼Œä½†ä¸æ˜¯å¤ªç³Ÿç³•ã€‚ 123456789doc = &#123;_id: ObjectId(), ...&#125;try: insertOne(doc)except network err: try: insertOne(doc) except DuplicateKeyError: pass # first try worked throw è¿™ä¸ªä¼ªä»£ç çš„ç¬¬ä¸€æ­¥æ˜¯åœ¨å®¢æˆ·ç«¯ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„IDã€‚ MongoDBçš„ObjectIdæ˜¯ä¸ºè¿™ç§ç”¨æ³•è€Œè®¾è®¡çš„ï¼Œä½†ä»»ä½•ç‹¬ç‰¹çš„å€¼éƒ½å¯ä»¥ã€‚ çŽ°åœ¨ï¼ŒIanè¯•å›¾æ’å…¥æ–‡æ¡£ã€‚å¦‚æžœå› ç½‘ç»œé”™è¯¯è€Œå¤±è´¥ï¼Œä»–ä¼šå†æ¬¡å°è¯•ã€‚å¦‚æžœç¬¬äºŒæ¬¡å°è¯•å¤±è´¥ä¸”æœåŠ¡å™¨å‡ºçŽ°é‡å¤é”®é”™è¯¯ï¼Œåˆ™ç¬¬ä¸€æ¬¡å°è¯•æˆåŠŸï¼Œä½†ç”±äºŽç½‘ç»œå±‚å‘ç”Ÿé”™è¯¯ï¼Œä»–æ— æ³•è¯»å–æœåŠ¡å™¨å“åº”ã€‚å¦‚æžœå‡ºçŽ°å…¶ä»–é—®é¢˜ï¼Œä»–å–æ¶ˆæ“ä½œå¹¶æŠ›å‡ºå¼‚å¸¸ã€‚ è¿™ä¸ªæ’å…¥æ˜¯å¹‚ç­‰çš„ã€‚å”¯ä¸€éœ€è¦è­¦å‘Šçš„æ˜¯ï¼Œæˆ‘å‡è®¾Iané™¤äº†MongoDBè‡ªåŠ¨åˆ›å»ºçš„_idä¹‹å¤–ï¼Œæ²¡æœ‰å”¯ä¸€ç´¢å¼•ã€‚å¦‚æžœè¿˜æœ‰å…¶ä»–å”¯ä¸€ç´¢å¼•ï¼Œé‚£ä¹ˆä»–å¿…é¡»è§£æžé‡å¤é”®é”™è¯¯ã€‚ Deleteå¦‚æžœIanåˆ é™¤ä¸€ä¸ªæ–‡æ¡£æ—¶æŒ‡å®šä¸€ä¸ªå”¯ä¸€çš„keyï¼Œé‚£ä¹ˆæ‰§è¡Œä¸¤æ¬¡ä¸Žæ‰§è¡Œä¸€æ¬¡ç›¸åŒã€‚ 1234try: deleteOne(&#123;'key': uniqueValue&#125;)except network err: deleteOne(&#123;'key': uniqueValue&#125;) å¦‚æžœç¬¬ä¸€ä¸ªè¢«æ‰§è¡Œï¼Œä½†æ˜¯Ianå¾—åˆ°ä¸€ä¸ªç½‘ç»œå¼‚å¸¸å¹¶å†æ¬¡å°è¯•ï¼Œé‚£ä¹ˆç¬¬äºŒä¸ªåˆ é™¤å°±æ˜¯ç©ºæ“ä½œ;å®ƒåªæ˜¯ä¸åŒ¹é…ä»»ä½•æ–‡æ¡£ã€‚è¯¥åˆ é™¤å¯ä»¥å®‰å…¨åœ°é‡è¯•ã€‚ åŒæ—¶åˆ é™¤è®¸å¤šæ–‡ä»¶ç”šè‡³æ›´å®¹æ˜“ï¼š 1234try: deleteMany(&#123;...&#125;)except network err: deleteMany(&#123;...&#125;) å¦‚æžœIanåˆ é™¤æ‰€æœ‰åŒ¹é…è¿‡æ»¤å™¨çš„æ–‡æ¡£ï¼Œå¹¶ä¸”ä»–çš„ä»£ç å‡ºçŽ°ç½‘ç»œé”™è¯¯ï¼Œé‚£ä¹ˆä»–å¯ä»¥å†æ¬¡å®‰å…¨åœ°å°è¯•ã€‚æ— è®ºæ˜¯deleteOneè¿è¡Œä¸€æ¬¡è¿˜æ˜¯ä¸¤æ¬¡ï¼Œç»“æžœéƒ½æ˜¯ä¸€æ ·çš„ï¼šæ‰€æœ‰åŒ¹é…çš„æ–‡æ¡£éƒ½è¢«åˆ é™¤ã€‚ åœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹éƒ½å­˜åœ¨ç«žäº‰æ¡ä»¶ï¼šå¦ä¸€ä¸ªè¿›ç¨‹å¯èƒ½ä¼šåœ¨ä¸¤æ¬¡å°è¯•åˆ é™¤å®ƒä»¬ä¹‹é—´æ’å…¥æ–°çš„åŒ¹é…æ–‡æ¡£ã€‚ä½†æ˜¯è¿™åœºæ¯”èµ›å¹¶ä¸æ¯”ä»–çš„ä»£ç æ²¡æœ‰é‡è¯•æ›´ç³Ÿç³•ã€‚ Updateé‚£ä¹ˆæ›´æ–°å‘¢ï¼Ÿé¦–å…ˆè€ƒè™‘é‚£ç§è‡ªç„¶è€Œç„¶æ˜¯å¹‚ç­‰çš„æ›´æ–°ï¼Œè®©æˆ‘ä»¬æ”¾æ¾ä¸€ä¸‹ã€‚ 12345# Idempotent update.updateOne(&#123; '_id': '2016-06-28'&#125;, &#123;'$set':&#123;'sunny': True&#125;&#125;, upsert=True) è¿™ä¸Žæˆ‘ä»¬åŽŸæ¥çš„ä¾‹å­ä¸ä¸€æ ·; Ianå¹¶æ²¡æœ‰å¢žåŠ ä¸€ä¸ªå˜é‡çš„å€¼ï¼Œä»–æŠŠä»Šå¤©çš„â€œsunnyâ€å­—æ®µè®¾ç½®ä¸ºçœŸï¼Œè®©è‡ªå·±æŒ¯ä½œèµ·æ¥ã€‚è¯´ä¸¤æ¬¡ä»Šå¤©æ˜¯é˜³å…‰æ˜Žåªšçš„ï¼Œå°±åƒè¯´ä¸€æ¬¡ä¸€æ ·å¥½ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒupdateOneå¯ä»¥å®‰å…¨åœ°é‡è¯•ã€‚ ä¸€èˆ¬åŽŸåˆ™æ˜¯æœ‰ä¸€äº›MongoDBæ›´æ–°è¿ç®—ç¬¦æ˜¯å¹‚ç­‰çš„ï¼Œæœ‰äº›åˆ™ä¸æ˜¯ã€‚ $setæ˜¯å¹‚ç­‰çš„ï¼Œå› ä¸ºå¦‚æžœä¸¤æ¬¡å°†æŸäº›å€¼è®¾ç½®ä¸ºç›¸åŒçš„å€¼ï¼Œåˆ™ä¸ä¼šæœ‰ä»»ä½•åŒºåˆ«ï¼Œè€Œ$incä¸æ˜¯å¹‚ç­‰çš„ã€‚ å¦‚æžœIançš„æ›´æ–°æ“ä½œç¬¦æ˜¯å¹‚ç­‰çš„ï¼Œé‚£ä¹ˆä»–å¯ä»¥å¾ˆå®¹æ˜“åœ°é‡è¯•å®ƒï¼šä»–å°è¯•ä¸€æ¬¡ï¼Œå¦‚æžœä»–å¾—åˆ°ç½‘ç»œå¼‚å¸¸ï¼Œä»–ä¼šå†æ¬¡å°è¯•ã€‚ 123456try: updateOne(&#123;' _id': '2016-06-28'&#125;, &#123;'$set':&#123;'sunny': True&#125;&#125;, upsert=True)except network err: try again, if that fails throw æ‰€ä»¥çŽ°åœ¨æˆ‘ä»¬ç»ˆäºŽå‡†å¤‡å¥½è§£å†³æˆ‘ä»¬æœ€éš¾çš„ä¾‹å­ï¼ŒåŽŸå§‹çš„éžå¹‚ç­‰updateOneï¼š 123updateOne(&#123; '_id': '2016-06-28'&#125;, &#123;'$inc': &#123;'counter': 1&#125;&#125;, upsert=True) å¦‚æžœIanå¶ç„¶åšäº†ä¸¤æ¬¡è¿™æ ·çš„æ“ä½œï¼Œä»–ä¼šå°†è®¡æ•°å¢žåŠ 2ã€‚ æˆ‘ä»¬å¦‚ä½•å°†å®ƒå˜æˆå¹‚ç­‰æ“ä½œï¼Ÿæˆ‘ä»¬å°†åˆ†æˆä¸¤æ­¥ã€‚æ¯ä¸€æ­¥éƒ½æ˜¯å¹‚ç­‰çš„ï¼Œé€šè¿‡å°†å®ƒè½¬æ¢æˆä¸€å¯¹å¹‚ç­‰è¿ç®—ï¼Œæˆ‘ä»¬å°†å®‰å…¨åœ°é‡è¯•ã€‚ æˆ‘ä»¬å‡è®¾ä¸€å¼€å§‹æ–‡æ¡£çš„counterå€¼æ˜¯Nï¼š 1234&#123; _id: '2016-06-28', counter: N&#125; åœ¨ç¬¬ä¸€æ­¥ä¸­ï¼ŒIanå…ˆä¸ç®¡counterå½“å‰çš„å€¼ï¼Œä»–åªæ˜¯ç»™ä¸€ä¸ªâ€œpendingâ€æ•°ç»„æ·»åŠ ä¸€ä¸ªæ ‡è®°ã€‚è¿™é‡Œä»–éœ€è¦ä¸€äº›ç‹¬ç‰¹çš„ä¸œè¥¿; ä¸€ä¸ªObjectIdæ˜¯å¾ˆå¥½çš„é€‰æ‹©ï¼š 1234567oid = ObjectId()try: updateOne(&#123; '_id': '2016-06-28'&#125;, &#123;'$addToSet': &#123;'pending': oid&#125;&#125;, upsert=True)except network err: try again, then throw $addToSetæ˜¯å¹‚ç­‰è¿ç®—ç¬¦ä¹‹ä¸€ã€‚å¦‚æžœå®ƒè¿è¡Œä¸¤æ¬¡ï¼Œä»¤ç‰Œåªä¼šæ·»åŠ ä¸€æ¬¡åˆ°æ•°ç»„ä¸­ã€‚çŽ°åœ¨æ–‡æ¡£çœ‹èµ·æ¥åƒè¿™æ ·ï¼š 12345&#123; _id: '2016-06-28', counter: N, pending: [ ObjectId("...") ]&#125; ç¬¬äºŒæ­¥ï¼Œå¯¹äºŽå•ä¸ªæ“ä½œï¼ŒIané€šè¿‡_idåŠå…¶å¾…å¤„ç†æ ‡è®°æŸ¥è¯¢æ–‡æ¡£ï¼Œåˆ é™¤å¾…å¤„ç†æ ‡è®°å¹¶å¢žåŠ è®¡æ•°å™¨ã€‚ 123456789try: # Search for the document by _id and pending token. updateOne(&#123;'_id': '2016-06-28', 'pending': oid&#125;, &#123;'$pull': &#123;'pending': oid&#125;, '$inc': &#123;'counter': 1&#125;&#125;, upsert=False)except network err: try again, then throw æ‰€æœ‰çš„MongoDBæ›´æ–°ï¼Œæ— è®ºå®ƒä»¬æ˜¯å¦æ˜¯å¹‚ç­‰çš„ï¼Œéƒ½æ˜¯åŽŸå­çš„ï¼šå•ä¸ªupdateOneå®Œå…¨æˆåŠŸæˆ–æ ¹æœ¬æ²¡æœ‰ä»»ä½•ä½œç”¨ã€‚æ‰€ä»¥åªæœ‰å½“è®¡æ•°å™¨å¢žåŠ 1æ—¶, ä»¤ç‰Œæ‰ä¼šä»Žå¾…å¤„ç†æ•°ç»„ä¸­ç§»é™¤ã€‚ æ€»çš„æ¥è¯´ï¼Œè¿™ä¸ªæ›´æ–°æ˜¯å¹‚ç­‰çš„ã€‚æƒ³è±¡ä¸€ä¸‹ï¼ŒIanå°†ä»¤ç‰Œç§»å‡ºæ•°ç»„å¹¶åœ¨ç¬¬ä¸€æ¬¡å°è¯•æ—¶é€’å¢žè®¡æ•°å™¨ï¼Œä½†æ˜¯ä¹‹åŽä»–æ— æ³•è¯»å–æœåŠ¡å™¨å“åº”ï¼Œå› ä¸ºå­˜åœ¨ç½‘ç»œé”™è¯¯ã€‚ä»–ç¬¬äºŒæ¬¡å°è¯•æ˜¯æ— æ•ˆçš„ï¼Œå› ä¸ºæŸ¥è¯¢è¦æ±‚åŒ¹é…å…·æœ‰å¾…å¤„ç†ä»¤ç‰Œçš„æ–‡æ¡£ï¼Œä½†ä»–å·²ç»å°†å…¶å–å‡ºã€‚ æ‰€ä»¥Ianå¯ä»¥å®‰å…¨åœ°é‡è¯•è¿™â€‹â€‹ä¸ªupdateOneã€‚æ— è®ºå®ƒæ‰§è¡Œäº†ä¸€æ¬¡è¿˜æ˜¯ä¸¤æ¬¡ï¼Œæ–‡æ¡£ç»“æžœéƒ½æ˜¯ä¸€æ ·çš„ï¼š 12345&#123; _id: '2016-06-28', counter: N + 1, pending: [ ]&#125; ä»»åŠ¡å®Œæˆï¼ŸçŽ°åœ¨ä½ å·²ç»åšåˆ°äº†ï¼šä½ é‡çŽ°å®žçŽ°äº†IanåŽŸæ¥çš„updateOneï¼Œè¿™æ˜¯ä¸å®‰å…¨çš„é‡è¯•ï¼Œå¹¶é€šè¿‡å°†å®ƒåˆ†æˆä¸¤æ­¥æ¥ä½¿å®ƒå˜å¾—å¹‚ç­‰ã€‚ è¿™é¡¹æŠ€æœ¯æœ‰å‡ ç‚¹éœ€è¦æ³¨æ„ã€‚å…¶ä¸­ä¹‹ä¸€æ˜¯Ianç®€å•çš„$incæ“ä½œçŽ°åœ¨éœ€è¦ä¸¤æ¬¡å¾€è¿”ã€‚å®ƒéœ€è¦å»¶è¿Ÿä¸¤å€ï¼Œè´Ÿè½½åŠ å€ã€‚å¦‚æžœåœ¨ç½‘ç»œçž¬æ€é”™è¯¯ä¸­è¢«å°‘è®¡å…¥ä¸€æ¬¡æˆ–è¶…è¿‡ä¸€æ¬¡æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œä»–å°±ä¸åº”è¯¥ä½¿ç”¨è¿™ç§æŠ€æœ¯ã€‚ å¦ä¸€ä¸ªè­¦å‘Šæ˜¯ï¼Œä»–éœ€è¦ä¸€ä¸ªæ¯æ™šæ‰§è¡Œçš„æ¸…ç†è¿‡ç¨‹ã€‚è€ƒè™‘ä¸€ä¸‹ï¼šå¦‚æžœç¬¬äºŒæ­¥ä»Žæœªå®Œæˆï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ 12345678try: updateOne(&#123;'_id': '2016-06-28', 'pending': oid&#125;, &#123;'$pull': &#123;'pending': oid&#125;, '$inc': &#123;'counter': 1&#125;&#125;, upsert=False)except network err: try again, then throw å‡è®¾Ianåœ¨æ·»åŠ å¾…å¤„ç†ä»¤ç‰ŒåŽï¼Œå°†å…¶ç§»é™¤å¹¶å¢žåŠ è®¡æ•°å™¨ä¹‹å‰ï¼Œç½‘ç»œä¸­æ–­å¼€å§‹ã€‚è¯¥æ–‡ä»¶å¤„äºŽè¿™ç§çŠ¶æ€ï¼š 12345&#123; _id: '2016-06-28', counter: N, pending: [ ObjectId("...") ]&#125; Ianéœ€è¦ä¸€ä¸ªæ¯æ™šæ‰§è¡Œçš„ä»»åŠ¡æ¥æŸ¥æ‰¾ä»Šå¤©ä¸­æ­¢çš„ä»»åŠ¡é—ç•™çš„ä»»ä½•å¾…å¤„ç†ä»¤ç‰Œï¼Œå¹¶å®Œæˆæ›´æ–°è®¡æ•°å™¨ã€‚ä¸ºäº†é¿å…å¹¶å‘é—®é¢˜ï¼Œä»–ä¸€ç›´ç­‰åˆ°ä¸€å¤©ç»“æŸã€‚ä»–çš„ä»»åŠ¡ä½¿ç”¨èšåˆç®¡é“æ¥æŸ¥æ‰¾å…·æœ‰å¾…å¤„ç†ä»¤ç‰Œçš„æ–‡æ¡£ï¼Œå¹¶å°†å…¶æ•°é‡æ·»åŠ åˆ°å½“å‰è®¡æ•°ä¸­ï¼š 1234567891011121314151617181920pipeline = [&#123; '$match': &#123;'pending.0': &#123;'$exists': True&#125;&#125;&#125;, &#123; '$project': &#123; 'counter': &#123; '$add': [ '$counter', &#123;'$size': '$pending'&#125; ] &#125; &#125;&#125;]for doc in collection.aggregate(pipeline): collection.updateOne( &#123; '_id': doc._id&#125;, &#123; '$set': &#123;'counter': doc.counter&#125;, '$unset': &#123;'pending': True&#125; &#125;) å¯¹äºŽæ¯ä¸ªèšåˆæ“ä½œç»“æžœï¼Œæ­¤ä»»åŠ¡ä½¿ç”¨æœ€ç»ˆè®¡æ•°å™¨å€¼æ›´æ–°æºæ–‡æ¡£ï¼Œå¹¶æ¸…é™¤å¾…å¤„ç†æ•°ç»„ã€‚ updateOneå¯ä»¥å®‰å…¨åœ°é‡è¯•ï¼Œå› ä¸ºå®ƒä½¿ç”¨å¹‚ç­‰è¿ç®—ç¬¦$setå’Œ$unsetã€‚Iançš„æ¸…ç†ä»»åŠ¡å¯ä»¥ä¸€ç›´å°è¯•ï¼Œç›´åˆ°å®ƒæˆåŠŸï¼Œæ— è®ºä»–çš„ç½‘ç»œæœ‰å¤šä¹ˆç³Ÿç³•ã€‚æ‰§è¡Œæ­¤æ¸…ç†ä»»åŠ¡åŽï¼ŒIanä»Šå¤©çš„äº‹ä»¶æ•°é‡æœ€ç»ˆå°†æ˜¯æ­£ç¡®çš„ã€‚ å¦‚æžœIanæŽ¥å—è¿™äº›ç¼ºç‚¹ - ä¸€æ¬¡å¢žåŠ éœ€è¦ä¸¤æ¬¡å¾€è¿”ï¼Œå¹¶ä¸”å¯èƒ½åœ¨ä¸€å¤©ç»“æŸä¹‹å‰ä¸èƒ½å®Œæˆ - é‚£ä¹ˆå¯¹äºŽéžå¸¸å…³é”®çš„æ“ä½œï¼Œè¿™ç§æŠ€æœ¯æ˜¯ä¸€ç§å¯é çš„æ–¹å¼æ¥ä½¿å…¶è®¡æ•°å™¨åªå¢žåŠ ä¸€æ¬¡ã€‚ Ref How To Write Resilient MongoDB Applications Retryable Writes]]></content>
  </entry>
  <entry>
    <title><![CDATA[Deadlock caused by forking a multithreaded process]]></title>
    <url>%2Fdeadlock-caused-by-forking-a-multithreaded-process%2F</url>
    <content type="text"><![CDATA[æœ€è¿‘ç”Ÿäº§çŽ¯å¢ƒçš„ä¸€ä¸ªæ¨¡å—çªç„¶å¡ä½äº†ï¼Œæ¨¡å—çš„ä½œè€…å·²ç»åŽ»å…¶ä»–ç»„äº†ï¼Œæ²¡åŠžæ³•åªèƒ½è‡ªå·±æŸ¥é—®é¢˜äº†ðŸ¤£ã€‚ è¯¥æ¨¡å—ä½¿ç”¨pythonçš„loggingæ ‡å‡†åº“è®°å½•æ—¥å¿—ï¼Œè‡ªå®šä¹‰kafkaä½œä¸ºhandlerï¼Œæ—¥å¿—é€šè¿‡kafkaå‘é€åˆ°Elasticsearchï¼Œç„¶åŽå°±æ˜¯ELKæ—¥å¿—å¤„ç†äº†ã€‚ æ¨¡å—ä¸ºäº†æé«˜åžåï¼Œå†…éƒ¨ä½¿ç”¨äº†å¤šè¿›ç¨‹ï¼Œé—®é¢˜æ°æ°å°±å‡ºçŽ°åœ¨äº†è¿™é‡Œã€‚ ä½¿ç”¨GDB attachåˆ°å¡æ­»çš„è¿›ç¨‹ï¼Œæ‰§è¡Œpy-btå‘½ä»¤ï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š Traceback (most recent call first): File â€œ/usr/lib64/python2.7/multiprocessing/forking.pyâ€, line 135, in poll pid, sts = os.waitpid(self.pid, flag) File â€œ/usr/lib64/python2.7/multiprocessing/forking.pyâ€, line 154, in wait return self.poll(0) File â€œ/usr/lib64/python2.7/multiprocessing/process.pyâ€, line 145, in join res = self._popen.wait(timeout) File â€œparser/parser_main.pyâ€, line 76, in data_parse process.join() ä¸»è¿›ç¨‹é‡Œä½¿ç”¨multiprocessingæ¨¡å—åˆ›å»ºå¤šè¿›ç¨‹æ‰§è¡Œä»»åŠ¡ï¼Œè¿™é‡Œä¸»è¿›ç¨‹åœ¨ç­‰å¾…å­è¿›ç¨‹æ‰§è¡Œç»“æŸã€‚ é˜…è¯»multiprocessingæ¨¡å—çš„æºä»£ç ï¼Œå¯ä»¥å‘çŽ°å…¶åˆ›å»ºå­è¿›ç¨‹æ—¶è°ƒç”¨äº†os.fork()å‡½æ•°ï¼Œè¯¥å‡½æ•°æ˜¯python osæ¨¡å—å¯¹ç³»ç»Ÿè°ƒç”¨forkçš„å°è£…ã€‚ å­è¿›ç¨‹çš„è¾“å‡ºï¼š Traceback (most recent call first): Waiting for the GIL File â€œsdk/python-lib/kafka/producer/record_accumulator.pyâ€, line 223, in append with self._tp_locks[tp]: File â€œsdk/python-lib/kafka/producer/kafka.pyâ€, line 516, in send self.config[â€˜max_block_msâ€™]) File â€œsdk/python-lib/elk_logging/handlers/kafka.pyâ€, line 37, in emit self.format(record).encode(â€˜utf-8â€™)) elk_loggingæ¨¡å—è‡ªå®šä¹‰äº†kafka handlerï¼Œæ¨¡å—å¯¼å…¥æ—¶é€šè¿‡logging.config.dictConfig()é…ç½®loggingæ¨¡å—ã€‚kafakå‘é€æ¶ˆæ¯æ—¶èŽ·å–ä¸åˆ°é”self._tp_lock[tp]ï¼Œç„¶åŽä¸€ç›´ç­‰å¾…ã€‚ åœ¨Googleä¸Šæœç´¢â€œkafka self._tp_lock deadlockâ€æ²¡æœ‰å‘çŽ°æœ‰ä»·å€¼çš„ä¿¡æ¯ï¼ŒåŸºæœ¬æŽ’é™¤æ˜¯kafkaåº“çš„bugï¼Œå¦‚æžœæ˜¯kafkaåº“çš„bugï¼Œç½‘ä¸Šä¸å¤ªå¯èƒ½ä¸€ç‚¹çº¿ç´¢ä¹Ÿæ²¡æœ‰ã€‚ å‰æ–‡æˆ‘ä»¬æåˆ°è¿™é‡Œä½¿ç”¨äº†forkåˆ›å»ºå­è¿›ç¨‹ï¼Œå½“å†…æ ¸æ‰§è¡Œforkæ—¶ï¼Œç”Ÿæˆçš„å­è¿›ç¨‹æ˜¯çˆ¶è¿›ç¨‹çš„å‰¯æœ¬ï¼Œå­è¿›ç¨‹èŽ·å¾—çˆ¶è¿›ç¨‹çš„æ•°æ®ç©ºé—´ã€å †å’Œæ ˆçš„å‰¯æœ¬ï¼ˆè¿™é‡Œæ˜¯å­è¿›ç¨‹è‡ªå·±æ‹¥æœ‰çš„å‰¯æœ¬ï¼Œå¹¶ä¸ä¸Žçˆ¶è¿›ç¨‹å…±äº«è¿™äº›å­˜å‚¨ç©ºé—´ã€‚å¾ˆå¤šå®žçŽ°ä½¿ç”¨äº†å†™æ—¶å¤åˆ¶æŠ€æœ¯ï¼Œä¸€å¼€å§‹è¿™äº›åŒºåŸŸè¢«çˆ¶å­è¿›ç¨‹å…±äº«ï¼Œå¦‚æžœä»»æ„ä¸€ä¸ªè¿›ç¨‹ä¿®æ”¹è¿™äº›åŒºåŸŸï¼Œåˆ™å†…æ ¸åªä¸ºä¿®æ”¹çš„é‚£å—å†…å­˜åˆ¶ä½œä¸€ä¸ªå‰¯æœ¬ï¼Œé€šå¸¸æ˜¯è™šæ‹Ÿå†…å­˜çš„ä¸€é¡µï¼‰ã€‚ åœ¨Linuxç³»ç»Ÿä¸­è°ƒç”¨forkï¼Œåˆ›å»ºçš„å­è¿›ç¨‹ä¸­åªæœ‰ä¸€ä¸ªçº¿ç¨‹â€”â€”çˆ¶è¿›ç¨‹ä¸­è°ƒç”¨forkå‡½æ•°çš„çº¿ç¨‹ã€‚ Note the following further points: The child process is created with a single threadâ€”the one that called fork(). The entire virtual address space of the parent is replicated in the child, including the states of mutexes, condition variables, and other pthreads objects; the use of pthread_atfork(3) may be helpful for dealing with problems that this can cause. ä¹Ÿä¸æ˜¯æ‰€æœ‰çš„ç³»ç»Ÿéƒ½æ˜¯è¿™æ ·ï¼ŒSolarisç³»ç»Ÿlibthreadåº“æä¾›çš„forkå‡½æ•°ä¼šâ€œå¤åˆ¶â€œæ‰€æœ‰çº¿ç¨‹ã€‚ Solaris libthread supports both fork() and fork1(). The fork() call has â€œfork-allâ€ semanticsâ€“it duplicates everything in the process, including threads and LWPs, creating a true clone of the parent. The fork1() call creates a clone that has only one thread; the process state and address space are duplicated, but only the calling thread is cloned. POSIX libpthread supports only fork(), which has the same semantics as fork1() in Solaris threads. POSIXæ ‡å‡†å®šä¹‰çš„è¡Œä¸ºæ˜¯forkåªâ€œå¤åˆ¶â€ä¸€ä¸ªçº¿ç¨‹ã€‚ é‚£ä¹ˆè¿™äº›ä¸Žä¸Šé¢çš„æ­»é”æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿpythonæ ‡å‡†åº“loggingæ¨¡å—åœ¨åˆ›å»ºloggeræ—¶ä¼šè°ƒç”¨åˆ°ä»¥ä¸‹ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°ä¸€ä¸ªloggeråªä¼šå®žä¾‹åŒ–ä¸€æ¬¡ï¼Œå¯¹åº”çš„handlerå’Œformatterç­‰ä¹Ÿåªä¼šå®žä¾‹åŒ–ä¸€æ¬¡ã€‚ logging/__init__.py manager.getLogger(name)123456789101112131415161718_acquireLock()try: if name in self.loggerDict: rv = self.loggerDict[name] if isinstance(rv, PlaceHolder): ph = rv rv = (self.loggerClass or _loggerClass)(name) rv.manager = self self.loggerDict[name] = rv self._fixupChildren(ph, rv) self._fixupParents(rv) else: rv = (self.loggerClass or _loggerClass)(name) rv.manager = self self.loggerDict[name] = rv self._fixupParents(rv)finally: _releaseLock() å¦‚æžœè‡ªå®šä¹‰äº†handlerï¼Œé…ç½®loggingæ¨¡å—æ—¶ä¼šå¯¼å…¥æŒ‡å®šçš„handler classï¼Œå¹¶å®žä¾‹åŒ–ã€‚ logging/config.py DictConfigurator.configure_handler()123456789101112131415161718if '()' in config: c = config.pop('()') if not callable(c): c = self.resolve(c) factory = celse: cname = config.pop('class') klass = self.resolve(cname) factory = klassprops = config.pop('.', None)kwargs = dict([(k, config[k]) for k in config if valid_ident(k)])try: result = factory(**kwargs)except TypeError as te: if "'stream'" not in str(te): raise kwargs['strm'] = kwargs.pop('stream') result = factory(**kwargs) çˆ¶è¿›ç¨‹å’Œforkå‡ºæ¥çš„å­è¿›ç¨‹ä½¿ç”¨çš„æ—¶ç›¸åŒçš„å¯¹è±¡å®žä¾‹ï¼Œç›¸åŒçš„loggerï¼Œç›¸åŒçš„kafka handlerã€‚ kafka producerå‘é€æ¶ˆæ¯æ˜¯å¤šçº¿ç¨‹å¼‚æ­¥çš„ã€‚KafkaProducerå®žä¾‹åŒ–æ—¶ä¼šå¯åŠ¨ä¸€ä¸ªæ¶ˆæ¯å‘é€çº¿ç¨‹ã€‚æœ‰æ¶ˆæ¯è¿‡æ¥åŽï¼Œå…ˆé€šè¿‡RecordAccumulatorç±»å®žä¾‹å°†æ¶ˆæ¯è¿½åŠ åˆ°å†…éƒ¨listï¼Œç„¶åŽå”¤é†’self._senderå‘é€çº¿ç¨‹ï¼Œå‘é€çº¿ç¨‹é€šè¿‡RecordAccumulatorç±»å®žä¾‹æ£€æŸ¥å“ªäº›å¯ä»¥å‘é€ï¼Œæ•´ä¸ªè¿‡ç¨‹RecordAccumulatorç±»å®žä¾‹ç»´æŠ¤äº†topic+partitionç›¸å…³çš„é”ã€‚1234567891011121314def __init__(self, **configs): ... self._accumulator = RecordAccumulator(message_version=message_version, metrics=self._metrics, **self.config) self._sender = Sender(client, self._metadata, self._accumulator, self._metrics, guarantee_message_order=guarantee_message_order, **self.config) self._sender.daemon = True self._sender.start() self._closed = False self._cleanup = self._cleanup_factory() atexit.register(self._cleanup) log.debug("Kafka producer started") å¦‚æžœforkæ—¶RecordAccumulatorç±»å®žä¾‹ä¸­æŸä¸ªtopic+partitionçš„é”è¿˜æ²¡æœ‰é‡Šæ”¾ï¼Œå­è¿›ç¨‹ä¸­è¯¥é”æ°¸è¿œä¸ä¼šè¢«é‡Šæ”¾ï¼Œå› ä¸ºæ²¡æœ‰äº†å‘é€çº¿ç¨‹ï¼Œå¦‚æžœå­è¿›ç¨‹ä¸­æ°å¥½å‘åŒä¸€ä¸ªtopicå’ŒåŒä¸€ä¸ªpartitionå‘é€æ¶ˆæ¯å°±ä¼šæ­»é”ã€‚ ç”±äºŽå­è¿›ç¨‹ä¸ä¼šå¸¸é©»åœ¨åŽå°ï¼Œæ‰€ä»¥æ»¡è¶³ä¸Šè¿°æ¡ä»¶è¿˜æ˜¯æ¯”è¾ƒéš¾çš„ï¼Œä»Žè¡¨çŽ°ä¸Šæ¥çœ‹ï¼Œ5ä¸ªæœˆé‡Œå‘ç”Ÿäº†ä¸€æ¬¡æ­»é”ã€‚ åŽè®°é¿å…è¿™ç§é—®é¢˜ï¼Œæœ€å¥½çš„åŠžæ³•å°±æ˜¯ä¸è¦forkä¸€ä¸ªå¤šçº¿ç¨‹è¿›ç¨‹ã€‚ pythonçš„æ ‡å‡†åº“loggingæ¨¡å—æ›¾ç»å› ä¸ºç±»ä¼¼çš„åŽŸå› å‡ºè¿‡é—®é¢˜ã€‚çŽ°åœ¨å®˜æ–¹æ–‡æ¡£å·²ç»æŒ‡å‡ºï¼š Note that safely forking a multithreaded process is problematic. Googleç”šè‡³è¿˜åˆ›å»ºè¿‡ä¸€ä¸ªé¡¹ç›®python-atforkï¼Œæ¨¡ä»¿pthread_atforkï¼Œå¯ä»¥æ³¨å†Œå‡½æ•°ï¼Œä¿æ­£å¤šçº¿ç¨‹çš„æƒ…å†µä¸‹å¯ä»¥å®‰å…¨çš„forkã€‚å½“ç„¶ï¼Œè¯¥é¡¹ç›®å·²ç»è¢«åºŸå¼ƒäº†ã€‚ å¦‚æžœä½¿ç”¨è¾ƒæ–°çš„pythonç‰ˆæœ¬ï¼ˆ3.5+ ï¼Ÿï¼‰å¯ä»¥æŒ‡å®šmultiprocessingæ¨¡å—åˆ›å»ºè¿›ç¨‹çš„æ–¹å¼ï¼Œå¯ä»¥å°è¯•spawnæ–¹å¼ã€‚ Ref UNIXçŽ¯å¢ƒé«˜çº§ç¼–ç¨‹ Linux fork manual Special Issues for fork() and Solaris Threads python multiprocessing doc Safe to call multiprocessing from a thread in Pythonï¼Ÿ reentrancy, thread safe, asynchronous signal safe, interrupt safe and cancellation safe Threads and fork(): think twice before mixing them]]></content>
  </entry>
  <entry>
    <title><![CDATA[Debug Python with GDB in off-line CentOS]]></title>
    <url>%2Fdebug-python-with-gdb-in-offline-centos%2F</url>
    <content type="text"><![CDATA[GDBä¸ä»…å¯ä»¥è°ƒè¯•C/C++ç¨‹åºï¼Œå®ƒè¿˜å¯ä»¥è°ƒè¯•Pythonç­‰ç¨‹åºï¼Œæ˜¯éžå¸¸é‡è¦å’Œæœ‰åŠ›çš„å¼€å‘å·¥å…·ä¹‹ä¸€ã€‚å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œéƒ½å¯ä»¥ç›´æŽ¥å®‰è£…å‘è¡Œç‰ˆæä¾›çš„gdbæ¥è°ƒè¯•ç¨‹åºï¼Œä½†æ˜¯ï¼ŒæŸäº›æƒ…å†µä¸‹éœ€è¦è‡ªå·±ç¼–è¯‘ï¼Œä¾‹å¦‚ï¼Œæœºå™¨æ— æ³•ä¸Šç½‘ï¼›ç”šè‡³æ²¡æœ‰æƒé™ä¿®æ”¹ç³»ç»Ÿï¼Œæ— æ³•å®‰è£…è½¯ä»¶ã€‚ä¸‹é¢ä»¥CentOSä¸ºä¾‹ï¼Œä»‹ç»å¦‚ä½•åœ¨ç¦»çº¿å¹¶ä¸”æ²¡æœ‰å…¨éƒ¨æƒé™çš„æƒ…å†µä¸‹ä½¿ç”¨GDBè°ƒè¯•Pythonç¨‹åºã€‚ é¦–å…ˆï¼Œéœ€è¦åœ¨ç›¸åŒç³»ç»Ÿç‰ˆæœ¬å¯ä»¥ä¸Šç½‘çš„æœºå™¨ä¸Šç¼–è¯‘GDB wget -c http://ftp.gnu.org/gnu/gdb/gdb-8.0.1.tar.gz tar xvf gdb-8.0.1.tar.gz cd gdb-8.0.1.tar.gz mkdir build cd build ../configure --enable-static --with-python --disable-interprocess-agent --with-lzma make éœ€è¦æ‹¿åˆ°ç¦»çº¿æœºå™¨ä½¿ç”¨ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨â€˜â€“enable-static â€“disable-interprocess-agentâ€™ï¼ŒæœŸæœ›èŽ·å¾—ä¸€ä¸ªé™æ€é“¾æŽ¥çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚é€šè¿‡â€˜â€“with-pythonâ€™å¯ç”¨äº†pythonè°ƒè¯•åŠŸèƒ½ã€‚â€˜â€“with-lzmaâ€™å¯ç”¨äº†lzmaæ”¯æŒï¼Œç”±äºŽæŸäº›å‘è¡Œç‰ˆåˆ†å‘çš„äºŒè¿›åˆ¶æ–‡ä»¶ä½¿ç”¨äº†â€˜MiniDebugInfoâ€™ç‰¹æ€§ï¼šåœ¨äºŒè¿›åˆ¶æ–‡ä»¶ä¸­å­˜åœ¨ä¸€ä¸ªåä¸ºâ€˜gnu_debugdataâ€™çš„ç‰¹æ®ŠåŒºåŸŸï¼Œè¯¥åŒºåŸŸä¿å­˜äº†ç»è¿‡lzmaåŽ‹ç¼©çš„é¢å¤–ç¬¦å·ä¿¡æ¯ã€‚ å¦‚æžœåœ¨configureè¿‡ç¨‹ä¸­æŠ¥é”™ï¼Œä¸€èˆ¬éƒ½æ˜¯ç¼ºå°‘ä¸€äº›ä¾èµ–åŒ…ï¼Œæ ¹æ®æç¤ºè¿›è¡Œå®‰è£…å°±å¯ä»¥äº†ã€‚ ç¼–è¯‘å®ŒæˆåŽï¼Œéœ€è¦çš„æ–‡ä»¶éƒ½åœ¨build/gdbç›®å½•å†…ï¼Œå°†ä»–ä»¬å¤åˆ¶åˆ°å¦ä¸€ä¸ªç›®å½• mkdir -p ~/gdb/data-directory cd gdb cp gdb ~/gdb/gdb cp -r data-directory/* ~/gdb/data-directory cd ~/gdb chmod +x ./gdb data-directoryç›®å½•å†…ä¿å­˜äº†gdbéœ€è¦ä½¿ç”¨çš„æ•°æ®æ–‡ä»¶ã€‚çŽ°åœ¨å°±å¯ä»¥ä½¿ç”¨è¿™ä¸ªgdbåœ¨ç¦»çº¿ç³»ç»Ÿä¸Šç®€å•è°ƒè¯•ç¨‹åºäº† ./gdb --data-directory=./data-directory your-program ä½†æ˜¯å½“è¿›å…¥åˆ°ä¸€äº›åº“å‡½æ•°æ—¶ï¼Œä¼šå‡ºçŽ°é”™è¯¯ï¼Œå› ä¸ºç³»ç»Ÿä¸Šæ²¡æœ‰ç›¸åº”çš„è°ƒè¯•ä¿¡æ¯æ–‡ä»¶ã€‚éœ€è¦æ‰‹åŠ¨éƒ¨ç½²è¿™äº›æ–‡ä»¶ï¼Œä»¥è°ƒè¯•Pythonä¸ºä¾‹ï¼Œé¦–å…ˆèŽ·å–ç³»ç»Ÿä¸­pythonåŒ…çš„ç‰ˆæœ¬ yum list installed | grep ^python.x86_64 å‡å¦‚å¾—åˆ°çš„ä¿¡æ¯æ˜¯â€˜python.x86_64 2.7.5-58.el7â€™ï¼ŒåŽ»debuginfo.centos.orgä¸‹è½½ç›¸åº”çš„è°ƒè¯•ä¿¡æ¯æ–‡ä»¶ï¼Œä¾‹å¦‚ï¼Œâ€™python-debuginfo-2.7.5-58.el7.x86_64.rpmâ€˜ã€‚ å°†è¯¥æ–‡ä»¶è§£åŒ… rpm2cpio python-debuginfo-2.7.5-58.el7.x86_64.rpm | cpio -idmv æ­£å¸¸æƒ…å†µä¸‹ï¼Œè¯¥æ–‡ä»¶æ˜¯é€šè¿‡rpmå®‰è£…åˆ°ç³»ç»Ÿé‡Œçš„ï¼Œå®‰è£…åŽçš„ç»“æž„å’Œç›´æŽ¥è§£åŽ‹å‡ºæ¥çš„ç»“æž„å¯èƒ½ä¸åŒï¼Œç³»ç»Ÿç›®å½•ï¼š ls -l /usr/lib/debug/ drwxr-xr-x. 3 root root 64 11æœˆ 5 2016 . dr-xr-xr-x. 44 root root 4096 10æœˆ 28 21:38 .. lrwxrwxrwx. 1 root root 7 10æœˆ 28 21:21 bin -&gt; usr/bin lrwxrwxrwx. 1 root root 7 10æœˆ 28 21:21 lib -&gt; usr/lib lrwxrwxrwx. 1 root root 9 10æœˆ 28 21:21 lib64 -&gt; usr/lib64 lrwxrwxrwx. 1 root root 8 10æœˆ 28 21:21 sbin -&gt; usr/sbin drwxr-xr-x. 6 root root 65 10æœˆ 28 21:21 usr è§£åŒ…ç›®å½•ï¼š ls -al ./usr/lib/debug/ drwxr-xr-x. 5 buildbot buildbot 46 10æœˆ 29 23:26 . drwxrwxr-x. 3 buildbot buildbot 19 10æœˆ 29 23:26 .. drwxr-xr-x. 114 buildbot buildbot 4096 10æœˆ 29 23:26 .build-id drwxr-xr-x. 2 buildbot buildbot 40 10æœˆ 29 23:26 .dwz drwxr-xr-x. 4 buildbot buildbot 30 10æœˆ 29 23:26 usr ç³»ç»Ÿç›®å½•ä¸­çš„ç¬¦å·é“¾æŽ¥ï¼Œè§£åŒ…ç›®å½•é‡Œæ˜¯æ²¡æœ‰çš„ï¼Œéœ€è¦æ‰‹åŠ¨åŠ ä¸Šã€‚è§£åŒ…ç›®å½•é‡Œçš„â€˜.build-idâ€™æ–‡ä»¶å¤¹æ˜¯éžå¸¸é‡è¦çš„æ–‡ä»¶å¤¹ã€‚ GDBå…è®¸å°†è°ƒè¯•ä¿¡æ¯å’Œå¯æ‰§è¡Œä»£ç åˆ†å¼€å­˜æ”¾ï¼Œå› ä¸ºä¸€èˆ¬æƒ…å†µï¼Œè°ƒè¯•ä¿¡æ¯æ¯”å¯æ‰§è¡Œä»£ç å¤§å¾ˆå¤šï¼Œæ™®é€šç”¨æˆ·ä¸éœ€è¦è°ƒè¯•ä¿¡æ¯ã€‚åˆ†å¼€å­˜æ”¾å¾ˆå¥½çš„è§£å†³äº†æ­¤é—®é¢˜ã€‚ GDBæ”¯æŒä¸¤ç§æŒ‡å®šè°ƒè¯•ä¿¡æ¯æ–‡ä»¶çš„æ–¹æ³•ï¼š å¯æ‰§è¡Œæ–‡ä»¶åŒ…å«ä¸€ä¸ªâ€˜debug linkâ€™ï¼Œå…¶æŒ‡å®šäº†è°ƒè¯•æ–‡ä»¶çš„åå­—ã€‚é€šå¸¸è°ƒè¯•ä¿¡æ¯æ–‡ä»¶çš„åå­—æ˜¯â€˜executable.debugâ€™ï¼Œå…¶ä¸­ï¼Œâ€˜executableâ€™æ˜¯å¯æ‰§è¡Œæ–‡ä»¶çš„åå­—ï¼ˆä¸åŒ…æ‹¬è·¯å¾„ï¼‰ã€‚å¹¶ä¸”ï¼Œâ€˜debug linkâ€™è¿˜åŒ…å«äº†å¯æ‰§è¡Œæ–‡ä»¶çš„CRC32å€¼ï¼ŒGDBå¯ä»¥åˆ©ç”¨è¯¥å€¼åˆ¤æ–­å¯æ‰§è¡Œæ–‡ä»¶å’Œè°ƒè¯•ä¿¡æ¯æ–‡ä»¶æ˜¯å¦æ¥è‡ªç›¸åŒçš„buildã€‚ å¯æ‰§è¡Œæ–‡ä»¶åŒ…å«ä¸€ä¸ªç‰¹æ®Šçš„å­—ç¬¦ä¸²â€˜build-idâ€™ï¼Œè¯¥å­—ç¬¦ä¸²åŒæ—¶ä¹Ÿå­˜åœ¨äºŽè°ƒè¯•ä¿¡æ¯æ–‡ä»¶ä¸­ã€‚è°ƒè¯•ä¿¡æ¯æ–‡ä»¶çš„åå­—å¯ä»¥é€šè¿‡â€˜build-idâ€™è®¡ç®—å‡ºæ¥ã€‚ å¯¹äºŽä»¥ä¸Šä¸¤ç§ä¸åŒçš„æ–¹å¼ï¼ŒGDBé‡‡ç”¨ä¸¤ç§æ–¹æ³•æŸ¥æ‰¾è°ƒè¯•ä¿¡æ¯æ–‡ä»¶ï¼š å¯¹äºŽâ€˜debug linkâ€™æ–¹å¼ï¼ŒGDBå…ˆåœ¨å¯æ‰§è¡Œæ–‡ä»¶æ‰€åœ¨ç›®å½•æœç´¢æŒ‡å®šåå­—çš„è°ƒè¯•ä¿¡æ¯æ–‡ä»¶ï¼Œç„¶åŽæ˜¯å¯æ‰§è¡Œæ–‡ä»¶æ‰€åœ¨ç›®å½•ä¸­åä¸ºâ€˜.debugâ€™çš„å­ç›®å½•é‡Œæœç´¢ï¼Œæœ€åŽï¼Œåœ¨æ‰€æœ‰å…¨å±€â€˜debug directoryâ€™é‡Œçš„å’Œå¯æ‰§è¡Œæ–‡ä»¶ç»å¯¹ç›®å½•åå­—ä¸€æ ·çš„å­ç›®å½•é‡Œæœç´¢ã€‚ å¯¹äºŽâ€˜build-idâ€™æ–¹å¼ï¼ŒGDBåœ¨æ¯ä¸€ä¸ªå…¨å±€â€˜debug directoryâ€™é‡Œåä¸ºâ€˜build-idâ€™çš„å­ç›®å½•ä¸­æœç´¢åä¸ºâ€˜nn/nnnnnnnn.debugâ€™çš„æ–‡ä»¶ï¼ˆCentOSä¸­è¯¥æ–‡ä»¶æ˜¯ä¸€ä¸ªç¬¦å·é“¾æŽ¥ï¼‰ã€‚ å‡†å¤‡å¥½äº†ä»¥ä¸Šæ–‡ä»¶åŽï¼Œè¿˜éœ€è¦æœ€åŽä¸€ä¸ªå¾ˆé‡è¦çš„æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å®šä¹‰äº†è°ƒè¯•éœ€è¦ç”¨åˆ°çš„GDBå‘½ä»¤ã€‚è¯¥æ–‡ä»¶ä½äºŽ ./usr/lib/debug/usr/lib64/libpython2.7.so.1.0.debug-gdb.py å°†è¯¥æ–‡ä»¶é‡å‘½åä¸ºpython-gdb.pyï¼Œå¹¶å’Œå…¶ä»–æ–‡ä»¶æ”¾ä¸€èµ·ã€‚çŽ°åœ¨gdbç›®å½•çš„ç»“æž„æ˜¯è¿™æ ·çš„ï¼š gdb data-directory usr python-gdb.py å¯åŠ¨gdbåŽéœ€è¦import python-gdb.pyï¼Œä¿®æ”¹PYTHONPATH export PYTHONPATH=&quot;${PYTHONPATH}:${HOME}/gdb&quot; ç„¶åŽå¯åŠ¨gdb ./gdb --data-directory=./data-directory è®¾ç½®debugæ–‡ä»¶æŸ¥æ‰¾ç›®å½•ï¼Œå‘Šè¯‰GDBåŽ»å‡†å¤‡å¥½çš„è§£åŒ…ç›®å½•æ‰¾è°ƒè¯•ä¿¡æ¯ set debug-file-directory ./usr/lib/debug/ è½½å…¥pythonæ¨¡å—ï¼Œè½½å…¥è‡ªå®šä¹‰GDBå‘½ä»¤ python import python-gdb ç„¶åŽattachåˆ°éœ€è¦è°ƒè¯•çš„è¿›ç¨‹å°±å¯ä»¥äº† attach pid Ref MiniDebugInfo Building Python Statically how-i-can-static-build-gdb-from-source How do I extract the contents of an rpm? Debugging Information in Separate Files]]></content>
  </entry>
  <entry>
    <title><![CDATA[MongoDB Data Migration]]></title>
    <url>%2FMongoDB-Data-Migrate%2F</url>
    <content type="text"><![CDATA[MongoDBä½¿ç”¨jsonå’Œbsonï¼ˆbinary jsonï¼‰æ ¼å¼å­˜å‚¨ä¿¡æ¯ã€‚jsonä½¿ç”¨èµ·æ¥éžå¸¸æ–¹ä¾¿ï¼Œä½†æ˜¯å…¶å¹¶ä¸æ”¯æŒbsoné‡Œçš„æ‰€æœ‰æ•°æ®ç±»åž‹ã€‚å¦‚æžœä½¿ç”¨jsonå¤‡ä»½æ•°æ®å°±ä¼šæœ‰ä¿¡æ¯ä¸¢å¤±ã€‚ å¤‡ä»½å’Œæ¢å¤MongoDBæ•°æ®åº“å¯èƒ½ä¼šæ¶ˆè€—å¤§é‡çš„CPUã€å†…å­˜å’Œç£ç›˜èµ„æºï¼Œæœ€å¥½æ˜¯åœ¨éžé«˜å³°æœŸè¿›è¡Œã€‚ éœ€è¦è€ƒè™‘æ•°æ®ä¸€è‡´æ€§çš„é—®é¢˜ã€‚ ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ä¸€è‡´æ€§æ˜¯æŒ‡äº‹åŠ¡ä½¿å¾—ç³»ç»Ÿä»Žä¸€ä¸ªä¸€è‡´çš„çŠ¶æ€è½¬æ¢åˆ°å¦ä¸€ä¸ªä¸€è‡´çŠ¶æ€ã€‚äº‹åŠ¡çš„ä¸€è‡´æ€§å†³å®šäº†ä¸€ä¸ªç³»ç»Ÿè®¾è®¡å’Œå®žçŽ°çš„å¤æ‚åº¦ã€‚äº‹åŠ¡å¯ä»¥ä¸åŒç¨‹åº¦çš„ä¸€è‡´æ€§ï¼šå¼ºä¸€è‡´æ€§ï¼šè¯»æ“ä½œå¯ä»¥ç«‹å³è¯»åˆ°æäº¤çš„æ›´æ–°æ“ä½œã€‚å¼±ä¸€è‡´æ€§ï¼šæäº¤çš„æ›´æ–°æ“ä½œï¼Œä¸ä¸€å®šç«‹å³ä¼šè¢«è¯»æ“ä½œè¯»åˆ°ï¼Œæ­¤ç§æƒ…å†µä¼šå­˜åœ¨ä¸€ä¸ªä¸ä¸€è‡´çª—å£ï¼ŒæŒ‡çš„æ˜¯è¯»æ“ä½œå¯ä»¥è¯»åˆ°æœ€æ–°å€¼çš„ä¸€æ®µæ—¶é—´ã€‚æœ€ç»ˆä¸€è‡´æ€§ï¼šæ˜¯å¼±ä¸€è‡´æ€§çš„ç‰¹ä¾‹ã€‚äº‹åŠ¡æ›´æ–°ä¸€ä»½æ•°æ®ï¼Œæœ€ç»ˆä¸€è‡´æ€§ä¿è¯åœ¨æ²¡æœ‰å…¶ä»–äº‹åŠ¡æ›´æ–°åŒæ ·çš„å€¼çš„è¯ï¼Œæœ€ç»ˆæ‰€æœ‰çš„äº‹åŠ¡éƒ½ä¼šè¯»åˆ°ä¹‹å‰äº‹åŠ¡æ›´æ–°çš„æœ€æ–°å€¼ã€‚å¦‚æžœæ²¡æœ‰é”™è¯¯å‘ç”Ÿï¼Œä¸ä¸€è‡´çª—å£çš„å¤§å°ä¾èµ–äºŽï¼šé€šä¿¡å»¶è¿Ÿï¼Œç³»ç»Ÿè´Ÿè½½ç­‰ã€‚ å…¶ä»–ä¸€è‡´æ€§å˜ä½“è¿˜æœ‰ï¼šå•è°ƒä¸€è‡´æ€§ï¼šå¦‚æžœä¸€ä¸ªè¿›ç¨‹å·²ç»è¯»åˆ°ä¸€ä¸ªå€¼ï¼Œé‚£ä¹ˆåŽç»­ä¸ä¼šè¯»åˆ°æ›´æ—©çš„å€¼ã€‚ä¼šè¯ä¸€è‡´æ€§ï¼šä¿è¯å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨äº¤äº’çš„ä¼šè¯è¿‡ç¨‹ä¸­ï¼Œè¯»æ“ä½œå¯ä»¥è¯»åˆ°æ›´æ–°æ“ä½œåŽçš„æœ€æ–°å€¼ã€‚ copydb &amp; clone Concurrency copydb and clone do not produce point-in-time snapshots of the source database. Write traffic to the source or destination database during the copy process will result in divergent data sets. copydb does not lock the destination server during its operation, so the copy will occasionally yield to allow other operations to complete. clone does not snapshot the database. If any clients update the database youâ€™re copying at any point during the clone operation, the resulting database may be inconsistent. æœ‰æ•°æ®ä¸€è‡´æ€§çš„é—®é¢˜ã€‚ mongodump &amp; mongorestore ä»¥bsonæ ¼å¼ä¿å­˜ï¼Œæ¢å¤å®ŒæˆåŽå¿…é¡»é‡å»ºç´¢å¼•ã€‚ å¯¹äºŽå°åž‹çš„æ•°æ®åº“æ˜¯ç®€å•é«˜æ•ˆçš„å¤‡ä»½æ¢å¤å·¥å…·ï¼Œä½†æ˜¯å¯¹äºŽå¤§åž‹ç³»ç»Ÿä¸æ˜¯ä¸€ä¸ªç†æƒ³çš„é€‰æ‹©ã€‚ mongodumpä¼šæ˜¾è‘—å½±å“MongoDBçš„æ€§èƒ½ã€‚å¦‚æžœæ•°æ®åº“å¤§å°è¶…è¿‡ç³»ç»Ÿå†…å­˜ï¼Œæœ‰å¯èƒ½å‡ºçŽ°å†…å­˜ä¸è¶³å’Œé¡µé”™è¯¯ã€‚ without â€“oplogï¼Œ if there are write operations during the dump operation, the dump will not reflect a single moment in time. Changes made to the database during the update process can affect the output of the backup. ä½¿ç”¨oplogå¯ä»¥ä¿è¯æ•°æ®ä¸€è‡´æ€§ master &amp; slaveslaveæŠŠmasterçš„æ•°æ®ä¿å­˜åœ¨äº†local.sources collectionã€‚è¿ç§»å®ŒæˆåŽéœ€è¦è¿›ä¸€æ­¥å¤„ç†ã€‚æœ¬è´¨ä¸Šä¹Ÿæ˜¯åˆ©ç”¨äº†oplog, å¯ä»¥ä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚ Replication Setç›¸å½“äºŽå¢žå¼ºçš„master slaveæ¨¡å¼ï¼Œå¸¦æœ‰failoveræœºåˆ¶ï¼Œå¤šä¸ªèŠ‚ç‚¹é€‰å–ä¸€ä¸ªä¸ºä¸»èŠ‚ç‚¹ï¼Œå…¶ä»–ä¸ºæ¬¡èŠ‚ç‚¹ï¼Œä¸»èŠ‚ç‚¹å¯è¯»å†™ï¼Œæ¬¡èŠ‚ç‚¹åªèƒ½è¯»ï¼Œå½“ä¸»èŠ‚ç‚¹æŒ‚æŽ‰ä¼šè‡ªåŠ¨é€‰ä¸¾æ–°çš„ä¸»èŠ‚ç‚¹ï¼Œæ–¹ä¾¿åŠ å…¥æ–°çš„æ¬¡èŠ‚ç‚¹ï¼Œæ‰©å±•æ•°æ®åº“ç³»ç»Ÿï¼Œæœ¬è´¨ä¸Šä¹Ÿæ˜¯åˆ©ç”¨äº†oplog, å¯ä»¥ä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚ æ€»ç»“copydb &amp; clone æœ‰æ•°æ®ä¸€è‡´æ€§é—®é¢˜ä¸è€ƒè™‘ä½¿ç”¨ã€‚master &amp; slaveæ¨¡å¼ï¼ŒslaveåŽç»­è¿˜éœ€è¦è¿›ä¸€æ­¥æ“ä½œï¼Œå¹¶ä¸”å®˜æ–¹å·²ä¸æŽ¨èéƒ¨ç½²æ­¤æ¨¡å¼ã€‚Replication Setæä¾›äº†å¾ˆå¤šé«˜çº§ç‰¹æ€§ï¼Œæ˜¯å®˜æ–¹çŽ°åœ¨æŽ¨èçš„éƒ¨ç½²æ¨¡å¼ã€‚å¤„ç†æ•°æ®è¿ç§»æ—¶ï¼Œmaster &amp; slaveå’ŒReplication Setæ¯”è¾ƒæŽ¥è¿‘ï¼Œå‰è€…éœ€è¦è¿›ä¸€æ­¥å¤„ç†ï¼ŒåŽè€…é…ç½®ç•¥éº»çƒ¦ï¼Œéƒ½ç›¸å½“äºŽè‡ªåŠ¨mongodump + oplogreplayï¼Œåœ¨æ•°æ®ä¸æ˜¯å¾ˆå¤§çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥é…ç½®ä¸€ä¸ªå•èŠ‚ç‚¹çš„Replication Seté…åˆmongodump with oplogæ¯”è¾ƒåˆé€‚ã€‚ oplogæœ‰ä¸€ä¸ªéžå¸¸é‡è¦çš„ç‰¹æ€§â€”â€”å¹‚ç­‰æ€§ï¼ˆidempotentï¼‰ã€‚å³å¯¹ä¸€ä¸ªæ•°æ®é›†åˆï¼Œä½¿ç”¨oplogä¸­è®°å½•çš„æ“ä½œé‡æ”¾æ—¶ï¼Œæ— è®ºè¢«é‡æ”¾å¤šå°‘æ¬¡ï¼Œå…¶ç»“æžœæ˜¯ä¸€æ ·çš„ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œå¦‚æžœoplogä¸­è®°å½•çš„æ˜¯ä¸€ä¸ªæ’å…¥æ“ä½œï¼Œå¹¶ä¸ä¼šå› ä¸ºä½ é‡æ”¾äº†ä¸¤æ¬¡ï¼Œæ•°æ®åº“ä¸­å°±å¾—åˆ°ä¸¤æ¡ç›¸åŒçš„è®°å½•ã€‚ è¿˜æœ‰ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿæä¾›çš„å¿«ç…§åŠŸèƒ½ï¼Œæ¯”å¦‚LVMã€‚ Ref How To Back Up, Restore, and Migrate a MongoDB Database on Ubuntu 14.04 Migrating MongoDB instances with no down-time MongoDB Clone MongoDB Copydb MongoDB Replication Master Slave Replication]]></content>
  </entry>
  <entry>
    <title><![CDATA[Inverted Index in the Luence]]></title>
    <url>%2FInverted-Index-in-the-Luence%2F</url>
    <content type="text"><![CDATA[å‡è®¾æœ‰ä¸€æœ¬ä¹¦ï¼Œå‰é¢æœ‰ç›®å½•ï¼Œä¸­é—´æ˜¯æ­£æ–‡ï¼Œæœ€åŽä¼šæœ‰é™„å½•ã€‚æœ‰è¿™æ ·ä¸€ç§é™„å½•ï¼Œå®ƒä¼šæŠŠæ­£æ–‡ä¸­å‡ºçŽ°çš„å…³é”®åè¯åˆ—å‡ºæ¥ï¼Œå¹¶é™„ä¸Šæ­£æ–‡ä¸­å‡ºçŽ°çš„é¡µç ã€‚å½“æˆ‘ä»¬æƒ³æ‰¾æŸä¸ªæœ¯è¯­çš„ç›¸å…³ä¿¡æ¯æ—¶ï¼ŒåŽ»é™„å½•é‡ŒæŸ¥æ­£æ–‡å‡ºçŽ°çš„é¡µç æ˜¾ç„¶æ–¹ä¾¿äº›ã€‚ç›®å½•ç±»ä¼¼äºŽæˆ‘ä»¬å¸¸è§„çš„ç´¢å¼•ï¼Œä¸€ä¸ªç« èŠ‚/æ–‡ä»¶é‡Œæœ‰ä»€ä¹ˆå†…å®¹ï¼›é™„å½•ä¿å­˜çš„ä¿¡æ¯å’Œå®ƒç›¸åï¼Œè¿™ä¸ªä¿¡æ¯å‡ºçŽ°åœ¨å“ªäº›ç« èŠ‚/æ–‡ä»¶é‡Œã€‚æˆ‘ä»¬ç§°é™„å½•è¿™ç§æ•°æ®çš„ç´¢å¼•æ–¹å¼å«åšâ€œInverted Indexâ€ï¼Œä¸­æ–‡ä¸€èˆ¬ç¿»è¯‘ä¸ºâ€œå€’æŽ’ç´¢å¼•â€ã€‚ è¿™ç§æ•°æ®ç»“æž„æ˜¯æœç´¢ç¨‹åºçš„æ ¸å¿ƒæ•°æ®ç»“æž„ï¼Œå®ƒæœ¬èº«å¹¶ä¸å¤æ‚ï¼Œå¾ˆå®¹æ˜“ç†è§£ï¼Œç½‘ä¸Šçš„è§£é‡Šä¹Ÿå¾ˆå¤šï¼Œå…·ä½“å¯ä»¥å‚è€ƒç»´åŸºç™¾ç§‘ã€‚å› ä¸ºæœ€è¿‘æŽ¥è§¦ElasticSearchï¼Œæ¯”è¾ƒå¥½å¥‡å®ƒçš„å€’æŽ’ç´¢å¼•æ˜¯æ€Žä¹ˆå®žçŽ°çš„ã€‚ ElasticSearchæ˜¯ä¸€ä¸ªåŸºäºŽLuceneçš„å…¨æ–‡æœç´¢å¼•æ“Žã€‚Luceneæä¾›äº†æœç´¢çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œç»´æŠ¤å€’æŽ’ç´¢å¼•æ˜¯å…¶ä¸­çš„åŠŸèƒ½ä¹‹ä¸€ã€‚ Luenceçš„å€’æŽ’ç´¢å¼•æ˜¯ç”±è®¸å¤šå­ç‰‡æ®µç»„æˆçš„ã€‚æ¯ä¸€ä¸ªå­ç‰‡æ®µæ˜¯ä¸€ä¸ªå®Œæ•´çš„èƒ½ç‹¬ç«‹å·¥ä½œçš„å­ç´¢å¼•ï¼Œç”±å‡ ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ç»„æˆã€‚å½“æœ‰æ–°çš„æ–‡æ¡£éœ€è¦è¢«ç´¢å¼•æ—¶ï¼Œä¼šæ–°å»ºå­ç´¢å¼•ï¼Œå½“æœ‰æ–‡æ¡£è¢«åˆ é™¤æ—¶ï¼Œå¹¶ä¸ä¼šåˆ é™¤å¯¹åº”çš„ç´¢å¼•æ•°æ®ï¼Œè€Œæ˜¯åšæ ‡è®°ï¼Œè®°å½•è¿™äº›æ•°æ®å·²ç»å¤±æ•ˆäº†ã€‚å­ç´¢å¼•æ•°æ®çš„åˆå¹¶å’Œåˆ é™¤ä¼šåœ¨æŸä¸€æ—¶é—´ç»Ÿä¸€æ‰§è¡Œã€‚ Luenceé‡Œå¯¹æ•°æ®çš„åŸºæœ¬å®šä¹‰æ˜¯è¿™æ ·çš„ï¼š The fundamental concepts in Lucene are index, document, field and term. An index contains a sequence of documents. A document is a sequence of fields. A field is a named sequence of terms. A term is a sequence of bytes. The same sequence of bytes in two different fields is considered a different term. Thus terms are represented as a pair: the string naming the field, and the bytes within the field. æ‰€æœ‰è¿™äº›ä¿¡æ¯éƒ½è¢«ä¿å­˜åˆ°å‡ ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶é‡Œã€‚Luceneä¸ºäº†å‡å°‘æ•°æ®çš„å¤§å°ï¼Œå¯¹æ•°æ®é‡‡ç”¨äº†bit packingçš„åŽ‹ç¼©æ–¹æ³•ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œä¸€ä¸ªå­—èŠ‚å¯ä»¥è¡¨ç¤º0ï½ž127çš„æ— ç¬¦å·æ•°ï¼Œä½†æ˜¯å¦‚æžœæˆ‘ä»¬çš„æ•°æ®ç¡®å®šæœ€å¤§ä¸ä¼šè¶…è¿‡63ï¼Œé‚£å°±å¯ä»¥åªç”¨4ä½æ¥è¡¨ç¤ºï¼Œè¿™æ ·å°±çœåŽ»äº†ä¸€åŠçš„ç©ºé—´ã€‚ç±»ä¼¼çš„æ–¹æ³•è¿˜æœ‰ZigZagç¼–ç ã€‚è¿™éƒ¨åˆ†å®žçŽ°å¯¹åº”ä»£ç org.apache.lucene.util.packedã€‚ ä¸ºäº†æé«˜æœç´¢æ•ˆçŽ‡ï¼ŒLuceneåº•å±‚æŸ¥æ‰¾Term Dictionary(è®°å½•äº†termåœ¨æ–‡æ¡£ä¸­çš„ä½ç½®ä¿¡æ¯)æ—¶ä½¿ç”¨äº†è·³è·ƒé“¾è¡¨çš„æ•°æ®ç»“æž„ã€‚å®ƒç›¸å¯¹äºŽå¹³è¡¡äºŒå‰æ ‘ç®€å•ï¼Œä½†æ˜¯ä¹Ÿæœ‰ä¸é”™çš„æ€§èƒ½ï¼ŒRediesä¸­ä¹Ÿæœ‰ç”¨åˆ°ã€‚ Ref What is in a Lucene index Exploring Solr Internals : The Lucene Inverted Index Lucene file format How fast is bit packing è·³è·ƒé“¾è¡¨ ZigZag in ProtoBuffers]]></content>
  </entry>
  <entry>
    <title><![CDATA[Valgrindå·¥ä½œåŽŸç†ç®€ä»‹]]></title>
    <url>%2Fhow-valgrind-work%2F</url>
    <content type="text"><![CDATA[Valgrindæ˜¯ä¸€æ¬¾ç”¨äºŽæž„å»ºå†…å­˜è°ƒè¯•ã€å†…å­˜æ³„éœ²æ£€æµ‹ä»¥åŠæ€§èƒ½åˆ†æžçš„è½¯ä»¶å¼€å‘æ¡†æž¶ï¼Œå®ƒæ˜¯ä¸€ä¸ªç”±æ¥è‡ªå…¨ä¸–ç•Œçš„å¼€å‘è€…ç»„ç»‡åˆä½œå¼€å‘å¾—åˆ°çš„å¼€æºè½¯ä»¶ã€‚ä»–çš„åˆå§‹ä½œè€…Julian Sewardåœ¨2006å¹´èŽ·å¾—ç¬¬äºŒå±ŠGoogle-Oâ€™Reillyå¼€æºä»£ç å¥–ã€‚Valgrindè¿™ä¸ªåå­—å–è‡ªåŒ—æ¬§ç¥žè¯ä¸­è‹±çµæ®¿çš„å…¥å£ã€‚ å®˜æ–¹é¦–é¡µä¸Šè¿™ä¸ªéª‘å£«ä¸Žæ¶é¾™çš„ç»˜ç”»ç”±ä¼¦æ•¦ç”»å®¶ Rupert Lees åˆ›ä½œã€‚çµæ„Ÿæ¥è‡ªäºŽç¥žè¯ä¼ è¯´ St George and the Dragon ã€‚æŸæ—¥ï¼Œåœ£ä¹”æ²»åˆ°åˆ©æ¯”äºšåŽ»ï¼Œå½“åœ°æ²¼æ³½ä¸­çš„ä¸€åªæ¶é¾™ï¼ˆä¸€è¯´é³„é±¼ï¼‰åœ¨æ°´æ³‰æ—è¾¹ç­‘å·¢ï¼Œè¿™æ°´æ³‰æ˜¯SileneåŸŽå”¯ä¸€çš„æ°´æºï¼Œå¸‚æ°‘ä¸ºäº†å–æ°´ï¼Œæ¯å¤©éƒ½è¦æŠŠä¸¤å¤´ç»µç¾ŠçŒ®ç¥­ç»™æ¶é¾™ã€‚ åˆ°åŽæ¥ï¼Œç»µç¾Šéƒ½åƒå®Œäº†ï¼Œåªå¥½ç”¨æ´»äººæ¥æ›¿ä»£ï¼Œæ¯å¤©æŠ½ç­¾å†³å®šä½•äººåº”é€‰æ´¾ä½œç‰ºç‰²ã€‚ æœ‰ä¸€å¤©ï¼Œå›½çŽ‹çš„å¥³å„¿è¢«æŠ½ä¸­ï¼Œå›½çŽ‹ä¹Ÿæ²¡æœ‰åŠžæ³•ï¼Œæ‚²ç—›æ¬²ç»ã€‚å½“å°‘å¥³èµ°è¿‘ï¼Œæ­£è¦è¢«æ¶é¾™åžåƒæ—¶ï¼Œåœ£ä¹”æ²»åœ¨è¿™æ—¶èµ¶åˆ°ï¼Œæèµ·åˆ©çŸ›å¯¹æŠ—æ¶é¾™ï¼Œå¹¶ç”¨è…°å¸¦æŠŠå®ƒæŸç¼šä½ï¼Œç‰µåˆ°åŸŽé‡Œå½“ä¼—æ€æ­»ï¼Œæ•‘å‡ºäº†å…¬ä¸»ã€‚ åœ¨è½¯ä»¶å¼€å‘è¿‡ç¨‹ä¸­æˆ‘ä»¬æœ‰æ—¶éœ€è¦è¿½è¸ªç¨‹åºæ‰§è¡Œã€è¯Šæ–­é”™è¯¯ã€è¡¡é‡æ€§èƒ½ç­‰éœ€æ±‚ã€‚å¦‚æžœæœ‰æºä»£ç çš„è¯å¯ä»¥æ·»åŠ ç›¸åº”ä»£ç ï¼Œæ²¡æœ‰æºä»£ç æ—¶è¿™ä¸ªæ–¹æ³•å°±è¡Œä¸é€šäº†ã€‚å‰è€…å¯ä»¥å¯¹æºä»£ç åˆ†æžï¼ŒåŽè€…åªèƒ½åˆ†æžäºŒè¿›åˆ¶äº†ã€‚æˆ‘çš„ç†è§£æ˜¯ï¼Œdynamic Binary Instrumentation (DBI)å¼ºè°ƒå¯¹äºŒè¿›åˆ¶æ‰§è¡Œæ–‡ä»¶çš„è¿½è¸ªä¸Žä¿¡æ¯æ”¶é›†ï¼Œdynamic Binary Analysis (DBA)å¼ºè°ƒå¯¹æ”¶é›†ä¿¡æ¯çš„åˆ†æžï¼Œvalgrindæ˜¯ä¸€ä¸ªDBIæ¡†æž¶ï¼Œä½¿ç”¨å®ƒå¯ä»¥å¾ˆæ–¹ä¾¿æž„å»ºä¸€ä¸ªDBAå·¥å…·ã€‚ Valgrindä½œè€…è®¤ä¸ºå½“æ—¶çš„DBIæ¡†æž¶éƒ½æŠŠæ³¨æ„åŠ›æ”¾åœ¨äº†æ€§èƒ½æ£€æµ‹ä¸Šï¼Œå¯¹ç¨‹åºçš„è´¨é‡(åŽŸæ–‡capabilities)å¹¶æ²¡æœ‰å¤ªæ³¨æ„ã€‚æ‰€ä»¥è®¾è®¡äº†ä¸€ä¸ªæ–°çš„DBIæ¡†æž¶ï¼Œç›®æ ‡æ˜¯å¯ä»¥ä½¿ç”¨å®ƒå¼€å‘é‡åž‹DBAå·¥å…·ã€‚ Valgrindçš„é‡ç‚¹æ˜¯shadow valuesæŠ€æœ¯ï¼Œè¯¥æŠ€æœ¯è¦æ±‚å¯¹æ‰€æœ‰çš„å¯„å­˜å™¨å’Œä½¿ç”¨åˆ°çš„å†…å­˜åšshadowï¼ˆè‡ªå·±ç»´æŠ¤ä¸€ä»½ï¼‰ã€‚å› æ­¤ä½¿ç”¨valgrindå¼€å‘å‡ºæ¥çš„å·¥å…·ä¸€èˆ¬è·‘çš„éƒ½æ¯”è¾ƒæ…¢ã€‚ä¸ºäº†å®žçŽ°shadow valueséœ€è¦æ¡†æž¶å®žçŽ°ä»¥ä¸‹4ä¸ªéƒ¨åˆ†ï¼š Shadow State æä¾› shadow registers (ä¾‹å¦‚ integerã€FPã€SIMD) æä¾› shadow memory è¯»å†™æ“ä½œ 9ä¸ªå…·ä½“åŠŸèƒ½: instrument read/write instructions instrument read/write system calls Allocation and deallocation operations instrument start-up allocations instrument system call (de)allocations instrument stack (de)allocations instrument heap (de)allocations Transparent execution, but with extra output extra output æ ¸å¿ƒæ€æƒ³å°±æ˜¯è¦æŠŠå¯„å­˜å™¨å’Œå†…å­˜ä¸­çš„ä¸œè¥¿è‡ªå·±ç»´æŠ¤ä¸€ä»½ï¼Œå¹¶ä¸”åœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½å¯ä»¥å®‰å…¨æ­£ç¡®åœ°ä½¿ç”¨ï¼ŒåŒæ—¶è®°å½•ç¨‹åºçš„æ‰€æœ‰æ“ä½œï¼Œåœ¨ä¸å½±å“ç¨‹åºæ‰§è¡Œç»“æžœå‰æä¸‹ï¼Œè¾“å‡ºæœ‰ç”¨çš„ä¿¡æ¯ã€‚ä½¿ç”¨shadow valuesæŠ€æœ¯çš„DBIæ¡†æž¶éƒ½ä½¿ç”¨ä¸åŒæ–¹å¼å®žçŽ°äº†ä¸Šè¿°å…¨éƒ¨åŠŸèƒ½æˆ–éƒ¨åˆ†åŠŸèƒ½ã€‚ valgrindç»“æž„ä¸Šåˆ†ä¸ºcoreå’Œtoolï¼Œä¸åŒçš„toolå…·æœ‰ä¸åŒçš„åŠŸèƒ½ã€‚æ¯”è¾ƒç‰¹åˆ«çš„æ˜¯ï¼Œvalgrind tooléƒ½åŒ…å«coreçš„é™æ€é“¾æŽ¥ï¼Œè™½ç„¶æœ‰ç‚¹æµªè´¹ç©ºé—´ï¼Œä½†å¯ä»¥ç®€åŒ–æŸäº›äº‹æƒ…ã€‚å½“æˆ‘ä»¬åœ¨è°ƒç”¨valgrindæ—¶ï¼Œå®žé™…ä¸Šå¯åŠ¨çš„åªæ˜¯ä¸€ä¸ªè§£æžå‘½ä»¤å‚æ•°çš„å¯åŠ¨å™¨ï¼Œç”±è¿™ä¸ªå¯åŠ¨å™¨å¯åŠ¨å…·ä½“çš„toolã€‚ ä¸ºäº†å®žçŽ°ä¸Šè¿°åŠŸèƒ½ï¼Œvalgrindä¼šåˆ©ç”¨dynamic binary re-compilationæŠŠæµ‹è¯•ç¨‹åºï¼ˆclientç¨‹åºï¼‰çš„æœºå™¨ç è§£æžåˆ°VEXä¸­é—´è¯­è¨€ã€‚VEX IRæ˜¯valgrindå¼€å‘è€…ä¸“é—¨è®¾è®¡ç»™DBIä½¿ç”¨çš„ä¸­é—´è¯­è¨€ï¼Œæ˜¯ä¸€ç§RISC likeçš„è¯­è¨€ã€‚ç›®å‰VEX IRä»Žvalgrindåˆ†ç¦»å‡ºåŽ»æˆlibVEXäº†ã€‚libVEXé‡‡ç”¨execution-drivençš„æ–¹å¼ç”¨just-in-timeæŠ€æœ¯åŠ¨æ€åœ°æŠŠæœºå™¨ç è½¬æ¢ä¸ºIRï¼Œå¦‚æžœå‘ç”Ÿäº†æŸäº›toolæ„Ÿå…´è¶£çš„äº‹ä»¶ï¼Œå°±ä¼šhook toolçš„å‡½æ•°ï¼Œtoolä¼šæ’å…¥ä¸€äº›åˆ†æžä»£ç ï¼Œå†æŠŠè¿™äº›ä»£ç è½¬æ¢ä¸ºæœºå™¨ç ï¼Œå­˜å‚¨åˆ°code cacheä¸­ï¼Œä»¥ä¾¿å†éœ€è¦çš„æ—¶å€™æ‰§è¡Œã€‚ Machine Code --&gt; IR --&gt; IR --&gt; Machine Code ^ ^ ^ | | | translate | | | | instrument | | translate valgrindå¯åŠ¨åŽï¼Œcoreã€toolå’Œclientéƒ½åœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œå…±ç”¨ä¸€ä¸ªåœ°å€ç©ºé—´ã€‚coreé¦–å…ˆä¼šåˆå§‹åŒ–å¿…è¦çš„ç»„ä»¶ï¼Œç„¶åŽè½½å…¥clientï¼Œå»ºç«‹clientçš„stackï¼Œå®ŒæˆåŽä¼šè¦æ±‚toolåˆå§‹åŒ–è‡ªå·±ï¼Œtoolå®Œæˆå‰©ä½™éƒ¨åˆ†çš„åˆå§‹åŒ–ï¼Œè¿™æ ·toolå°±å…·æœ‰äº†æŽ§åˆ¶æƒï¼Œå¼€å§‹è½¬æ¢clientç¨‹å¼ã€‚ä»ŽæŸç§æ„ä¹‰ä¸Šè¯´ï¼Œvalgrindæ‰§è¡Œçš„éƒ½æ˜¯åŠ å·¥åŽçš„clientç¨‹åºçš„ä»£ç ã€‚ DBI framework æœ‰ä¸¤ç§åŸºæœ¬çš„æ–¹å¼å¯ä»¥è¡¨ç¤ºcodeå’Œè¿›è¡Œ instrumentationï¼š disassemble-and-resynthesise (D&amp;R)ã€‚Valgrind ä½¿ç”¨è¿™ç§æŠŠmachine codeå…ˆè½¬æˆIRï¼ŒIRä¼šé€šè¿‡åŠ å…¥æ›´IRæ¥instrumentã€‚IRæœ€åŽè½¬å›žmachine codeæ‰§è¡Œï¼ŒåŽŸæœ¬çš„codeå¯¹guest stateçš„æ‰€æœ‰å½±å“éƒ½å¿…é¡»æ˜Žç¡®åœ°è½¬æˆIRï¼Œå› ä¸ºæœ€åŽæ‰§è¡Œçš„æ˜¯çº¯ç²¹ç”±IRè½¬æˆçš„machine codeã€‚ copy-and-annotate (C&amp;A)ã€‚instructionsä¼šè¢«é€å­—åœ°å¤åˆ¶(é™¤äº†ä¸€äº› control flow æ”¹å˜)æ¯ä¸ªinstructionéƒ½åŠ ä¸Šæ³¨è§£æè¿°å…¶å½±å“(annotate)ï¼Œåˆ©ç”¨è¿™äº›æè¿°æ¥å¸®åŠ©åšinstrumentationé€šè¿‡ç»™æ¯æ¡æŒ‡ä»¤æ·»åŠ ä¸€ä¸ªé¢å¤–çš„data structure (DynamoRIO)é€šè¿‡æä¾›ç›¸åº”çš„èŽ·å–æŒ‡ä»¤ç›¸å…³ä¿¡æ¯çš„API (Intel Pin)è¿™äº›æ·»åŠ çš„æ³¨è§£å¯ä»¥æŒ‡å¯¼è¿›è¡Œç›¸åº”çš„instrumentï¼Œå¹¶ä¸”ä¸å½±å“åŽŸæ¥çš„native codeçš„æ‰§è¡Œæ•ˆæžœã€‚ Ref æœ¬æ–‡ä¸»è¦å‚è€ƒäº†å®˜æ–¹çš„ç ”ç©¶è®ºæ–‡ï¼ˆ http://valgrind.org/docs/pubs.html ï¼‰ã€‚]]></content>
  </entry>
</search>
