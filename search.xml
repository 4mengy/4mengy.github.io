<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title><![CDATA[how to write resilient mongodb applications]]></title>
    <url>%2Fhow-to-write-resilient-mongodb-applications%2F</url>
    <content type="text"><![CDATA[å‰è¨€ï¼šæœ¬æ–‡ç¿»è¯‘è‡ªMongoDBå›¢é˜Ÿå·¥ç¨‹å¸ˆA. Jesse Jiryu Davisçš„åšå®¢æ–‡ç« ã€‚æ–‡ç« æè¿°äº†åœ¨é‡åˆ°é”™è¯¯æ—¶å¦‚ä½•å®‰å…¨çš„è¿›è¡Œé‡è¯•ã€‚è™½ç„¶è¿™é¡¹æŠ€æœ¯å·²è¢«MongoDB 3.6çš„æ–°å†…ç½®åŠŸèƒ½Retryable Writeså–ä»£ã€‚ å¯é‡å†™çš„å†™æ“ä½œæ¯”è¿™é‡Œæè¿°çš„æŠ€æœ¯ç®€å•å¾—å¤šã€‚ä½†æ˜¯ä½œè€…è§£å†³é—®é¢˜çš„æ–¹å¼è¿˜æ˜¯èƒ½ç»™æˆ‘ä»¬ä¸€äº›å¯å‘ã€‚ æœ‰ä¸€æ¬¡ï¼Œåœ¨2012å¹´åˆçš„ä¸€ä¸ªå¯’å†¬åˆåŽï¼Œæˆ‘é‡åˆ°äº†ä¸€ä½éžå¸¸ç”Ÿæ°”çš„MongoDBå®¢æˆ·ã€‚ ä»–æ¥åˆ°æˆ‘ä»¬çš„â€œMongoDB Office Hoursâ€åŠžå…¬å®¤ï¼Œä»–æœ‰ä¸€ä¸ªé—®é¢˜ï¼šâ€œæˆ‘æ€Žæ ·æ‰èƒ½ä½¿æˆ‘çš„åº”ç”¨ç¨‹åºåœ¨ç½‘ç»œé”™è¯¯ï¼Œä¸­æ–­å’Œå…¶ä»–å¼‚å¸¸æƒ…å†µä¸‹å…·æœ‰å¼¹æ€§ï¼Ÿæˆ‘å¯ä»¥æ¯æ¬¡é‡è¯•æ“ä½œç›´åˆ°æˆåŠŸï¼Ÿâ€œä»–è¦æ±‚çŸ¥é“ä¸ºä»€ä¹ˆæˆ‘ä»¬æ²¡æœ‰å‘å¸ƒä¸€ä¸ªé€‚ç”¨äºŽæ‰€æœ‰åº”ç”¨ç¨‹åºçš„ç®€å•æ˜Žæ™ºçš„ç­–ç•¥ã€‚ è¿™ä¸ªäººï¼Œæˆ‘ä¼šå«ä»–Ianï¼Œå¾ˆä¸é«˜å…´ï¼Œæˆ‘ä¹Ÿå¸®ä¸äº†ä»–ã€‚æˆ‘çš„å†…ç–šå·²ç»è®©æˆ‘å¿˜è®°äº†é‚£å¤©çš„ç»†èŠ‚ã€‚æˆ‘ä»¬ååœ¨ä¸€é—´æ²¡æœ‰çª—æˆ·çš„æˆ¿é—´é‡Œï¼Œè¿™æ˜¯æˆ‘ä»¬å”¯ä¸€å¯ä»¥åœ¨æˆ‘ä»¬çš„å°åŠžå…¬å®¤èŠå¤©çš„è‡ªç”±ç©ºé—´ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªè®¨åŽŒçš„è§å…‰ç¯ã€‚æˆ‘ä»¬å¹¶æŽ’ååœ¨æ¡Œå­çš„è¾¹ç¼˜ï¼Œå› ä¸ºæˆ¿é—´æ²¡æœ‰æ¤…å­ã€‚åœ¨Iançš„çœ¼ç›ä¸‹æœ‰æ·±æ·±çš„é»‘çœ¼åœˆï¼Œå°±åƒä»–å·²ç»ä¸ºè¿™ä¸ªé—®é¢˜æ‹…å¿ƒäº†ä¸€æ•´æ™šã€‚ â€œæˆ‘å¦‚ä½•ç¼–å†™å¼¹æ€§ä»£ç ï¼Ÿâ€ æˆ‘å”¯ä¸€å¯ä»¥å‘Šè¯‰Iançš„æ˜¯ï¼Œâ€œæˆ‘ä»¬æ— æ³•å‘å¸ƒä¸€ä¸ªç­–ç•¥æ¥å¤„ç†ç½‘ç»œé”™è¯¯å’Œä¸­æ–­ï¼Œå¹¶ä¸ºæ‚¨æŒ‡å‡ºé”™è¯¯ï¼Œå› ä¸ºæˆ‘ä»¬ä¸çŸ¥é“æ‚¨åº”ç”¨ç¨‹åºçš„ç»†èŠ‚ã€‚æ‚¨å¯ä»¥é€‰æ‹©å¾ˆå¤šä¸åŒçš„æ“ä½œæ–¹å¼ï¼Œåœ¨å»¶è¿Ÿå’Œå¯é æ€§ä¹‹é—´åšå‡ºæŠ˜ä¸­ï¼Œä»¥åŠåœ¨ä¸€ä¸ªæ“ä½œè‚¯èƒ½è¢«æ‰§è¡Œä¸¤æ¬¡çš„é£Žé™©ä¸Žå®Œå…¨ä¸åšè¿™ä¸¤è€…ä¹‹é—´è¿›è¡Œæƒè¡¡ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬æ²¡æœ‰å°è¯•å†™å‡ºä¸€ç§â€œä¸€åˆ€åˆ‡â€çš„ç­–ç•¥ã€‚å°±ç®—å¯ä»¥ï¼Œä½†æ˜¯ä¸åŒè¯­è¨€ä¸‹é©±åŠ¨çš„è¡Œä¸ºä¸åŒï¼Œæˆ‘ä»¬å¿…é¡»ä¸ºæ¯ç§è¯­è¨€å‘å¸ƒæŒ‡å—ã€‚â€œ æˆ‘å¯¹æˆ‘çš„å›žç­”å¹¶ä¸æ»¡æ„ï¼ŒIanä¹Ÿä¸€æ ·ã€‚ åœ¨æ­¤åŽçš„å‡ å¹´ä¸­ï¼Œæˆ‘åŠªåŠ›æƒ³å‡ºäº†ä¸€ä¸ªæ›´å¥½çš„ç­”æ¡ˆã€‚é¦–å…ˆæˆ‘å†™äº†æœåŠ¡å‘çŽ°å’Œç›‘æµ‹è§„èŒƒï¼Œæˆ‘ä»¬æ‰€æœ‰çš„é©±åŠ¨ç¨‹åºçŽ°åœ¨å·²ç»å®žçŽ°äº†ã€‚è¯¥è§„èŒƒæžå¤§åœ°æé«˜äº†é©±åŠ¨ç¨‹åºåœ¨é¢å¯¹ç½‘ç»œé”™è¯¯å’ŒæœåŠ¡å™¨æ•…éšœæ—¶çš„é²æ£’æ€§ã€‚åƒIanè¿™æ ·çš„æŠ•è¯‰çŽ°åœ¨æ¯”è¾ƒå°‘è§ï¼Œå› ä¸ºé©±åŠ¨å¾ˆå°‘ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚æ­¤å¤–ï¼Œæ‰€æœ‰é©±åŠ¨ç¨‹åºçŽ°åœ¨éƒ½è¡¨çŽ°ç›¸åŒï¼Œæˆ‘ä»¬ä½¿ç”¨æ ‡å‡†åŒ–çš„é€šç”¨æµ‹è¯•å¥—ä»¶éªŒè¯å…¶è¡Œä¸ºã€‚ å…¶æ¬¡ï¼Œæˆ‘å¼€å‘äº†ä¸€ç§åä¸ºâ€˜Black Pipeâ€™çš„æµ‹è¯•æŠ€æœ¯ï¼Œå› æ­¤Ianå¯ä»¥æµ‹è¯•ä»–çš„ä»£ç åœ¨ä¸ŽMongoDBäº¤äº’æ—¶å¦‚ä½•å“åº”ç½‘ç»œæ•…éšœï¼Œå‘½ä»¤é”™è¯¯æˆ–ä»»ä½•å…¶ä»–äº‹ä»¶ã€‚â€˜Black Pipeâ€™ä½¿ç”¨æ–¹ä¾¿ä¸”å‡†ç¡®;å®ƒä½¿å¾—é”™è¯¯æƒ…å†µå¯é‡çŽ°ä¸”æ˜“äºŽæµ‹è¯•ã€‚ çŽ°åœ¨å¯ä»¥å›žç­”Ianäº†ã€‚å¦‚æžœä»–ä»Šå¤©æ¥åˆ°æˆ‘ä»¬åœ¨æ—¶ä»£å¹¿åœºçš„å¤§åŠžå…¬å®¤ï¼Œä½ ä¼šå¦‚ä½•å›žç­”ä»–ï¼Ÿç¼–å†™å¼¹æ€§MongoDBåº”ç”¨ç¨‹åºçš„ç­–ç•¥æ˜¯ä»€ä¹ˆï¼Ÿ æˆ‘ä»¬ä¼šå‘Šè¯‰Ianï¼Œå¦‚ä½•åšåˆ°è¿™ä¸€ç‚¹ï¼š 123updateOne(&#123;'_id': '2016-06-28'&#125;, &#123;'$inc': &#123;'counter': 1&#125;&#125;, upsert=True) è¯¥æ“ä½œé€šè¿‡åœ¨_idä¸ºä»Šå¤©æ—¥æœŸçš„æ–‡æ¡£ä¸­é€’å¢žåä¸ºâ€œcounterâ€çš„å­—æ®µæ¥è®¡æ•°äº‹ä»¶å‘ç”Ÿçš„æ¬¡æ•°ã€‚å¦‚æžœè¿™æ˜¯ä»Šå¤©çš„ç¬¬ä¸€ä¸ªäº‹ä»¶ï¼Œå‚æ•°â€œupsert = Trueâ€å‘Šè¯‰MongoDBåˆ›å»ºæ–‡æ¡£ã€‚ ä»€ä¹ˆä¼šå‡ºé”™çž¬æ€é”™è¯¯å½“Ianå°†ä»–çš„updateOneæ¶ˆæ¯å‘é€åˆ°MongoDBæ—¶ï¼Œé©±åŠ¨ç¨‹åºå¯èƒ½ä¼šçœ‹åˆ°æ¥è‡ªç½‘ç»œå±‚çš„æš‚æ—¶é”™è¯¯ï¼Œä¾‹å¦‚TCPé‡ç½®æˆ–è¶…æ—¶ã€‚ çž¬æ€ç½‘ç»œé”™è¯¯ï¼Œæ•…éšœè½¬ç§»æˆ–é™çº§é©±åŠ¨ä¸çŸ¥é“æœåŠ¡å™¨æ˜¯å¦æ”¶åˆ°æ¶ˆæ¯ï¼Œæ‰€ä»¥Ianä¸çŸ¥é“ä»–çš„è®¡æ•°å™¨æ˜¯å¦å¢žåŠ ã€‚ è¿˜æœ‰å…¶ä»–çž¬æ€é”™è¯¯çœ‹èµ·æ¥ä¸Žç½‘ç»œæš‚æ—¶æ€§é—®é¢˜ç›¸åŒã€‚å¦‚æžœprimaryèŠ‚ç‚¹å‡ºçŽ°æ•…éšœï¼Œä¸‹æ¬¡å°è¯•å‘å…¶å‘é€æ¶ˆæ¯æ—¶ï¼Œé©±åŠ¨ç¨‹åºä¼šæ”¶åˆ°ç½‘ç»œé”™è¯¯ã€‚è¿™ä¸ªé”™è¯¯å¾ˆç®€çŸ­ï¼Œå› ä¸ºå‰¯æœ¬é›†ä¼šåœ¨å‡ ç§’é’Ÿå†…é€‰å‡ºä¸€ä¸ªæ–°çš„primaryèŠ‚ç‚¹ã€‚åŒæ ·ï¼Œå¦‚æžœprimaryæœåŠ¡å™¨é€€å‡ºï¼ˆå®ƒä»ç„¶æ­£å¸¸å·¥ä½œï¼Œä½†å·²ç»è¾žåŽ»å…¶primaryè§’è‰²ï¼‰ï¼Œå®ƒå°†å…³é—­æ‰€æœ‰è¿žæŽ¥ã€‚ä¸‹æ¬¡é©±åŠ¨ç¨‹åºå‘æœåŠ¡å™¨å‘é€æ¶ˆæ¯æ—¶ï¼Œå®ƒè®¤ä¸ºå®ƒæ˜¯primaryèŠ‚ç‚¹ï¼Œå®ƒä¼šä»ŽæœåŠ¡å™¨æ”¶åˆ°ç½‘ç»œé”™è¯¯æˆ–â€œnot masterâ€å›žå¤ã€‚ åœ¨æ‰€æœ‰æƒ…å†µä¸‹ï¼Œé©±åŠ¨ç¨‹åºéƒ½ä¼šå‘Iançš„åº”ç”¨ç¨‹åºæŠ›å‡ºè¿žæŽ¥é”™è¯¯ã€‚ æŒç»­çš„é”™è¯¯ä¹Ÿå¯èƒ½å­˜åœ¨æŒç»­çš„ç½‘ç»œä¸­æ–­ã€‚å½“é©±åŠ¨ç¨‹åºé¦–æ¬¡æ£€æµ‹åˆ°æ­¤é—®é¢˜æ—¶ï¼Œå®ƒçœ‹èµ·æ¥åƒä¸€ä¸ªæš‚æ—¶æ€§é—®é¢˜ï¼šé©±åŠ¨ç¨‹åºå‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œä½†æ˜¯æ— æ³•è¯»å–å“åº”ã€‚ Persistent Network Outage æŒç»­çš„ç½‘ç»œä¸­æ–­Ianå†ä¸€æ¬¡æ— æ³•åˆ†è¾¨æœåŠ¡å™¨æ˜¯å¦æŽ¥æ”¶åˆ°æ¶ˆæ¯å¹¶é€’å¢žè®¡æ•°å™¨ã€‚ ç½‘è·¯ä¸­æ–­ä¸Žç½‘ç»œæš‚æ—¶æ€§é—®é¢˜çš„åŒºåˆ«æ˜¯Ianè¯•å›¾å†æ¬¡æ“ä½œåªä¼šå¾—åˆ°å¦ä¸€ä¸ªç½‘ç»œé”™è¯¯ã€‚ä½†æ˜¯åªæœ‰ä»–å°è¯•åŽæ‰çŸ¥é“ã€‚ å‘½ä»¤é”™è¯¯å½“é©±åŠ¨ç¨‹åºå‘é€æ¶ˆæ¯æ—¶ï¼ŒMongoDBå¯èƒ½ä¼šè¿”å›žä¸€ä¸ªç‰¹å®šçš„é”™è¯¯ï¼Œè¡¨ç¤ºå·²æ”¶åˆ°å‘½ä»¤ä½†æ— æ³•æ‰§è¡Œã€‚ä¹Ÿè®¸å‘½ä»¤æ ¼å¼ä¸æ­£ç¡®ï¼ŒæœåŠ¡å™¨ç£ç›˜ç©ºé—´ä¸è¶³ï¼Œæˆ–Iançš„åº”ç”¨ç¨‹åºæœªè¢«æŽˆæƒã€‚ æ‰€ä»¥ï¼Œæœ‰ä¸‰ä¸ªä¸èƒ½å®Œå…¨å¯åŒºåˆ†çš„é”™è¯¯ï¼Œéœ€è¦Iançš„ä»£ç æœ‰ä¸åŒå›žåº”ã€‚ä½ ä¼šç»™Ianä»€ä¹ˆæ ·çš„ç­–ç•¥æ¥ä½¿ä»–çš„åº”ç”¨å…·æœ‰å¼¹æ€§ï¼Ÿ æ˜¯å› ä¸ºæˆ‘ä»¬æ²¡æœ‰äº‹åŠ¡å—ï¼Ÿæ‚¨å¯èƒ½æƒ³çŸ¥é“è¿™æ˜¯å¦æ˜¯åªæœ‰MongoDBæ‰æœ‰çš„é—®é¢˜ï¼Œå› ä¸ºå®ƒæ²¡æœ‰äº‹åŠ¡ã€‚å‡è®¾Ianä½¿ç”¨äº†ä¼ ç»Ÿçš„SQLæœåŠ¡å™¨ã€‚ä»–æ‰“å¼€ä¸€ä¸ªäº‹åŠ¡ï¼Œæ›´æ–°ä¸€è¡Œï¼Œå¹¶å‘é€COMMITæ¶ˆæ¯ã€‚ç„¶åŽæœ‰ä¸€ä¸ªç½‘ç»œä¸´æ—¶æ€§é”™è¯¯ã€‚ä»–æ— æ³•ä»ŽæœåŠ¡å™¨è¯»å–ç¡®è®¤æ¶ˆæ¯ã€‚ä»–çŸ¥é“äº¤æ˜“æ˜¯å¦å·²ç»å®žæ–½å—ï¼Ÿ ä¿è¯æ“ä½œåªæ‰§è¡Œä¸€æ¬¡ï¼Œä½¿ç”¨SQLæœåŠ¡å™¨ä¸Žä½¿ç”¨éžäº‹åŠ¡æ€§æœåŠ¡å™¨ï¼ˆå¦‚MongoDBï¼‰é¢ä¸´çš„é—®é¢˜ç›¸åŒã€‚ MongoDBé©±åŠ¨ç¨‹åºå¦‚ä½•å¤„ç†é”™è¯¯ï¼Ÿä¸ºäº†åˆ¶å®šæ‚¨çš„ç­–ç•¥ï¼Œæ‚¨éœ€è¦çŸ¥é“MongoDBé©±åŠ¨ç¨‹åºè‡ªå·±å¦‚ä½•å“åº”ä¸åŒç±»åž‹çš„é”™è¯¯ã€‚ æœåŠ¡å™¨å‘çŽ°å’Œç›‘æµ‹è§„èŒƒè¦æ±‚MongoDBé©±åŠ¨ç¨‹åºè·Ÿè¸ªæ¯ä¸ªè¿žæŽ¥åˆ°çš„æœåŠ¡å™¨çš„çŠ¶æ€ã€‚ä¾‹å¦‚ï¼Œå®ƒå¯èƒ½æ˜¯ä¸€ä¸ª3èŠ‚ç‚¹å‰¯æœ¬é›†ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š Server 1: Primary Server 2: Secondary Server 3: Secondary è¿™ä¸ªæ•°æ®ç»“æž„è¢«ç§°ä¸ºâ€œæ‹“æ‰‘æè¿°â€ã€‚å¦‚æžœåœ¨ä¸ŽæœåŠ¡å™¨äº¤è°ˆæ—¶å‡ºçŽ°ç½‘ç»œé”™è¯¯ï¼Œé©±åŠ¨ç¨‹åºä¼šå°†è¯¥æœåŠ¡å™¨çš„ç±»åž‹è®¾ç½®ä¸ºâ€œæœªçŸ¥â€ï¼Œç„¶åŽå¼•å‘å¼‚å¸¸ã€‚çŽ°åœ¨æ‹“æ‰‘æè¿°æ˜¯ï¼š Server 1: Unknown Server 2: Secondary Server 3: Secondary Ianå°è¯•çš„æ“ä½œä¸ä¼šè‡ªåŠ¨é‡è¯•; ç„¶è€Œï¼Œä¸‹ä¸€ä¸ªæ“ä½œä¼šè¢«é˜»å¡žï¼Œå› ä¸ºé©±åŠ¨ç¨‹åºæ­£åœ¨é‡æ–°å‘çŽ°ä¸»é©±åŠ¨å™¨ã€‚å®ƒæ¯ç§’é‡æ–°æ£€æŸ¥æ¯å°æœåŠ¡å™¨ä¸¤æ¬¡ï¼Œæœ€å¤šæŒç»­30ç§’ï¼Œç›´åˆ°é‡æ–°è¿žæŽ¥åˆ°ä¸»æœåŠ¡å™¨æˆ–æ£€æµ‹åˆ°æ–°ä¸»æœåŠ¡å™¨è¢«é€‰ä¸­ã€‚çŽ°åœ¨MongoDBçš„é€‰ä¸¾åªéœ€è¦ä¸€ä¸¤ç§’é’Ÿï¼Œç„¶åŽé©±åŠ¨ç¨‹åºåœ¨æ­¤ä¹‹åŽå¤§çº¦åŠç§’ä¼šæ”¶åˆ°é€‰ä¸¾ç»“æžœã€‚ å¦ä¸€æ–¹é¢ï¼Œå¦‚æžœç½‘ç»œæŒç»­ä¸­æ–­ï¼Œåˆ™åœ¨30ç§’ä¹‹åŽï¼Œé©±åŠ¨ç¨‹åºä¼šæŠ›å‡ºâ€œserver selection timeoutâ€ã€‚ åœ¨å‘½ä»¤é”™è¯¯çš„æƒ…å†µä¸‹ï¼Œé©±åŠ¨ç¨‹åºå¯¹æœåŠ¡å™¨çš„çœ‹æ³•æ²¡æœ‰æ”¹å˜ï¼šå¦‚æžœæœåŠ¡å™¨æ˜¯primaryæˆ–secondaryï¼Œå®ƒä»ç„¶æ˜¯ã€‚å› æ­¤ï¼Œé©±åŠ¨ç¨‹åºä¸ä¼šåœ¨æ‹“æ‰‘æè¿°ä¸­æ›´æ”¹æœåŠ¡å™¨çš„çŠ¶æ€ï¼Œåªä¼šå¼•å‘å¼‚å¸¸ã€‚ ï¼ˆè¦äº†è§£æœ‰å…³æœåŠ¡å™¨å‘çŽ°å’Œç›‘æµ‹è§„èŒƒçš„æ›´å¤šä¿¡æ¯ï¼Œè¯·é˜…è¯»æˆ‘çš„æ–‡ç« PyMongoï¼ŒPerlå’ŒCä¸­çš„æœåŠ¡å™¨å‘çŽ°å’Œç›‘æŽ§ï¼Œæˆ–è§‚çœ‹MongoDB World 2015ä¸Šçš„æ¼”è®²ï¼ŒMongoDBé©±åŠ¨ç¨‹åºå’Œé«˜å¯ç”¨æ€§ï¼šæ·±åº¦åˆ†æžã€‚åœ¨é‚£é‡Œæˆ‘è¯¦ç»†è®¨è®ºäº†è§„èŒƒä¸­æè¿°çš„æ•°æ®ç»“æž„ä»¥åŠè§„èŒƒå¦‚ä½•å‘Šè¯‰é©±åŠ¨ç¨‹åºå¯¹é”™è¯¯åšå‡ºååº”ï¼Œè¿™æ˜¯æœ¬æ–‡å…³äºŽå¼¹æ€§åº”ç”¨ç¨‹åºçš„ä¸€ä¸ªå¾ˆå¥½çš„èƒŒæ™¯ã€‚ï¼‰ é”™è¯¯çš„é‡è¯•ç­–ç•¥æˆ‘è§è¿‡ä¸€äº›ã€‚ ä¸è¦é‡è¯•é»˜è®¤æ˜¯æ ¹æœ¬ä¸é‡è¯•ã€‚è¿™ç§ç­–ç•¥åœ¨é‡åˆ°å‰é¢æè¿°çš„ä¸‰ç§é”™è¯¯æƒ…å†µæ—¶å¯èƒ½ä¼šå¤±è´¥ã€‚ çž¬æ€ç½‘ç»œé”™è¯¯ æŒç»­ä¸­æ–­ å‘½ä»¤é”™è¯¯ å¯èƒ½è®¡æ•°ä¸¢å¤± æ­£ç¡® æ­£ç¡® åœ¨å‘ç”Ÿçž¬æ—¶ç½‘ç»œé”™è¯¯çš„æƒ…å†µä¸‹ï¼ŒIanå°†æ¶ˆæ¯å‘é€åˆ°æœåŠ¡å™¨ï¼Œå¹¶ä¸”ä¸çŸ¥é“æœåŠ¡å™¨æ˜¯å¦æ”¶åˆ°å®ƒã€‚å¦‚æžœæ²¡æœ‰ï¼Œè¯¥äº‹ä»¶ä»Žä¸è®¡ç®—åœ¨å†…ã€‚ä»–çš„ä»£ç å¯èƒ½ä¼šè®°å½•é”™è¯¯ï¼Œç„¶åŽç»§ç»­å‰è¿›ã€‚ æœ‰è¶£çš„æ˜¯ï¼Œé¢å¯¹é•¿æœŸçš„ç½‘ç»œä¸­æ–­æˆ–å‘½ä»¤é”™è¯¯ï¼Œâ€œä¸è¦é‡è¯•â€æ˜¯æ­£ç¡®çš„ç­–ç•¥ï¼Œå› ä¸ºè¿™äº›æ˜¯éžçž¬æ€é”™è¯¯ï¼Œæ— æ³•é€šè¿‡é‡è¯•æ”¹å–„ã€‚ æ€»æ˜¯é‡è¯•ä¸€äº›ç¨‹åºå‘˜ç¼–å†™ä»£ç é‡è¯•ä»»ä½•å¤±è´¥çš„æ“ä½œäº”æ¬¡ï¼Œæˆ–è€…ï¼Œå¦‚æžœä»–ä»¬çœŸçš„å…³å¿ƒå¼¹æ€§ï¼Œåæ¬¡ã€‚æˆ‘åœ¨å¾ˆå¤šç”Ÿäº§åº”ç”¨ç¨‹åºä¸­éƒ½çœ‹åˆ°äº†è¿™ä¸€ç‚¹ã€‚ 123456789i = 0while True: try: do_operation() break except network error: i += 1 if i == MAX_RETRY_COUNT: throw åŽ»å¹´ï¼Œæˆ‘ä¸Žä¸€ä½åä¸ºSamçš„Rackspaceå·¥ç¨‹å¸ˆè¿›è¡Œäº†äº¤è°ˆã€‚ä»–æŽ¥æ‰‹äº†ä¸€ä¸ªåº”ç”¨äº†è¿™ä¸ªä¸å¥½çš„ç­–ç•¥çš„Pythonä»£ç åº“ï¼šå®ƒåªè¦æŽ¥æ”¶åˆ°ä»»ä½•å¼‚å¸¸å°±ä¼šä¸€éåˆä¸€éåœ°é‡è¯•ã€‚ Samè®¤ä¸ºè¿™æ˜¯æ„šè ¢çš„ã€‚ä»–æ³¨æ„åˆ°æˆ‘æœ€è¿‘æ ¹æ®æœåŠ¡å™¨å‘çŽ°å’Œç›‘æµ‹è§„èŒƒé‡æ–°ç¼–å†™äº†PyMongoçš„å®¢æˆ·ç«¯ä»£ç ï¼Œä»–æŽ¨æµ‹ä»–å¯ä»¥æ›´å¥½åœ°åˆ©ç”¨æ›´å¼ºå¤§çš„æ–°é©±åŠ¨ç¨‹åºã€‚åœ¨é‚£é‡Œæœ‰ä¸€ä¸ªæ›´èªæ˜Žçš„é‡è¯•ç­–ç•¥ï¼Œä½†ä»–ä¸çŸ¥é“å®ƒåˆ°åº•æ˜¯ä»€ä¹ˆã€‚äº‹å®žä¸Šï¼Œæ­£æ˜¯ä»Žæˆ‘ä¸ŽSamçš„å¯¹è¯ä¸­ï¼Œè¿™ç¯‡æ–‡ç« è¯žç”Ÿäº†ã€‚ Samçœ‹åˆ°äº†ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆIanä¸åº”è¯¥é‡è¯•æ¯æ¬¡æ“ä½œäº”åˆ°åæ¬¡ï¼Ÿ çž¬æ€ç½‘ç»œé”™è¯¯ æŒç»­ä¸­æ–­ å‘½ä»¤é”™è¯¯ å¯èƒ½è¿‡å¤šè®¡æ•° æµªè´¹æ—¶é—´ æµªè´¹æ—¶é—´ åœ¨ç½‘ç»œå‡ºçŽ°çž¬æ€é”™è¯¯çš„æƒ…å†µä¸‹ï¼ŒIanä¸ä¼šä¸¢å¤±è®¡æ•°ï¼ŒçŽ°åœ¨ä»–å¯èƒ½ä¼šè®¡æ•°è¿‡å¤šã€‚å› ä¸ºå¦‚æžœæœåŠ¡å™¨åœ¨å‘ç”Ÿç½‘ç»œé”™è¯¯ä¹‹å‰å…ˆè¯»å–å…¶ç¬¬ä¸€æ¡updateOneæ¶ˆæ¯ï¼Œåˆ™ç¬¬äºŒæ¡updateOneæ¶ˆæ¯ä¼šå†æ¬¡é€’å¢žè®¡æ•°å™¨ã€‚ å¦ä¸€æ–¹é¢ï¼Œåœ¨æŒç»­çš„ç½‘ç»œä¸­æ–­æœŸé—´ï¼Œå¤šæ¬¡é‡è¯•æ˜¯æµªè´¹æ—¶é—´ã€‚ç¬¬ä¸€æ¬¡ç½‘ç»œé”™è¯¯åŽï¼Œé©±åŠ¨ç¨‹åºå°†primaryæœåŠ¡å™¨æ ‡è®°ä¸ºâ€œunknownâ€; å½“Iané‡è¯•è¯¥æ“ä½œæ—¶ï¼Œå®ƒä¼šåœ¨é©±åŠ¨ç¨‹åºå°è¯•é‡æ–°è¿žæŽ¥æ—¶é˜»å¡žï¼Œæ¯ç§’æ£€æŸ¥ä¸¤æ¬¡ï¼ŒæŒç»­30ç§’ã€‚å¦‚æžœé©±åŠ¨ç¨‹åºä»£ç ä¸­çš„æ‰€æœ‰åŠªåŠ›éƒ½æ²¡æœ‰æˆåŠŸï¼Œé‚£ä¹ˆå†æ¬¡å°è¯•è¿›å…¥é©±åŠ¨ç¨‹åºçš„é‡è¯•å¾ªçŽ¯æ˜¯å¾’åŠ³çš„ã€‚è¿™ä¼šå¯¼è‡´ä»–çš„åº”ç”¨ç¨‹åºå‡ºçŽ°æŽ’é˜Ÿå’Œå»¶è¿Ÿã€‚ å‘½ä»¤é”™è¯¯ä¹Ÿæ˜¯å¦‚æ­¤ï¼šå¦‚æžœIançš„åº”ç”¨ç¨‹åºæœªè¢«æŽˆæƒï¼Œåˆ™é‡è¯•äº”æ¬¡ä¸ä¼šæ”¹å˜è¯¥æƒ…å†µã€‚ é‡è¯•ä¸€æ¬¡ç½‘ç»œé”™è¯¯çŽ°åœ¨æˆ‘ä»¬æ¯”è¾ƒæŽ¥è¿‘ä¸€ä¸ªæ˜Žæ™ºçš„ç­–ç•¥ã€‚åœ¨Ianåˆå§‹æ“ä½œå¤±è´¥å¹¶å‡ºçŽ°ç½‘ç»œé”™è¯¯åŽï¼ŒIanä¸çŸ¥é“é”™è¯¯æ˜¯æš‚æ—¶çš„è¿˜æ˜¯æŒä¹…çš„ï¼Œå› æ­¤ä»–åªé‡è¯•ä¸€æ¬¡æ“ä½œã€‚å•æ¬¡é‡è¯•è¿›å…¥é©±åŠ¨ç¨‹åºçš„30ç§’é‡è¯•å¾ªçŽ¯ã€‚å¦‚æžœç½‘ç»œé”™è¯¯æŒç»­30ç§’ï¼Œåˆ™å¯èƒ½ä¼šæŒç»­æ›´é•¿æ—¶é—´ï¼Œæ‰€ä»¥Ianæ”¾å¼ƒäº†ç»§ç»­é‡è¯•ã€‚ ä½†æ˜¯ï¼Œé¢å¯¹å‘½ä»¤é”™è¯¯ï¼Œä»–æ ¹æœ¬ä¸ä¼šé‡è¯•ã€‚ çž¬æ€ç½‘ç»œé”™è¯¯ æŒç»­ä¸­æ–­ å‘½ä»¤é”™è¯¯ å¯èƒ½è¿‡å¤šè®¡æ•° æ­£ç¡® æ­£ç¡® æ‰€ä»¥æˆ‘ä»¬åªå‰©ä¸‹ä¸€ç§æƒ…å†µè¿˜æœ‰é—®é¢˜ - Ianæ€Žä¹ˆé¿å…è¿‡å¤šè®¡æ•°çš„å¯èƒ½æ€§ï¼Ÿ é‡è¯•ç½‘ç»œé”™è¯¯ï¼Œä½¿æ“ä½œå¹‚ç­‰å¹‚ç­‰æ€§æ“ä½œæ— è®ºæ˜¯ä¸€æ¬¡è¿˜æ˜¯å¤šæ¬¡æ‰§è¡Œéƒ½å…·æœ‰ç›¸åŒçš„ç»“æžœã€‚å¦‚æžœIançš„æ‰€æœ‰æ“ä½œéƒ½æ˜¯å¹‚ç­‰çš„ï¼Œé‚£ä¹ˆä»–å¯ä»¥å®‰å…¨åœ°é‡è¯•å®ƒä»¬ï¼Œè€Œä¸ä¼šå‘ç”Ÿè¿‡å¤šè®¡æ•°æˆ–ä»»ä½•ç”±äºŽå‘é€æ¶ˆæ¯ä¸¤æ¬¡å¸¦æ¥çš„å…¶ä»–ç±»åž‹é”™è¯¯ã€‚ çž¬æ€ç½‘ç»œé”™è¯¯ æŒç»­ä¸­æ–­ å‘½ä»¤é”™è¯¯ æ­£ç¡® æ­£ç¡® æ­£ç¡® é‚£ä¹ˆIanåº”è¯¥å¦‚ä½•è®©ä»–çš„updateOneæ“ä½œå¹‚ç­‰ï¼Ÿ å¹‚ç­‰æ“ä½œMongoDBæœ‰å››ç§æ“ä½œï¼šæŸ¥æ‰¾ï¼Œæ’å…¥ï¼Œåˆ é™¤å’Œæ›´æ–°ã€‚å‰ä¸‰ä¸ªå¾ˆå®¹æ˜“å¹‚ç­‰æ€§; è®©æˆ‘ä»¬å…ˆæ¥å¤„ç†å®ƒä»¬ã€‚ FindæŸ¥è¯¢è‡ªç„¶æ˜¯å¹‚ç­‰çš„ã€‚ 1234try: doc = findOne()except network err: doc = findOne() ä¸¤æ¬¡æ£€ç´¢æ–‡æ¡£ä¸Žæ£€ç´¢ä¸€æ¬¡æ–‡æ¡£ç»“æžœä¸€æ ·ã€‚ Insertæ¯”æŸ¥è¯¢å›°éš¾ä¸€ç‚¹ï¼Œä½†ä¸æ˜¯å¤ªç³Ÿç³•ã€‚ 123456789doc = &#123;_id: ObjectId(), ...&#125;try: insertOne(doc)except network err: try: insertOne(doc) except DuplicateKeyError: pass # first try worked throw è¿™ä¸ªä¼ªä»£ç çš„ç¬¬ä¸€æ­¥æ˜¯åœ¨å®¢æˆ·ç«¯ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„IDã€‚ MongoDBçš„ObjectIdæ˜¯ä¸ºè¿™ç§ç”¨æ³•è€Œè®¾è®¡çš„ï¼Œä½†ä»»ä½•ç‹¬ç‰¹çš„å€¼éƒ½å¯ä»¥ã€‚ çŽ°åœ¨ï¼ŒIanè¯•å›¾æ’å…¥æ–‡æ¡£ã€‚å¦‚æžœå› ç½‘ç»œé”™è¯¯è€Œå¤±è´¥ï¼Œä»–ä¼šå†æ¬¡å°è¯•ã€‚å¦‚æžœç¬¬äºŒæ¬¡å°è¯•å¤±è´¥ä¸”æœåŠ¡å™¨å‡ºçŽ°é‡å¤é”®é”™è¯¯ï¼Œåˆ™ç¬¬ä¸€æ¬¡å°è¯•æˆåŠŸï¼Œä½†ç”±äºŽç½‘ç»œå±‚å‘ç”Ÿé”™è¯¯ï¼Œä»–æ— æ³•è¯»å–æœåŠ¡å™¨å“åº”ã€‚å¦‚æžœå‡ºçŽ°å…¶ä»–é—®é¢˜ï¼Œä»–å–æ¶ˆæ“ä½œå¹¶æŠ›å‡ºå¼‚å¸¸ã€‚ è¿™ä¸ªæ’å…¥æ˜¯å¹‚ç­‰çš„ã€‚å”¯ä¸€éœ€è¦è­¦å‘Šçš„æ˜¯ï¼Œæˆ‘å‡è®¾Iané™¤äº†MongoDBè‡ªåŠ¨åˆ›å»ºçš„_idä¹‹å¤–ï¼Œæ²¡æœ‰å”¯ä¸€ç´¢å¼•ã€‚å¦‚æžœè¿˜æœ‰å…¶ä»–å”¯ä¸€ç´¢å¼•ï¼Œé‚£ä¹ˆä»–å¿…é¡»è§£æžé‡å¤é”®é”™è¯¯ã€‚ Deleteå¦‚æžœIanåˆ é™¤ä¸€ä¸ªæ–‡æ¡£æ—¶æŒ‡å®šä¸€ä¸ªå”¯ä¸€çš„keyï¼Œé‚£ä¹ˆæ‰§è¡Œä¸¤æ¬¡ä¸Žæ‰§è¡Œä¸€æ¬¡ç›¸åŒã€‚ 1234try: deleteOne(&#123;'key': uniqueValue&#125;)except network err: deleteOne(&#123;'key': uniqueValue&#125;) å¦‚æžœç¬¬ä¸€ä¸ªè¢«æ‰§è¡Œï¼Œä½†æ˜¯Ianå¾—åˆ°ä¸€ä¸ªç½‘ç»œå¼‚å¸¸å¹¶å†æ¬¡å°è¯•ï¼Œé‚£ä¹ˆç¬¬äºŒä¸ªåˆ é™¤å°±æ˜¯ç©ºæ“ä½œ;å®ƒåªæ˜¯ä¸åŒ¹é…ä»»ä½•æ–‡æ¡£ã€‚è¯¥åˆ é™¤å¯ä»¥å®‰å…¨åœ°é‡è¯•ã€‚ åŒæ—¶åˆ é™¤è®¸å¤šæ–‡ä»¶ç”šè‡³æ›´å®¹æ˜“ï¼š 1234try: deleteMany(&#123;...&#125;)except network err: deleteMany(&#123;...&#125;) å¦‚æžœIanåˆ é™¤æ‰€æœ‰åŒ¹é…è¿‡æ»¤å™¨çš„æ–‡æ¡£ï¼Œå¹¶ä¸”ä»–çš„ä»£ç å‡ºçŽ°ç½‘ç»œé”™è¯¯ï¼Œé‚£ä¹ˆä»–å¯ä»¥å†æ¬¡å®‰å…¨åœ°å°è¯•ã€‚æ— è®ºæ˜¯deleteOneè¿è¡Œä¸€æ¬¡è¿˜æ˜¯ä¸¤æ¬¡ï¼Œç»“æžœéƒ½æ˜¯ä¸€æ ·çš„ï¼šæ‰€æœ‰åŒ¹é…çš„æ–‡æ¡£éƒ½è¢«åˆ é™¤ã€‚ åœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹éƒ½å­˜åœ¨ç«žäº‰æ¡ä»¶ï¼šå¦ä¸€ä¸ªè¿›ç¨‹å¯èƒ½ä¼šåœ¨ä¸¤æ¬¡å°è¯•åˆ é™¤å®ƒä»¬ä¹‹é—´æ’å…¥æ–°çš„åŒ¹é…æ–‡æ¡£ã€‚ä½†æ˜¯è¿™åœºæ¯”èµ›å¹¶ä¸æ¯”ä»–çš„ä»£ç æ²¡æœ‰é‡è¯•æ›´ç³Ÿç³•ã€‚ Updateé‚£ä¹ˆæ›´æ–°å‘¢ï¼Ÿé¦–å…ˆè€ƒè™‘é‚£ç§è‡ªç„¶è€Œç„¶æ˜¯å¹‚ç­‰çš„æ›´æ–°ï¼Œè®©æˆ‘ä»¬æ”¾æ¾ä¸€ä¸‹ã€‚ 12345# Idempotent update.updateOne(&#123; '_id': '2016-06-28'&#125;, &#123;'$set':&#123;'sunny': True&#125;&#125;, upsert=True) è¿™ä¸Žæˆ‘ä»¬åŽŸæ¥çš„ä¾‹å­ä¸ä¸€æ ·; Ianå¹¶æ²¡æœ‰å¢žåŠ ä¸€ä¸ªå˜é‡çš„å€¼ï¼Œä»–æŠŠä»Šå¤©çš„â€œsunnyâ€å­—æ®µè®¾ç½®ä¸ºçœŸï¼Œè®©è‡ªå·±æŒ¯ä½œèµ·æ¥ã€‚è¯´ä¸¤æ¬¡ä»Šå¤©æ˜¯é˜³å…‰æ˜Žåªšçš„ï¼Œå°±åƒè¯´ä¸€æ¬¡ä¸€æ ·å¥½ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒupdateOneå¯ä»¥å®‰å…¨åœ°é‡è¯•ã€‚ ä¸€èˆ¬åŽŸåˆ™æ˜¯æœ‰ä¸€äº›MongoDBæ›´æ–°è¿ç®—ç¬¦æ˜¯å¹‚ç­‰çš„ï¼Œæœ‰äº›åˆ™ä¸æ˜¯ã€‚ $setæ˜¯å¹‚ç­‰çš„ï¼Œå› ä¸ºå¦‚æžœä¸¤æ¬¡å°†æŸäº›å€¼è®¾ç½®ä¸ºç›¸åŒçš„å€¼ï¼Œåˆ™ä¸ä¼šæœ‰ä»»ä½•åŒºåˆ«ï¼Œè€Œ$incä¸æ˜¯å¹‚ç­‰çš„ã€‚ å¦‚æžœIançš„æ›´æ–°æ“ä½œç¬¦æ˜¯å¹‚ç­‰çš„ï¼Œé‚£ä¹ˆä»–å¯ä»¥å¾ˆå®¹æ˜“åœ°é‡è¯•å®ƒï¼šä»–å°è¯•ä¸€æ¬¡ï¼Œå¦‚æžœä»–å¾—åˆ°ç½‘ç»œå¼‚å¸¸ï¼Œä»–ä¼šå†æ¬¡å°è¯•ã€‚ 123456try: updateOne(&#123;' _id': '2016-06-28'&#125;, &#123;'$set':&#123;'sunny': True&#125;&#125;, upsert=True)except network err: try again, if that fails throw æ‰€ä»¥çŽ°åœ¨æˆ‘ä»¬ç»ˆäºŽå‡†å¤‡å¥½è§£å†³æˆ‘ä»¬æœ€éš¾çš„ä¾‹å­ï¼ŒåŽŸå§‹çš„éžå¹‚ç­‰updateOneï¼š 123updateOne(&#123; '_id': '2016-06-28'&#125;, &#123;'$inc': &#123;'counter': 1&#125;&#125;, upsert=True) å¦‚æžœIanå¶ç„¶åšäº†ä¸¤æ¬¡è¿™æ ·çš„æ“ä½œï¼Œä»–ä¼šå°†è®¡æ•°å¢žåŠ 2ã€‚ æˆ‘ä»¬å¦‚ä½•å°†å®ƒå˜æˆå¹‚ç­‰æ“ä½œï¼Ÿæˆ‘ä»¬å°†åˆ†æˆä¸¤æ­¥ã€‚æ¯ä¸€æ­¥éƒ½æ˜¯å¹‚ç­‰çš„ï¼Œé€šè¿‡å°†å®ƒè½¬æ¢æˆä¸€å¯¹å¹‚ç­‰è¿ç®—ï¼Œæˆ‘ä»¬å°†å®‰å…¨åœ°é‡è¯•ã€‚ æˆ‘ä»¬å‡è®¾ä¸€å¼€å§‹æ–‡æ¡£çš„counterå€¼æ˜¯Nï¼š 1234&#123; _id: '2016-06-28', counter: N&#125; åœ¨ç¬¬ä¸€æ­¥ä¸­ï¼ŒIanå…ˆä¸ç®¡counterå½“å‰çš„å€¼ï¼Œä»–åªæ˜¯ç»™ä¸€ä¸ªâ€œpendingâ€æ•°ç»„æ·»åŠ ä¸€ä¸ªæ ‡è®°ã€‚è¿™é‡Œä»–éœ€è¦ä¸€äº›ç‹¬ç‰¹çš„ä¸œè¥¿; ä¸€ä¸ªObjectIdæ˜¯å¾ˆå¥½çš„é€‰æ‹©ï¼š 1234567oid = ObjectId()try: updateOne(&#123; '_id': '2016-06-28'&#125;, &#123;'$addToSet': &#123;'pending': oid&#125;&#125;, upsert=True)except network err: try again, then throw $addToSetæ˜¯å¹‚ç­‰è¿ç®—ç¬¦ä¹‹ä¸€ã€‚å¦‚æžœå®ƒè¿è¡Œä¸¤æ¬¡ï¼Œä»¤ç‰Œåªä¼šæ·»åŠ ä¸€æ¬¡åˆ°æ•°ç»„ä¸­ã€‚çŽ°åœ¨æ–‡æ¡£çœ‹èµ·æ¥åƒè¿™æ ·ï¼š 12345&#123; _id: '2016-06-28', counter: N, pending: [ ObjectId("...") ]&#125; ç¬¬äºŒæ­¥ï¼Œå¯¹äºŽå•ä¸ªæ“ä½œï¼ŒIané€šè¿‡_idåŠå…¶å¾…å¤„ç†æ ‡è®°æŸ¥è¯¢æ–‡æ¡£ï¼Œåˆ é™¤å¾…å¤„ç†æ ‡è®°å¹¶å¢žåŠ è®¡æ•°å™¨ã€‚ 123456789try: # Search for the document by _id and pending token. updateOne(&#123;'_id': '2016-06-28', 'pending': oid&#125;, &#123;'$pull': &#123;'pending': oid&#125;, '$inc': &#123;'counter': 1&#125;&#125;, upsert=False)except network err: try again, then throw æ‰€æœ‰çš„MongoDBæ›´æ–°ï¼Œæ— è®ºå®ƒä»¬æ˜¯å¦æ˜¯å¹‚ç­‰çš„ï¼Œéƒ½æ˜¯åŽŸå­çš„ï¼šå•ä¸ªupdateOneå®Œå…¨æˆåŠŸæˆ–æ ¹æœ¬æ²¡æœ‰ä»»ä½•ä½œç”¨ã€‚æ‰€ä»¥åªæœ‰å½“è®¡æ•°å™¨å¢žåŠ 1æ—¶, ä»¤ç‰Œæ‰ä¼šä»Žå¾…å¤„ç†æ•°ç»„ä¸­ç§»é™¤ã€‚ æ€»çš„æ¥è¯´ï¼Œè¿™ä¸ªæ›´æ–°æ˜¯å¹‚ç­‰çš„ã€‚æƒ³è±¡ä¸€ä¸‹ï¼ŒIanå°†ä»¤ç‰Œç§»å‡ºæ•°ç»„å¹¶åœ¨ç¬¬ä¸€æ¬¡å°è¯•æ—¶é€’å¢žè®¡æ•°å™¨ï¼Œä½†æ˜¯ä¹‹åŽä»–æ— æ³•è¯»å–æœåŠ¡å™¨å“åº”ï¼Œå› ä¸ºå­˜åœ¨ç½‘ç»œé”™è¯¯ã€‚ä»–ç¬¬äºŒæ¬¡å°è¯•æ˜¯æ— æ•ˆçš„ï¼Œå› ä¸ºæŸ¥è¯¢è¦æ±‚åŒ¹é…å…·æœ‰å¾…å¤„ç†ä»¤ç‰Œçš„æ–‡æ¡£ï¼Œä½†ä»–å·²ç»å°†å…¶å–å‡ºã€‚ æ‰€ä»¥Ianå¯ä»¥å®‰å…¨åœ°é‡è¯•è¿™â€‹â€‹ä¸ªupdateOneã€‚æ— è®ºå®ƒæ‰§è¡Œäº†ä¸€æ¬¡è¿˜æ˜¯ä¸¤æ¬¡ï¼Œæ–‡æ¡£ç»“æžœéƒ½æ˜¯ä¸€æ ·çš„ï¼š 12345&#123; _id: '2016-06-28', counter: N + 1, pending: [ ]&#125; ä»»åŠ¡å®Œæˆï¼ŸçŽ°åœ¨ä½ å·²ç»åšåˆ°äº†ï¼šä½ é‡çŽ°å®žçŽ°äº†IanåŽŸæ¥çš„updateOneï¼Œè¿™æ˜¯ä¸å®‰å…¨çš„é‡è¯•ï¼Œå¹¶é€šè¿‡å°†å®ƒåˆ†æˆä¸¤æ­¥æ¥ä½¿å®ƒå˜å¾—å¹‚ç­‰ã€‚ è¿™é¡¹æŠ€æœ¯æœ‰å‡ ç‚¹éœ€è¦æ³¨æ„ã€‚å…¶ä¸­ä¹‹ä¸€æ˜¯Ianç®€å•çš„$incæ“ä½œçŽ°åœ¨éœ€è¦ä¸¤æ¬¡å¾€è¿”ã€‚å®ƒéœ€è¦å»¶è¿Ÿä¸¤å€ï¼Œè´Ÿè½½åŠ å€ã€‚å¦‚æžœåœ¨ç½‘ç»œçž¬æ€é”™è¯¯ä¸­è¢«å°‘è®¡å…¥ä¸€æ¬¡æˆ–è¶…è¿‡ä¸€æ¬¡æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œä»–å°±ä¸åº”è¯¥ä½¿ç”¨è¿™ç§æŠ€æœ¯ã€‚ å¦ä¸€ä¸ªè­¦å‘Šæ˜¯ï¼Œä»–éœ€è¦ä¸€ä¸ªæ¯æ™šæ‰§è¡Œçš„æ¸…ç†è¿‡ç¨‹ã€‚è€ƒè™‘ä¸€ä¸‹ï¼šå¦‚æžœç¬¬äºŒæ­¥ä»Žæœªå®Œæˆï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ 12345678try: updateOne(&#123;'_id': '2016-06-28', 'pending': oid&#125;, &#123;'$pull': &#123;'pending': oid&#125;, '$inc': &#123;'counter': 1&#125;&#125;, upsert=False)except network err: try again, then throw å‡è®¾Ianåœ¨æ·»åŠ å¾…å¤„ç†ä»¤ç‰ŒåŽï¼Œå°†å…¶ç§»é™¤å¹¶å¢žåŠ è®¡æ•°å™¨ä¹‹å‰ï¼Œç½‘ç»œä¸­æ–­å¼€å§‹ã€‚è¯¥æ–‡ä»¶å¤„äºŽè¿™ç§çŠ¶æ€ï¼š 12345&#123; _id: '2016-06-28', counter: N, pending: [ ObjectId("...") ]&#125; Ianéœ€è¦ä¸€ä¸ªæ¯æ™šæ‰§è¡Œçš„ä»»åŠ¡æ¥æŸ¥æ‰¾ä»Šå¤©ä¸­æ­¢çš„ä»»åŠ¡é—ç•™çš„ä»»ä½•å¾…å¤„ç†ä»¤ç‰Œï¼Œå¹¶å®Œæˆæ›´æ–°è®¡æ•°å™¨ã€‚ä¸ºäº†é¿å…å¹¶å‘é—®é¢˜ï¼Œä»–ä¸€ç›´ç­‰åˆ°ä¸€å¤©ç»“æŸã€‚ä»–çš„ä»»åŠ¡ä½¿ç”¨èšåˆç®¡é“æ¥æŸ¥æ‰¾å…·æœ‰å¾…å¤„ç†ä»¤ç‰Œçš„æ–‡æ¡£ï¼Œå¹¶å°†å…¶æ•°é‡æ·»åŠ åˆ°å½“å‰è®¡æ•°ä¸­ï¼š 1234567891011121314151617181920pipeline = [&#123; '$match': &#123;'pending.0': &#123;'$exists': True&#125;&#125;&#125;, &#123; '$project': &#123; 'counter': &#123; '$add': [ '$counter', &#123;'$size': '$pending'&#125; ] &#125; &#125;&#125;]for doc in collection.aggregate(pipeline): collection.updateOne( &#123; '_id': doc._id&#125;, &#123; '$set': &#123;'counter': doc.counter&#125;, '$unset': &#123;'pending': True&#125; &#125;) å¯¹äºŽæ¯ä¸ªèšåˆæ“ä½œç»“æžœï¼Œæ­¤ä»»åŠ¡ä½¿ç”¨æœ€ç»ˆè®¡æ•°å™¨å€¼æ›´æ–°æºæ–‡æ¡£ï¼Œå¹¶æ¸…é™¤å¾…å¤„ç†æ•°ç»„ã€‚ updateOneå¯ä»¥å®‰å…¨åœ°é‡è¯•ï¼Œå› ä¸ºå®ƒä½¿ç”¨å¹‚ç­‰è¿ç®—ç¬¦$setå’Œ$unsetã€‚Iançš„æ¸…ç†ä»»åŠ¡å¯ä»¥ä¸€ç›´å°è¯•ï¼Œç›´åˆ°å®ƒæˆåŠŸï¼Œæ— è®ºä»–çš„ç½‘ç»œæœ‰å¤šä¹ˆç³Ÿç³•ã€‚æ‰§è¡Œæ­¤æ¸…ç†ä»»åŠ¡åŽï¼ŒIanä»Šå¤©çš„äº‹ä»¶æ•°é‡æœ€ç»ˆå°†æ˜¯æ­£ç¡®çš„ã€‚ å¦‚æžœIanæŽ¥å—è¿™äº›ç¼ºç‚¹ - ä¸€æ¬¡å¢žåŠ éœ€è¦ä¸¤æ¬¡å¾€è¿”ï¼Œå¹¶ä¸”å¯èƒ½åœ¨ä¸€å¤©ç»“æŸä¹‹å‰ä¸èƒ½å®Œæˆ - é‚£ä¹ˆå¯¹äºŽéžå¸¸å…³é”®çš„æ“ä½œï¼Œè¿™ç§æŠ€æœ¯æ˜¯ä¸€ç§å¯é çš„æ–¹å¼æ¥ä½¿å…¶è®¡æ•°å™¨åªå¢žåŠ ä¸€æ¬¡ã€‚ Ref How To Write Resilient MongoDB Applications Retryable Writes]]></content>
  </entry>
  <entry>
    <title><![CDATA[Deadlock caused by forking a multithreaded process]]></title>
    <url>%2Fdeadlock-caused-by-forking-a-multithreaded-process%2F</url>
    <content type="text"><![CDATA[æœ€è¿‘ç”Ÿäº§çŽ¯å¢ƒçš„ä¸€ä¸ªæ¨¡å—çªç„¶å¡ä½äº†ï¼Œæ¨¡å—çš„ä½œè€…å·²ç»åŽ»å…¶ä»–ç»„äº†ï¼Œæ²¡åŠžæ³•åªèƒ½è‡ªå·±æŸ¥é—®é¢˜äº†ðŸ¤£ã€‚ è¯¥æ¨¡å—ä½¿ç”¨pythonçš„loggingæ ‡å‡†åº“è®°å½•æ—¥å¿—ï¼Œè‡ªå®šä¹‰kafkaä½œä¸ºhandlerï¼Œæ—¥å¿—é€šè¿‡kafkaå‘é€åˆ°Elasticsearchï¼Œç„¶åŽå°±æ˜¯ELKæ—¥å¿—å¤„ç†äº†ã€‚ æ¨¡å—ä¸ºäº†æé«˜åžåï¼Œå†…éƒ¨ä½¿ç”¨äº†å¤šè¿›ç¨‹ï¼Œé—®é¢˜æ°æ°å°±å‡ºçŽ°åœ¨äº†è¿™é‡Œã€‚ ä½¿ç”¨GDB attachåˆ°å¡æ­»çš„è¿›ç¨‹ï¼Œæ‰§è¡Œpy-btå‘½ä»¤ï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š Traceback (most recent call first): File â€œ/usr/lib64/python2.7/multiprocessing/forking.pyâ€, line 135, in poll pid, sts = os.waitpid(self.pid, flag) File â€œ/usr/lib64/python2.7/multiprocessing/forking.pyâ€, line 154, in wait return self.poll(0) File â€œ/usr/lib64/python2.7/multiprocessing/process.pyâ€, line 145, in join res = self._popen.wait(timeout) File â€œparser/parser_main.pyâ€, line 76, in data_parse process.join() ä¸»è¿›ç¨‹é‡Œä½¿ç”¨multiprocessingæ¨¡å—åˆ›å»ºå¤šè¿›ç¨‹æ‰§è¡Œä»»åŠ¡ï¼Œè¿™é‡Œä¸»è¿›ç¨‹åœ¨ç­‰å¾…å­è¿›ç¨‹æ‰§è¡Œç»“æŸã€‚ é˜…è¯»multiprocessingæ¨¡å—çš„æºä»£ç ï¼Œå¯ä»¥å‘çŽ°å…¶åˆ›å»ºå­è¿›ç¨‹æ—¶è°ƒç”¨äº†os.fork()å‡½æ•°ï¼Œè¯¥å‡½æ•°æ˜¯python osæ¨¡å—å¯¹ç³»ç»Ÿè°ƒç”¨forkçš„å°è£…ã€‚ å­è¿›ç¨‹çš„è¾“å‡ºï¼š Traceback (most recent call first): Waiting for the GIL File â€œsdk/python-lib/kafka/producer/record_accumulator.pyâ€, line 223, in append with self._tp_locks[tp]: File â€œsdk/python-lib/kafka/producer/kafka.pyâ€, line 516, in send self.config[â€˜max_block_msâ€™]) File â€œsdk/python-lib/elk_logging/handlers/kafka.pyâ€, line 37, in emit self.format(record).encode(â€˜utf-8â€™)) elk_loggingæ¨¡å—è‡ªå®šä¹‰äº†kafka handlerï¼Œæ¨¡å—å¯¼å…¥æ—¶é€šè¿‡logging.config.dictConfig()é…ç½®loggingæ¨¡å—ã€‚kafakå‘é€æ¶ˆæ¯æ—¶èŽ·å–ä¸åˆ°é”self._tp_lock[tp]ï¼Œç„¶åŽä¸€ç›´ç­‰å¾…ã€‚ åœ¨Googleä¸Šæœç´¢â€œkafka self._tp_lock deadlockâ€æ²¡æœ‰å‘çŽ°æœ‰ä»·å€¼çš„ä¿¡æ¯ï¼ŒåŸºæœ¬æŽ’é™¤æ˜¯kafkaåº“çš„bugï¼Œå¦‚æžœæ˜¯kafkaåº“çš„bugï¼Œç½‘ä¸Šä¸å¤ªå¯èƒ½ä¸€ç‚¹çº¿ç´¢ä¹Ÿæ²¡æœ‰ã€‚ å‰æ–‡æˆ‘ä»¬æåˆ°è¿™é‡Œä½¿ç”¨äº†forkåˆ›å»ºå­è¿›ç¨‹ï¼Œå½“å†…æ ¸æ‰§è¡Œforkæ—¶ï¼Œç”Ÿæˆçš„å­è¿›ç¨‹æ˜¯çˆ¶è¿›ç¨‹çš„å‰¯æœ¬ï¼Œå­è¿›ç¨‹èŽ·å¾—çˆ¶è¿›ç¨‹çš„æ•°æ®ç©ºé—´ã€å †å’Œæ ˆçš„å‰¯æœ¬ï¼ˆè¿™é‡Œæ˜¯å­è¿›ç¨‹è‡ªå·±æ‹¥æœ‰çš„å‰¯æœ¬ï¼Œå¹¶ä¸ä¸Žçˆ¶è¿›ç¨‹å…±äº«è¿™äº›å­˜å‚¨ç©ºé—´ã€‚å¾ˆå¤šå®žçŽ°ä½¿ç”¨äº†å†™æ—¶å¤åˆ¶æŠ€æœ¯ï¼Œä¸€å¼€å§‹è¿™äº›åŒºåŸŸè¢«çˆ¶å­è¿›ç¨‹å…±äº«ï¼Œå¦‚æžœä»»æ„ä¸€ä¸ªè¿›ç¨‹ä¿®æ”¹è¿™äº›åŒºåŸŸï¼Œåˆ™å†…æ ¸åªä¸ºä¿®æ”¹çš„é‚£å—å†…å­˜åˆ¶ä½œä¸€ä¸ªå‰¯æœ¬ï¼Œé€šå¸¸æ˜¯è™šæ‹Ÿå†…å­˜çš„ä¸€é¡µï¼‰ã€‚ åœ¨Linuxç³»ç»Ÿä¸­è°ƒç”¨forkï¼Œåˆ›å»ºçš„å­è¿›ç¨‹ä¸­åªæœ‰ä¸€ä¸ªçº¿ç¨‹â€”â€”çˆ¶è¿›ç¨‹ä¸­è°ƒç”¨forkå‡½æ•°çš„çº¿ç¨‹ã€‚ Note the following further points: The child process is created with a single threadâ€”the one that called fork(). The entire virtual address space of the parent is replicated in the child, including the states of mutexes, condition variables, and other pthreads objects; the use of pthread_atfork(3) may be helpful for dealing with problems that this can cause. ä¹Ÿä¸æ˜¯æ‰€æœ‰çš„ç³»ç»Ÿéƒ½æ˜¯è¿™æ ·ï¼ŒSolarisç³»ç»Ÿlibthreadåº“æä¾›çš„forkå‡½æ•°ä¼šâ€œå¤åˆ¶â€œæ‰€æœ‰çº¿ç¨‹ã€‚ Solaris libthread supports both fork() and fork1(). The fork() call has â€œfork-allâ€ semanticsâ€“it duplicates everything in the process, including threads and LWPs, creating a true clone of the parent. The fork1() call creates a clone that has only one thread; the process state and address space are duplicated, but only the calling thread is cloned. POSIX libpthread supports only fork(), which has the same semantics as fork1() in Solaris threads. POSIXæ ‡å‡†å®šä¹‰çš„è¡Œä¸ºæ˜¯forkåªâ€œå¤åˆ¶â€ä¸€ä¸ªçº¿ç¨‹ã€‚ é‚£ä¹ˆè¿™äº›ä¸Žä¸Šé¢çš„æ­»é”æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿpythonæ ‡å‡†åº“loggingæ¨¡å—åœ¨åˆ›å»ºloggeræ—¶ä¼šè°ƒç”¨åˆ°ä»¥ä¸‹ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°ä¸€ä¸ªloggeråªä¼šå®žä¾‹åŒ–ä¸€æ¬¡ï¼Œå¯¹åº”çš„handlerå’Œformatterç­‰ä¹Ÿåªä¼šå®žä¾‹åŒ–ä¸€æ¬¡ã€‚ logging/__init__.py manager.getLogger(name)123456789101112131415161718_acquireLock()try: if name in self.loggerDict: rv = self.loggerDict[name] if isinstance(rv, PlaceHolder): ph = rv rv = (self.loggerClass or _loggerClass)(name) rv.manager = self self.loggerDict[name] = rv self._fixupChildren(ph, rv) self._fixupParents(rv) else: rv = (self.loggerClass or _loggerClass)(name) rv.manager = self self.loggerDict[name] = rv self._fixupParents(rv)finally: _releaseLock() å¦‚æžœè‡ªå®šä¹‰äº†handlerï¼Œé…ç½®loggingæ¨¡å—æ—¶ä¼šå¯¼å…¥æŒ‡å®šçš„handler classï¼Œå¹¶å®žä¾‹åŒ–ã€‚ logging/config.py DictConfigurator.configure_handler()123456789101112131415161718if '()' in config: c = config.pop('()') if not callable(c): c = self.resolve(c) factory = celse: cname = config.pop('class') klass = self.resolve(cname) factory = klassprops = config.pop('.', None)kwargs = dict([(k, config[k]) for k in config if valid_ident(k)])try: result = factory(**kwargs)except TypeError as te: if "'stream'" not in str(te): raise kwargs['strm'] = kwargs.pop('stream') result = factory(**kwargs) çˆ¶è¿›ç¨‹å’Œforkå‡ºæ¥çš„å­è¿›ç¨‹ä½¿ç”¨çš„æ—¶ç›¸åŒçš„å¯¹è±¡å®žä¾‹ï¼Œç›¸åŒçš„loggerï¼Œç›¸åŒçš„kafka handlerã€‚ kafka producerå‘é€æ¶ˆæ¯æ˜¯å¤šçº¿ç¨‹å¼‚æ­¥çš„ã€‚KafkaProducerå®žä¾‹åŒ–æ—¶ä¼šå¯åŠ¨ä¸€ä¸ªæ¶ˆæ¯å‘é€çº¿ç¨‹ã€‚æœ‰æ¶ˆæ¯è¿‡æ¥åŽï¼Œå…ˆé€šè¿‡RecordAccumulatorç±»å®žä¾‹å°†æ¶ˆæ¯è¿½åŠ åˆ°å†…éƒ¨listï¼Œç„¶åŽå”¤é†’self._senderå‘é€çº¿ç¨‹ï¼Œå‘é€çº¿ç¨‹é€šè¿‡RecordAccumulatorç±»å®žä¾‹æ£€æŸ¥å“ªäº›å¯ä»¥å‘é€ï¼Œæ•´ä¸ªè¿‡ç¨‹RecordAccumulatorç±»å®žä¾‹ç»´æŠ¤äº†topic+partitionç›¸å…³çš„é”ã€‚1234567891011121314def __init__(self, **configs): ... self._accumulator = RecordAccumulator(message_version=message_version, metrics=self._metrics, **self.config) self._sender = Sender(client, self._metadata, self._accumulator, self._metrics, guarantee_message_order=guarantee_message_order, **self.config) self._sender.daemon = True self._sender.start() self._closed = False self._cleanup = self._cleanup_factory() atexit.register(self._cleanup) log.debug("Kafka producer started") å¦‚æžœforkæ—¶RecordAccumulatorç±»å®žä¾‹ä¸­æŸä¸ªtopic+partitionçš„é”è¿˜æ²¡æœ‰é‡Šæ”¾ï¼Œå­è¿›ç¨‹ä¸­è¯¥é”æ°¸è¿œä¸ä¼šè¢«é‡Šæ”¾ï¼Œå› ä¸ºæ²¡æœ‰äº†å‘é€çº¿ç¨‹ï¼Œå¦‚æžœå­è¿›ç¨‹ä¸­æ°å¥½å‘åŒä¸€ä¸ªtopicå’ŒåŒä¸€ä¸ªpartitionå‘é€æ¶ˆæ¯å°±ä¼šæ­»é”ã€‚ ç”±äºŽå­è¿›ç¨‹ä¸ä¼šå¸¸é©»åœ¨åŽå°ï¼Œæ‰€ä»¥æ»¡è¶³ä¸Šè¿°æ¡ä»¶è¿˜æ˜¯æ¯”è¾ƒéš¾çš„ï¼Œä»Žè¡¨çŽ°ä¸Šæ¥çœ‹ï¼Œ5ä¸ªæœˆé‡Œå‘ç”Ÿäº†ä¸€æ¬¡æ­»é”ã€‚ åŽè®°é¿å…è¿™ç§é—®é¢˜ï¼Œæœ€å¥½çš„åŠžæ³•å°±æ˜¯ä¸è¦forkä¸€ä¸ªå¤šçº¿ç¨‹è¿›ç¨‹ã€‚ pythonçš„æ ‡å‡†åº“loggingæ¨¡å—æ›¾ç»å› ä¸ºç±»ä¼¼çš„åŽŸå› å‡ºè¿‡é—®é¢˜ã€‚çŽ°åœ¨å®˜æ–¹æ–‡æ¡£å·²ç»æŒ‡å‡ºï¼š Note that safely forking a multithreaded process is problematic. Googleç”šè‡³è¿˜åˆ›å»ºè¿‡ä¸€ä¸ªé¡¹ç›®python-atforkï¼Œæ¨¡ä»¿pthread_atforkï¼Œå¯ä»¥æ³¨å†Œå‡½æ•°ï¼Œä¿æ­£å¤šçº¿ç¨‹çš„æƒ…å†µä¸‹å¯ä»¥å®‰å…¨çš„forkã€‚å½“ç„¶ï¼Œè¯¥é¡¹ç›®å·²ç»è¢«åºŸå¼ƒäº†ã€‚ å¦‚æžœä½¿ç”¨è¾ƒæ–°çš„pythonç‰ˆæœ¬ï¼ˆ3.5+ ï¼Ÿï¼‰å¯ä»¥æŒ‡å®šmultiprocessingæ¨¡å—åˆ›å»ºè¿›ç¨‹çš„æ–¹å¼ï¼Œå¯ä»¥å°è¯•spawnæ–¹å¼ã€‚ Ref UNIXçŽ¯å¢ƒé«˜çº§ç¼–ç¨‹ Linux fork manual Special Issues for fork() and Solaris Threads python multiprocessing doc Safe to call multiprocessing from a thread in Pythonï¼Ÿ reentrancy, thread safe, asynchronous signal safe, interrupt safe and cancellation safe Threads and fork(): think twice before mixing them]]></content>
  </entry>
  <entry>
    <title><![CDATA[Debug Python with GDB in off-line CentOS]]></title>
    <url>%2Fdebug-python-with-gdb-in-offline-centos%2F</url>
    <content type="text"><![CDATA[GDBä¸ä»…å¯ä»¥è°ƒè¯•C/C++ç¨‹åºï¼Œå®ƒè¿˜å¯ä»¥è°ƒè¯•Pythonç­‰ç¨‹åºï¼Œæ˜¯éžå¸¸é‡è¦å’Œæœ‰åŠ›çš„å¼€å‘å·¥å…·ä¹‹ä¸€ã€‚å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œéƒ½å¯ä»¥ç›´æŽ¥å®‰è£…å‘è¡Œç‰ˆæä¾›çš„gdbæ¥è°ƒè¯•ç¨‹åºï¼Œä½†æ˜¯ï¼ŒæŸäº›æƒ…å†µä¸‹éœ€è¦è‡ªå·±ç¼–è¯‘ï¼Œä¾‹å¦‚ï¼Œæœºå™¨æ— æ³•ä¸Šç½‘ï¼›ç”šè‡³æ²¡æœ‰æƒé™ä¿®æ”¹ç³»ç»Ÿï¼Œæ— æ³•å®‰è£…è½¯ä»¶ã€‚ä¸‹é¢ä»¥CentOSä¸ºä¾‹ï¼Œä»‹ç»å¦‚ä½•åœ¨ç¦»çº¿å¹¶ä¸”æ²¡æœ‰å…¨éƒ¨æƒé™çš„æƒ…å†µä¸‹ä½¿ç”¨GDBè°ƒè¯•Pythonç¨‹åºã€‚ é¦–å…ˆï¼Œéœ€è¦åœ¨ç›¸åŒç³»ç»Ÿç‰ˆæœ¬å¯ä»¥ä¸Šç½‘çš„æœºå™¨ä¸Šç¼–è¯‘GDB wget -c http://ftp.gnu.org/gnu/gdb/gdb-8.0.1.tar.gz tar xvf gdb-8.0.1.tar.gz cd gdb-8.0.1.tar.gz mkdir build cd build ../configure --enable-static --with-python --disable-interprocess-agent --with-lzma make éœ€è¦æ‹¿åˆ°ç¦»çº¿æœºå™¨ä½¿ç”¨ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨â€˜â€“enable-static â€“disable-interprocess-agentâ€™ï¼ŒæœŸæœ›èŽ·å¾—ä¸€ä¸ªé™æ€é“¾æŽ¥çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚é€šè¿‡â€˜â€“with-pythonâ€™å¯ç”¨äº†pythonè°ƒè¯•åŠŸèƒ½ã€‚â€˜â€“with-lzmaâ€™å¯ç”¨äº†lzmaæ”¯æŒï¼Œç”±äºŽæŸäº›å‘è¡Œç‰ˆåˆ†å‘çš„äºŒè¿›åˆ¶æ–‡ä»¶ä½¿ç”¨äº†â€˜MiniDebugInfoâ€™ç‰¹æ€§ï¼šåœ¨äºŒè¿›åˆ¶æ–‡ä»¶ä¸­å­˜åœ¨ä¸€ä¸ªåä¸ºâ€˜gnu_debugdataâ€™çš„ç‰¹æ®ŠåŒºåŸŸï¼Œè¯¥åŒºåŸŸä¿å­˜äº†ç»è¿‡lzmaåŽ‹ç¼©çš„é¢å¤–ç¬¦å·ä¿¡æ¯ã€‚ å¦‚æžœåœ¨configureè¿‡ç¨‹ä¸­æŠ¥é”™ï¼Œä¸€èˆ¬éƒ½æ˜¯ç¼ºå°‘ä¸€äº›ä¾èµ–åŒ…ï¼Œæ ¹æ®æç¤ºè¿›è¡Œå®‰è£…å°±å¯ä»¥äº†ã€‚ ç¼–è¯‘å®ŒæˆåŽï¼Œéœ€è¦çš„æ–‡ä»¶éƒ½åœ¨build/gdbç›®å½•å†…ï¼Œå°†ä»–ä»¬å¤åˆ¶åˆ°å¦ä¸€ä¸ªç›®å½• mkdir -p ~/gdb/data-directory cd gdb cp gdb ~/gdb/gdb cp -r data-directory/* ~/gdb/data-directory cd ~/gdb chmod +x ./gdb data-directoryç›®å½•å†…ä¿å­˜äº†gdbéœ€è¦ä½¿ç”¨çš„æ•°æ®æ–‡ä»¶ã€‚çŽ°åœ¨å°±å¯ä»¥ä½¿ç”¨è¿™ä¸ªgdbåœ¨ç¦»çº¿ç³»ç»Ÿä¸Šç®€å•è°ƒè¯•ç¨‹åºäº† ./gdb --data-directory=./data-directory your-program ä½†æ˜¯å½“è¿›å…¥åˆ°ä¸€äº›åº“å‡½æ•°æ—¶ï¼Œä¼šå‡ºçŽ°é”™è¯¯ï¼Œå› ä¸ºç³»ç»Ÿä¸Šæ²¡æœ‰ç›¸åº”çš„è°ƒè¯•ä¿¡æ¯æ–‡ä»¶ã€‚éœ€è¦æ‰‹åŠ¨éƒ¨ç½²è¿™äº›æ–‡ä»¶ï¼Œä»¥è°ƒè¯•Pythonä¸ºä¾‹ï¼Œé¦–å…ˆèŽ·å–ç³»ç»Ÿä¸­pythonåŒ…çš„ç‰ˆæœ¬ yum list installed | grep ^python.x86_64 å‡å¦‚å¾—åˆ°çš„ä¿¡æ¯æ˜¯â€˜python.x86_64 2.7.5-58.el7â€™ï¼ŒåŽ»debuginfo.centos.orgä¸‹è½½ç›¸åº”çš„è°ƒè¯•ä¿¡æ¯æ–‡ä»¶ï¼Œä¾‹å¦‚ï¼Œâ€™python-debuginfo-2.7.5-58.el7.x86_64.rpmâ€˜ã€‚ å°†è¯¥æ–‡ä»¶è§£åŒ… rpm2cpio python-debuginfo-2.7.5-58.el7.x86_64.rpm | cpio -idmv æ­£å¸¸æƒ…å†µä¸‹ï¼Œè¯¥æ–‡ä»¶æ˜¯é€šè¿‡rpmå®‰è£…åˆ°ç³»ç»Ÿé‡Œçš„ï¼Œå®‰è£…åŽçš„ç»“æž„å’Œç›´æŽ¥è§£åŽ‹å‡ºæ¥çš„ç»“æž„å¯èƒ½ä¸åŒï¼Œç³»ç»Ÿç›®å½•ï¼š ls -l /usr/lib/debug/ drwxr-xr-x. 3 root root 64 11æœˆ 5 2016 . dr-xr-xr-x. 44 root root 4096 10æœˆ 28 21:38 .. lrwxrwxrwx. 1 root root 7 10æœˆ 28 21:21 bin -&gt; usr/bin lrwxrwxrwx. 1 root root 7 10æœˆ 28 21:21 lib -&gt; usr/lib lrwxrwxrwx. 1 root root 9 10æœˆ 28 21:21 lib64 -&gt; usr/lib64 lrwxrwxrwx. 1 root root 8 10æœˆ 28 21:21 sbin -&gt; usr/sbin drwxr-xr-x. 6 root root 65 10æœˆ 28 21:21 usr è§£åŒ…ç›®å½•ï¼š ls -al ./usr/lib/debug/ drwxr-xr-x. 5 buildbot buildbot 46 10æœˆ 29 23:26 . drwxrwxr-x. 3 buildbot buildbot 19 10æœˆ 29 23:26 .. drwxr-xr-x. 114 buildbot buildbot 4096 10æœˆ 29 23:26 .build-id drwxr-xr-x. 2 buildbot buildbot 40 10æœˆ 29 23:26 .dwz drwxr-xr-x. 4 buildbot buildbot 30 10æœˆ 29 23:26 usr ç³»ç»Ÿç›®å½•ä¸­çš„ç¬¦å·é“¾æŽ¥ï¼Œè§£åŒ…ç›®å½•é‡Œæ˜¯æ²¡æœ‰çš„ï¼Œéœ€è¦æ‰‹åŠ¨åŠ ä¸Šã€‚è§£åŒ…ç›®å½•é‡Œçš„â€˜.build-idâ€™æ–‡ä»¶å¤¹æ˜¯éžå¸¸é‡è¦çš„æ–‡ä»¶å¤¹ã€‚ GDBå…è®¸å°†è°ƒè¯•ä¿¡æ¯å’Œå¯æ‰§è¡Œä»£ç åˆ†å¼€å­˜æ”¾ï¼Œå› ä¸ºä¸€èˆ¬æƒ…å†µï¼Œè°ƒè¯•ä¿¡æ¯æ¯”å¯æ‰§è¡Œä»£ç å¤§å¾ˆå¤šï¼Œæ™®é€šç”¨æˆ·ä¸éœ€è¦è°ƒè¯•ä¿¡æ¯ã€‚åˆ†å¼€å­˜æ”¾å¾ˆå¥½çš„è§£å†³äº†æ­¤é—®é¢˜ã€‚ GDBæ”¯æŒä¸¤ç§æŒ‡å®šè°ƒè¯•ä¿¡æ¯æ–‡ä»¶çš„æ–¹æ³•ï¼š å¯æ‰§è¡Œæ–‡ä»¶åŒ…å«ä¸€ä¸ªâ€˜debug linkâ€™ï¼Œå…¶æŒ‡å®šäº†è°ƒè¯•æ–‡ä»¶çš„åå­—ã€‚é€šå¸¸è°ƒè¯•ä¿¡æ¯æ–‡ä»¶çš„åå­—æ˜¯â€˜executable.debugâ€™ï¼Œå…¶ä¸­ï¼Œâ€˜executableâ€™æ˜¯å¯æ‰§è¡Œæ–‡ä»¶çš„åå­—ï¼ˆä¸åŒ…æ‹¬è·¯å¾„ï¼‰ã€‚å¹¶ä¸”ï¼Œâ€˜debug linkâ€™è¿˜åŒ…å«äº†å¯æ‰§è¡Œæ–‡ä»¶çš„CRC32å€¼ï¼ŒGDBå¯ä»¥åˆ©ç”¨è¯¥å€¼åˆ¤æ–­å¯æ‰§è¡Œæ–‡ä»¶å’Œè°ƒè¯•ä¿¡æ¯æ–‡ä»¶æ˜¯å¦æ¥è‡ªç›¸åŒçš„buildã€‚ å¯æ‰§è¡Œæ–‡ä»¶åŒ…å«ä¸€ä¸ªç‰¹æ®Šçš„å­—ç¬¦ä¸²â€˜build-idâ€™ï¼Œè¯¥å­—ç¬¦ä¸²åŒæ—¶ä¹Ÿå­˜åœ¨äºŽè°ƒè¯•ä¿¡æ¯æ–‡ä»¶ä¸­ã€‚è°ƒè¯•ä¿¡æ¯æ–‡ä»¶çš„åå­—å¯ä»¥é€šè¿‡â€˜build-idâ€™è®¡ç®—å‡ºæ¥ã€‚ å¯¹äºŽä»¥ä¸Šä¸¤ç§ä¸åŒçš„æ–¹å¼ï¼ŒGDBé‡‡ç”¨ä¸¤ç§æ–¹æ³•æŸ¥æ‰¾è°ƒè¯•ä¿¡æ¯æ–‡ä»¶ï¼š å¯¹äºŽâ€˜debug linkâ€™æ–¹å¼ï¼ŒGDBå…ˆåœ¨å¯æ‰§è¡Œæ–‡ä»¶æ‰€åœ¨ç›®å½•æœç´¢æŒ‡å®šåå­—çš„è°ƒè¯•ä¿¡æ¯æ–‡ä»¶ï¼Œç„¶åŽæ˜¯å¯æ‰§è¡Œæ–‡ä»¶æ‰€åœ¨ç›®å½•ä¸­åä¸ºâ€˜.debugâ€™çš„å­ç›®å½•é‡Œæœç´¢ï¼Œæœ€åŽï¼Œåœ¨æ‰€æœ‰å…¨å±€â€˜debug directoryâ€™é‡Œçš„å’Œå¯æ‰§è¡Œæ–‡ä»¶ç»å¯¹ç›®å½•åå­—ä¸€æ ·çš„å­ç›®å½•é‡Œæœç´¢ã€‚ å¯¹äºŽâ€˜build-idâ€™æ–¹å¼ï¼ŒGDBåœ¨æ¯ä¸€ä¸ªå…¨å±€â€˜debug directoryâ€™é‡Œåä¸ºâ€˜build-idâ€™çš„å­ç›®å½•ä¸­æœç´¢åä¸ºâ€˜nn/nnnnnnnn.debugâ€™çš„æ–‡ä»¶ï¼ˆCentOSä¸­è¯¥æ–‡ä»¶æ˜¯ä¸€ä¸ªç¬¦å·é“¾æŽ¥ï¼‰ã€‚ å‡†å¤‡å¥½äº†ä»¥ä¸Šæ–‡ä»¶åŽï¼Œè¿˜éœ€è¦æœ€åŽä¸€ä¸ªå¾ˆé‡è¦çš„æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å®šä¹‰äº†è°ƒè¯•éœ€è¦ç”¨åˆ°çš„GDBå‘½ä»¤ã€‚è¯¥æ–‡ä»¶ä½äºŽ ./usr/lib/debug/usr/lib64/libpython2.7.so.1.0.debug-gdb.py å°†è¯¥æ–‡ä»¶é‡å‘½åä¸ºpython-gdb.pyï¼Œå¹¶å’Œå…¶ä»–æ–‡ä»¶æ”¾ä¸€èµ·ã€‚çŽ°åœ¨gdbç›®å½•çš„ç»“æž„æ˜¯è¿™æ ·çš„ï¼š gdb data-directory usr python-gdb.py å¯åŠ¨gdbåŽéœ€è¦import python-gdb.pyï¼Œä¿®æ”¹PYTHONPATH export PYTHONPATH=&quot;${PYTHONPATH}:${HOME}/gdb&quot; ç„¶åŽå¯åŠ¨gdb ./gdb --data-directory=./data-directory è®¾ç½®debugæ–‡ä»¶æŸ¥æ‰¾ç›®å½•ï¼Œå‘Šè¯‰GDBåŽ»å‡†å¤‡å¥½çš„è§£åŒ…ç›®å½•æ‰¾è°ƒè¯•ä¿¡æ¯ set debug-file-directory ./usr/lib/debug/ è½½å…¥pythonæ¨¡å—ï¼Œè½½å…¥è‡ªå®šä¹‰GDBå‘½ä»¤ python import python-gdb ç„¶åŽattachåˆ°éœ€è¦è°ƒè¯•çš„è¿›ç¨‹å°±å¯ä»¥äº† attach pid Ref MiniDebugInfo Building Python Statically how-i-can-static-build-gdb-from-source How do I extract the contents of an rpm? Debugging Information in Separate Files]]></content>
  </entry>
  <entry>
    <title><![CDATA[MongoDB Data Migration]]></title>
    <url>%2FMongoDB-Data-Migrate%2F</url>
    <content type="text"><![CDATA[MongoDBä½¿ç”¨jsonå’Œbsonï¼ˆbinary jsonï¼‰æ ¼å¼å­˜å‚¨ä¿¡æ¯ã€‚jsonä½¿ç”¨èµ·æ¥éžå¸¸æ–¹ä¾¿ï¼Œä½†æ˜¯å…¶å¹¶ä¸æ”¯æŒbsoné‡Œçš„æ‰€æœ‰æ•°æ®ç±»åž‹ã€‚å¦‚æžœä½¿ç”¨jsonå¤‡ä»½æ•°æ®å°±ä¼šæœ‰ä¿¡æ¯ä¸¢å¤±ã€‚ å¤‡ä»½å’Œæ¢å¤MongoDBæ•°æ®åº“å¯èƒ½ä¼šæ¶ˆè€—å¤§é‡çš„CPUã€å†…å­˜å’Œç£ç›˜èµ„æºï¼Œæœ€å¥½æ˜¯åœ¨éžé«˜å³°æœŸè¿›è¡Œã€‚ éœ€è¦è€ƒè™‘æ•°æ®ä¸€è‡´æ€§çš„é—®é¢˜ã€‚ ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ä¸€è‡´æ€§æ˜¯æŒ‡äº‹åŠ¡ä½¿å¾—ç³»ç»Ÿä»Žä¸€ä¸ªä¸€è‡´çš„çŠ¶æ€è½¬æ¢åˆ°å¦ä¸€ä¸ªä¸€è‡´çŠ¶æ€ã€‚äº‹åŠ¡çš„ä¸€è‡´æ€§å†³å®šäº†ä¸€ä¸ªç³»ç»Ÿè®¾è®¡å’Œå®žçŽ°çš„å¤æ‚åº¦ã€‚äº‹åŠ¡å¯ä»¥ä¸åŒç¨‹åº¦çš„ä¸€è‡´æ€§ï¼šå¼ºä¸€è‡´æ€§ï¼šè¯»æ“ä½œå¯ä»¥ç«‹å³è¯»åˆ°æäº¤çš„æ›´æ–°æ“ä½œã€‚å¼±ä¸€è‡´æ€§ï¼šæäº¤çš„æ›´æ–°æ“ä½œï¼Œä¸ä¸€å®šç«‹å³ä¼šè¢«è¯»æ“ä½œè¯»åˆ°ï¼Œæ­¤ç§æƒ…å†µä¼šå­˜åœ¨ä¸€ä¸ªä¸ä¸€è‡´çª—å£ï¼ŒæŒ‡çš„æ˜¯è¯»æ“ä½œå¯ä»¥è¯»åˆ°æœ€æ–°å€¼çš„ä¸€æ®µæ—¶é—´ã€‚æœ€ç»ˆä¸€è‡´æ€§ï¼šæ˜¯å¼±ä¸€è‡´æ€§çš„ç‰¹ä¾‹ã€‚äº‹åŠ¡æ›´æ–°ä¸€ä»½æ•°æ®ï¼Œæœ€ç»ˆä¸€è‡´æ€§ä¿è¯åœ¨æ²¡æœ‰å…¶ä»–äº‹åŠ¡æ›´æ–°åŒæ ·çš„å€¼çš„è¯ï¼Œæœ€ç»ˆæ‰€æœ‰çš„äº‹åŠ¡éƒ½ä¼šè¯»åˆ°ä¹‹å‰äº‹åŠ¡æ›´æ–°çš„æœ€æ–°å€¼ã€‚å¦‚æžœæ²¡æœ‰é”™è¯¯å‘ç”Ÿï¼Œä¸ä¸€è‡´çª—å£çš„å¤§å°ä¾èµ–äºŽï¼šé€šä¿¡å»¶è¿Ÿï¼Œç³»ç»Ÿè´Ÿè½½ç­‰ã€‚ å…¶ä»–ä¸€è‡´æ€§å˜ä½“è¿˜æœ‰ï¼šå•è°ƒä¸€è‡´æ€§ï¼šå¦‚æžœä¸€ä¸ªè¿›ç¨‹å·²ç»è¯»åˆ°ä¸€ä¸ªå€¼ï¼Œé‚£ä¹ˆåŽç»­ä¸ä¼šè¯»åˆ°æ›´æ—©çš„å€¼ã€‚ä¼šè¯ä¸€è‡´æ€§ï¼šä¿è¯å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨äº¤äº’çš„ä¼šè¯è¿‡ç¨‹ä¸­ï¼Œè¯»æ“ä½œå¯ä»¥è¯»åˆ°æ›´æ–°æ“ä½œåŽçš„æœ€æ–°å€¼ã€‚ copydb &amp; clone Concurrency copydb and clone do not produce point-in-time snapshots of the source database. Write traffic to the source or destination database during the copy process will result in divergent data sets. copydb does not lock the destination server during its operation, so the copy will occasionally yield to allow other operations to complete. clone does not snapshot the database. If any clients update the database youâ€™re copying at any point during the clone operation, the resulting database may be inconsistent. æœ‰æ•°æ®ä¸€è‡´æ€§çš„é—®é¢˜ã€‚ mongodump &amp; mongorestore ä»¥bsonæ ¼å¼ä¿å­˜ï¼Œæ¢å¤å®ŒæˆåŽå¿…é¡»é‡å»ºç´¢å¼•ã€‚ å¯¹äºŽå°åž‹çš„æ•°æ®åº“æ˜¯ç®€å•é«˜æ•ˆçš„å¤‡ä»½æ¢å¤å·¥å…·ï¼Œä½†æ˜¯å¯¹äºŽå¤§åž‹ç³»ç»Ÿä¸æ˜¯ä¸€ä¸ªç†æƒ³çš„é€‰æ‹©ã€‚ mongodumpä¼šæ˜¾è‘—å½±å“MongoDBçš„æ€§èƒ½ã€‚å¦‚æžœæ•°æ®åº“å¤§å°è¶…è¿‡ç³»ç»Ÿå†…å­˜ï¼Œæœ‰å¯èƒ½å‡ºçŽ°å†…å­˜ä¸è¶³å’Œé¡µé”™è¯¯ã€‚ without â€“oplogï¼Œ if there are write operations during the dump operation, the dump will not reflect a single moment in time. Changes made to the database during the update process can affect the output of the backup. ä½¿ç”¨oplogå¯ä»¥ä¿è¯æ•°æ®ä¸€è‡´æ€§ master &amp; slaveslaveæŠŠmasterçš„æ•°æ®ä¿å­˜åœ¨äº†local.sources collectionã€‚è¿ç§»å®ŒæˆåŽéœ€è¦è¿›ä¸€æ­¥å¤„ç†ã€‚æœ¬è´¨ä¸Šä¹Ÿæ˜¯åˆ©ç”¨äº†oplog, å¯ä»¥ä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚ Replication Setç›¸å½“äºŽå¢žå¼ºçš„master slaveæ¨¡å¼ï¼Œå¸¦æœ‰failoveræœºåˆ¶ï¼Œå¤šä¸ªèŠ‚ç‚¹é€‰å–ä¸€ä¸ªä¸ºä¸»èŠ‚ç‚¹ï¼Œå…¶ä»–ä¸ºæ¬¡èŠ‚ç‚¹ï¼Œä¸»èŠ‚ç‚¹å¯è¯»å†™ï¼Œæ¬¡èŠ‚ç‚¹åªèƒ½è¯»ï¼Œå½“ä¸»èŠ‚ç‚¹æŒ‚æŽ‰ä¼šè‡ªåŠ¨é€‰ä¸¾æ–°çš„ä¸»èŠ‚ç‚¹ï¼Œæ–¹ä¾¿åŠ å…¥æ–°çš„æ¬¡èŠ‚ç‚¹ï¼Œæ‰©å±•æ•°æ®åº“ç³»ç»Ÿï¼Œæœ¬è´¨ä¸Šä¹Ÿæ˜¯åˆ©ç”¨äº†oplog, å¯ä»¥ä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚ æ€»ç»“copydb &amp; clone æœ‰æ•°æ®ä¸€è‡´æ€§é—®é¢˜ä¸è€ƒè™‘ä½¿ç”¨ã€‚master &amp; slaveæ¨¡å¼ï¼ŒslaveåŽç»­è¿˜éœ€è¦è¿›ä¸€æ­¥æ“ä½œï¼Œå¹¶ä¸”å®˜æ–¹å·²ä¸æŽ¨èéƒ¨ç½²æ­¤æ¨¡å¼ã€‚Replication Setæä¾›äº†å¾ˆå¤šé«˜çº§ç‰¹æ€§ï¼Œæ˜¯å®˜æ–¹çŽ°åœ¨æŽ¨èçš„éƒ¨ç½²æ¨¡å¼ã€‚å¤„ç†æ•°æ®è¿ç§»æ—¶ï¼Œmaster &amp; slaveå’ŒReplication Setæ¯”è¾ƒæŽ¥è¿‘ï¼Œå‰è€…éœ€è¦è¿›ä¸€æ­¥å¤„ç†ï¼ŒåŽè€…é…ç½®ç•¥éº»çƒ¦ï¼Œéƒ½ç›¸å½“äºŽè‡ªåŠ¨mongodump + oplogreplayï¼Œåœ¨æ•°æ®ä¸æ˜¯å¾ˆå¤§çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥é…ç½®ä¸€ä¸ªå•èŠ‚ç‚¹çš„Replication Seté…åˆmongodump with oplogæ¯”è¾ƒåˆé€‚ã€‚ oplogæœ‰ä¸€ä¸ªéžå¸¸é‡è¦çš„ç‰¹æ€§â€”â€”å¹‚ç­‰æ€§ï¼ˆidempotentï¼‰ã€‚å³å¯¹ä¸€ä¸ªæ•°æ®é›†åˆï¼Œä½¿ç”¨oplogä¸­è®°å½•çš„æ“ä½œé‡æ”¾æ—¶ï¼Œæ— è®ºè¢«é‡æ”¾å¤šå°‘æ¬¡ï¼Œå…¶ç»“æžœæ˜¯ä¸€æ ·çš„ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œå¦‚æžœoplogä¸­è®°å½•çš„æ˜¯ä¸€ä¸ªæ’å…¥æ“ä½œï¼Œå¹¶ä¸ä¼šå› ä¸ºä½ é‡æ”¾äº†ä¸¤æ¬¡ï¼Œæ•°æ®åº“ä¸­å°±å¾—åˆ°ä¸¤æ¡ç›¸åŒçš„è®°å½•ã€‚ è¿˜æœ‰ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿæä¾›çš„å¿«ç…§åŠŸèƒ½ï¼Œæ¯”å¦‚LVMã€‚ RefHow To Back Up, Restore, and Migrate a MongoDB Database on Ubuntu 14.04 Migrating MongoDB instances with no down-time MongoDB Clone MongoDB Copydb MongoDB Replication Master Slave Replication]]></content>
  </entry>
  <entry>
    <title><![CDATA[Inverted Index in the Luence]]></title>
    <url>%2FInverted-Index-in-the-Luence%2F</url>
    <content type="text"><![CDATA[å‡è®¾æœ‰ä¸€æœ¬ä¹¦ï¼Œå‰é¢æœ‰ç›®å½•ï¼Œä¸­é—´æ˜¯æ­£æ–‡ï¼Œæœ€åŽä¼šæœ‰é™„å½•ã€‚æœ‰è¿™æ ·ä¸€ç§é™„å½•ï¼Œå®ƒä¼šæŠŠæ­£æ–‡ä¸­å‡ºçŽ°çš„å…³é”®åè¯åˆ—å‡ºæ¥ï¼Œå¹¶é™„ä¸Šæ­£æ–‡ä¸­å‡ºçŽ°çš„é¡µç ã€‚å½“æˆ‘ä»¬æƒ³æ‰¾æŸä¸ªæœ¯è¯­çš„ç›¸å…³ä¿¡æ¯æ—¶ï¼ŒåŽ»é™„å½•é‡ŒæŸ¥æ­£æ–‡å‡ºçŽ°çš„é¡µç æ˜¾ç„¶æ–¹ä¾¿äº›ã€‚ç›®å½•ç±»ä¼¼äºŽæˆ‘ä»¬å¸¸è§„çš„ç´¢å¼•ï¼Œä¸€ä¸ªç« èŠ‚/æ–‡ä»¶é‡Œæœ‰ä»€ä¹ˆå†…å®¹ï¼›é™„å½•ä¿å­˜çš„ä¿¡æ¯å’Œå®ƒç›¸åï¼Œè¿™ä¸ªä¿¡æ¯å‡ºçŽ°åœ¨å“ªäº›ç« èŠ‚/æ–‡ä»¶é‡Œã€‚æˆ‘ä»¬ç§°é™„å½•è¿™ç§æ•°æ®çš„ç´¢å¼•æ–¹å¼å«åšâ€œInverted Indexâ€ï¼Œä¸­æ–‡ä¸€èˆ¬ç¿»è¯‘ä¸ºâ€œå€’æŽ’ç´¢å¼•â€ã€‚ è¿™ç§æ•°æ®ç»“æž„æ˜¯æœç´¢ç¨‹åºçš„æ ¸å¿ƒæ•°æ®ç»“æž„ï¼Œå®ƒæœ¬èº«å¹¶ä¸å¤æ‚ï¼Œå¾ˆå®¹æ˜“ç†è§£ï¼Œç½‘ä¸Šçš„è§£é‡Šä¹Ÿå¾ˆå¤šï¼Œå…·ä½“å¯ä»¥å‚è€ƒç»´åŸºç™¾ç§‘ã€‚å› ä¸ºæœ€è¿‘æŽ¥è§¦ElasticSearchï¼Œæ¯”è¾ƒå¥½å¥‡å®ƒçš„å€’æŽ’ç´¢å¼•æ˜¯æ€Žä¹ˆå®žçŽ°çš„ã€‚ ElasticSearchæ˜¯ä¸€ä¸ªåŸºäºŽLuceneçš„å…¨æ–‡æœç´¢å¼•æ“Žã€‚Luceneæä¾›äº†æœç´¢çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œç»´æŠ¤å€’æŽ’ç´¢å¼•æ˜¯å…¶ä¸­çš„åŠŸèƒ½ä¹‹ä¸€ã€‚ Luenceçš„å€’æŽ’ç´¢å¼•æ˜¯ç”±è®¸å¤šå­ç‰‡æ®µç»„æˆçš„ã€‚æ¯ä¸€ä¸ªå­ç‰‡æ®µæ˜¯ä¸€ä¸ªå®Œæ•´çš„èƒ½ç‹¬ç«‹å·¥ä½œçš„å­ç´¢å¼•ï¼Œç”±å‡ ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ç»„æˆã€‚å½“æœ‰æ–°çš„æ–‡æ¡£éœ€è¦è¢«ç´¢å¼•æ—¶ï¼Œä¼šæ–°å»ºå­ç´¢å¼•ï¼Œå½“æœ‰æ–‡æ¡£è¢«åˆ é™¤æ—¶ï¼Œå¹¶ä¸ä¼šåˆ é™¤å¯¹åº”çš„ç´¢å¼•æ•°æ®ï¼Œè€Œæ˜¯åšæ ‡è®°ï¼Œè®°å½•è¿™äº›æ•°æ®å·²ç»å¤±æ•ˆäº†ã€‚å­ç´¢å¼•æ•°æ®çš„åˆå¹¶å’Œåˆ é™¤ä¼šåœ¨æŸä¸€æ—¶é—´ç»Ÿä¸€æ‰§è¡Œã€‚ Luenceé‡Œå¯¹æ•°æ®çš„åŸºæœ¬å®šä¹‰æ˜¯è¿™æ ·çš„ï¼š The fundamental concepts in Lucene are index, document, field and term. An index contains a sequence of documents. A document is a sequence of fields. A field is a named sequence of terms. A term is a sequence of bytes. The same sequence of bytes in two different fields is considered a different term. Thus terms are represented as a pair: the string naming the field, and the bytes within the field. æ‰€æœ‰è¿™äº›ä¿¡æ¯éƒ½è¢«ä¿å­˜åˆ°å‡ ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶é‡Œã€‚Luceneä¸ºäº†å‡å°‘æ•°æ®çš„å¤§å°ï¼Œå¯¹æ•°æ®é‡‡ç”¨äº†bit packingçš„åŽ‹ç¼©æ–¹æ³•ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œä¸€ä¸ªå­—èŠ‚å¯ä»¥è¡¨ç¤º0ï½ž127çš„æ— ç¬¦å·æ•°ï¼Œä½†æ˜¯å¦‚æžœæˆ‘ä»¬çš„æ•°æ®ç¡®å®šæœ€å¤§ä¸ä¼šè¶…è¿‡63ï¼Œé‚£å°±å¯ä»¥åªç”¨4ä½æ¥è¡¨ç¤ºï¼Œè¿™æ ·å°±çœåŽ»äº†ä¸€åŠçš„ç©ºé—´ã€‚ç±»ä¼¼çš„æ–¹æ³•è¿˜æœ‰ZigZagç¼–ç ã€‚è¿™éƒ¨åˆ†å®žçŽ°å¯¹åº”ä»£ç org.apache.lucene.util.packedã€‚ ä¸ºäº†æé«˜æœç´¢æ•ˆçŽ‡ï¼ŒLuceneåº•å±‚æŸ¥æ‰¾Term Dictionary(è®°å½•äº†termåœ¨æ–‡æ¡£ä¸­çš„ä½ç½®ä¿¡æ¯)æ—¶ä½¿ç”¨äº†è·³è·ƒé“¾è¡¨çš„æ•°æ®ç»“æž„ã€‚å®ƒç›¸å¯¹äºŽå¹³è¡¡äºŒå‰æ ‘ç®€å•ï¼Œä½†æ˜¯ä¹Ÿæœ‰ä¸é”™çš„æ€§èƒ½ï¼ŒRediesä¸­ä¹Ÿæœ‰ç”¨åˆ°ã€‚ RefWhat is in a Lucene index Exploring Solr Internals : The Lucene Inverted Index Lucene file format How fast is bit packing è·³è·ƒé“¾è¡¨ ZigZag in ProtoBuffers]]></content>
  </entry>
  <entry>
    <title><![CDATA[Valgrindå·¥ä½œåŽŸç†ç®€ä»‹]]></title>
    <url>%2Fhow-valgrind-work%2F</url>
    <content type="text"><![CDATA[Valgrindæ˜¯ä¸€æ¬¾ç”¨äºŽæž„å»ºå†…å­˜è°ƒè¯•ã€å†…å­˜æ³„éœ²æ£€æµ‹ä»¥åŠæ€§èƒ½åˆ†æžçš„è½¯ä»¶å¼€å‘æ¡†æž¶ï¼Œå®ƒæ˜¯ä¸€ä¸ªç”±æ¥è‡ªå…¨ä¸–ç•Œçš„å¼€å‘è€…ç»„ç»‡åˆä½œå¼€å‘å¾—åˆ°çš„å¼€æºè½¯ä»¶ã€‚ä»–çš„åˆå§‹ä½œè€…Julian Sewardåœ¨2006å¹´èŽ·å¾—ç¬¬äºŒå±ŠGoogle-Oâ€™Reillyå¼€æºä»£ç å¥–ã€‚Valgrindè¿™ä¸ªåå­—å–è‡ªåŒ—æ¬§ç¥žè¯ä¸­è‹±çµæ®¿çš„å…¥å£ã€‚ å®˜æ–¹é¦–é¡µä¸Šè¿™ä¸ªéª‘å£«ä¸Žæ¶é¾™çš„ç»˜ç”»ç”±ä¼¦æ•¦ç”»å®¶ Rupert Lees åˆ›ä½œã€‚çµæ„Ÿæ¥è‡ªäºŽç¥žè¯ä¼ è¯´ St George and the Dragon ã€‚æŸæ—¥ï¼Œåœ£ä¹”æ²»åˆ°åˆ©æ¯”äºšåŽ»ï¼Œå½“åœ°æ²¼æ³½ä¸­çš„ä¸€åªæ¶é¾™ï¼ˆä¸€è¯´é³„é±¼ï¼‰åœ¨æ°´æ³‰æ—è¾¹ç­‘å·¢ï¼Œè¿™æ°´æ³‰æ˜¯SileneåŸŽå”¯ä¸€çš„æ°´æºï¼Œå¸‚æ°‘ä¸ºäº†å–æ°´ï¼Œæ¯å¤©éƒ½è¦æŠŠä¸¤å¤´ç»µç¾ŠçŒ®ç¥­ç»™æ¶é¾™ã€‚ åˆ°åŽæ¥ï¼Œç»µç¾Šéƒ½åƒå®Œäº†ï¼Œåªå¥½ç”¨æ´»äººæ¥æ›¿ä»£ï¼Œæ¯å¤©æŠ½ç­¾å†³å®šä½•äººåº”é€‰æ´¾ä½œç‰ºç‰²ã€‚ æœ‰ä¸€å¤©ï¼Œå›½çŽ‹çš„å¥³å„¿è¢«æŠ½ä¸­ï¼Œå›½çŽ‹ä¹Ÿæ²¡æœ‰åŠžæ³•ï¼Œæ‚²ç—›æ¬²ç»ã€‚å½“å°‘å¥³èµ°è¿‘ï¼Œæ­£è¦è¢«æ¶é¾™åžåƒæ—¶ï¼Œåœ£ä¹”æ²»åœ¨è¿™æ—¶èµ¶åˆ°ï¼Œæèµ·åˆ©çŸ›å¯¹æŠ—æ¶é¾™ï¼Œå¹¶ç”¨è…°å¸¦æŠŠå®ƒæŸç¼šä½ï¼Œç‰µåˆ°åŸŽé‡Œå½“ä¼—æ€æ­»ï¼Œæ•‘å‡ºäº†å…¬ä¸»ã€‚ åœ¨è½¯ä»¶å¼€å‘è¿‡ç¨‹ä¸­æˆ‘ä»¬æœ‰æ—¶éœ€è¦è¿½è¸ªç¨‹åºæ‰§è¡Œã€è¯Šæ–­é”™è¯¯ã€è¡¡é‡æ€§èƒ½ç­‰éœ€æ±‚ã€‚å¦‚æžœæœ‰æºä»£ç çš„è¯å¯ä»¥æ·»åŠ ç›¸åº”ä»£ç ï¼Œæ²¡æœ‰æºä»£ç æ—¶è¿™ä¸ªæ–¹æ³•å°±è¡Œä¸é€šäº†ã€‚å‰è€…å¯ä»¥å¯¹æºä»£ç åˆ†æžï¼ŒåŽè€…åªèƒ½åˆ†æžäºŒè¿›åˆ¶äº†ã€‚æˆ‘çš„ç†è§£æ˜¯ï¼Œdynamic Binary Instrumentation (DBI)å¼ºè°ƒå¯¹äºŒè¿›åˆ¶æ‰§è¡Œæ–‡ä»¶çš„è¿½è¸ªä¸Žä¿¡æ¯æ”¶é›†ï¼Œdynamic Binary Analysis (DBA)å¼ºè°ƒå¯¹æ”¶é›†ä¿¡æ¯çš„åˆ†æžï¼Œvalgrindæ˜¯ä¸€ä¸ªDBIæ¡†æž¶ï¼Œä½¿ç”¨å®ƒå¯ä»¥å¾ˆæ–¹ä¾¿æž„å»ºä¸€ä¸ªDBAå·¥å…·ã€‚ Valgrindä½œè€…è®¤ä¸ºå½“æ—¶çš„DBIæ¡†æž¶éƒ½æŠŠæ³¨æ„åŠ›æ”¾åœ¨äº†æ€§èƒ½æ£€æµ‹ä¸Šï¼Œå¯¹ç¨‹åºçš„è´¨é‡(åŽŸæ–‡capabilities)å¹¶æ²¡æœ‰å¤ªæ³¨æ„ã€‚æ‰€ä»¥è®¾è®¡äº†ä¸€ä¸ªæ–°çš„DBIæ¡†æž¶ï¼Œç›®æ ‡æ˜¯å¯ä»¥ä½¿ç”¨å®ƒå¼€å‘é‡åž‹DBAå·¥å…·ã€‚ Valgrindçš„é‡ç‚¹æ˜¯shadow valuesæŠ€æœ¯ï¼Œè¯¥æŠ€æœ¯è¦æ±‚å¯¹æ‰€æœ‰çš„å¯„å­˜å™¨å’Œä½¿ç”¨åˆ°çš„å†…å­˜åšshadowï¼ˆè‡ªå·±ç»´æŠ¤ä¸€ä»½ï¼‰ã€‚å› æ­¤ä½¿ç”¨valgrindå¼€å‘å‡ºæ¥çš„å·¥å…·ä¸€èˆ¬è·‘çš„éƒ½æ¯”è¾ƒæ…¢ã€‚ä¸ºäº†å®žçŽ°shadow valueséœ€è¦æ¡†æž¶å®žçŽ°ä»¥ä¸‹4ä¸ªéƒ¨åˆ†ï¼š Shadow State æä¾› shadow registers (ä¾‹å¦‚ integerã€FPã€SIMD) æä¾› shadow memory è¯»å†™æ“ä½œ 9ä¸ªå…·ä½“åŠŸèƒ½: instrument read/write instructions instrument read/write system calls Allocation and deallocation operations instrument start-up allocations instrument system call (de)allocations instrument stack (de)allocations instrument heap (de)allocations Transparent execution, but with extra output extra output æ ¸å¿ƒæ€æƒ³å°±æ˜¯è¦æŠŠå¯„å­˜å™¨å’Œå†…å­˜ä¸­çš„ä¸œè¥¿è‡ªå·±ç»´æŠ¤ä¸€ä»½ï¼Œå¹¶ä¸”åœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½å¯ä»¥å®‰å…¨æ­£ç¡®åœ°ä½¿ç”¨ï¼ŒåŒæ—¶è®°å½•ç¨‹åºçš„æ‰€æœ‰æ“ä½œï¼Œåœ¨ä¸å½±å“ç¨‹åºæ‰§è¡Œç»“æžœå‰æä¸‹ï¼Œè¾“å‡ºæœ‰ç”¨çš„ä¿¡æ¯ã€‚ä½¿ç”¨shadow valuesæŠ€æœ¯çš„DBIæ¡†æž¶éƒ½ä½¿ç”¨ä¸åŒæ–¹å¼å®žçŽ°äº†ä¸Šè¿°å…¨éƒ¨åŠŸèƒ½æˆ–éƒ¨åˆ†åŠŸèƒ½ã€‚ valgrindç»“æž„ä¸Šåˆ†ä¸ºcoreå’Œtoolï¼Œä¸åŒçš„toolå…·æœ‰ä¸åŒçš„åŠŸèƒ½ã€‚æ¯”è¾ƒç‰¹åˆ«çš„æ˜¯ï¼Œvalgrind tooléƒ½åŒ…å«coreçš„é™æ€é“¾æŽ¥ï¼Œè™½ç„¶æœ‰ç‚¹æµªè´¹ç©ºé—´ï¼Œä½†å¯ä»¥ç®€åŒ–æŸäº›äº‹æƒ…ã€‚å½“æˆ‘ä»¬åœ¨è°ƒç”¨valgrindæ—¶ï¼Œå®žé™…ä¸Šå¯åŠ¨çš„åªæ˜¯ä¸€ä¸ªè§£æžå‘½ä»¤å‚æ•°çš„å¯åŠ¨å™¨ï¼Œç”±è¿™ä¸ªå¯åŠ¨å™¨å¯åŠ¨å…·ä½“çš„toolã€‚ ä¸ºäº†å®žçŽ°ä¸Šè¿°åŠŸèƒ½ï¼Œvalgrindä¼šåˆ©ç”¨dynamic binary re-compilationæŠŠæµ‹è¯•ç¨‹åºï¼ˆclientç¨‹åºï¼‰çš„æœºå™¨ç è§£æžåˆ°VEXä¸­é—´è¯­è¨€ã€‚VEX IRæ˜¯valgrindå¼€å‘è€…ä¸“é—¨è®¾è®¡ç»™DBIä½¿ç”¨çš„ä¸­é—´è¯­è¨€ï¼Œæ˜¯ä¸€ç§RISC likeçš„è¯­è¨€ã€‚ç›®å‰VEX IRä»Žvalgrindåˆ†ç¦»å‡ºåŽ»æˆlibVEXäº†ã€‚libVEXé‡‡ç”¨execution-drivençš„æ–¹å¼ç”¨just-in-timeæŠ€æœ¯åŠ¨æ€åœ°æŠŠæœºå™¨ç è½¬æ¢ä¸ºIRï¼Œå¦‚æžœå‘ç”Ÿäº†æŸäº›toolæ„Ÿå…´è¶£çš„äº‹ä»¶ï¼Œå°±ä¼šhook toolçš„å‡½æ•°ï¼Œtoolä¼šæ’å…¥ä¸€äº›åˆ†æžä»£ç ï¼Œå†æŠŠè¿™äº›ä»£ç è½¬æ¢ä¸ºæœºå™¨ç ï¼Œå­˜å‚¨åˆ°code cacheä¸­ï¼Œä»¥ä¾¿å†éœ€è¦çš„æ—¶å€™æ‰§è¡Œã€‚ Machine Code --&gt; IR --&gt; IR --&gt; Machine Code ^ ^ ^ | | | translate | | | | instrument | | translate valgrindå¯åŠ¨åŽï¼Œcoreã€toolå’Œclientéƒ½åœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œå…±ç”¨ä¸€ä¸ªåœ°å€ç©ºé—´ã€‚coreé¦–å…ˆä¼šåˆå§‹åŒ–å¿…è¦çš„ç»„ä»¶ï¼Œç„¶åŽè½½å…¥clientï¼Œå»ºç«‹clientçš„stackï¼Œå®ŒæˆåŽä¼šè¦æ±‚toolåˆå§‹åŒ–è‡ªå·±ï¼Œtoolå®Œæˆå‰©ä½™éƒ¨åˆ†çš„åˆå§‹åŒ–ï¼Œè¿™æ ·toolå°±å…·æœ‰äº†æŽ§åˆ¶æƒï¼Œå¼€å§‹è½¬æ¢clientç¨‹å¼ã€‚ä»ŽæŸç§æ„ä¹‰ä¸Šè¯´ï¼Œvalgrindæ‰§è¡Œçš„éƒ½æ˜¯åŠ å·¥åŽçš„clientç¨‹åºçš„ä»£ç ã€‚ DBI framework æœ‰ä¸¤ç§åŸºæœ¬çš„æ–¹å¼å¯ä»¥è¡¨ç¤ºcodeå’Œè¿›è¡Œ instrumentationï¼š disassemble-and-resynthesise (D&amp;R)ã€‚Valgrind ä½¿ç”¨è¿™ç§æŠŠmachine codeå…ˆè½¬æˆIRï¼ŒIRä¼šé€šè¿‡åŠ å…¥æ›´IRæ¥instrumentã€‚IRæœ€åŽè½¬å›žmachine codeæ‰§è¡Œï¼ŒåŽŸæœ¬çš„codeå¯¹guest stateçš„æ‰€æœ‰å½±å“éƒ½å¿…é¡»æ˜Žç¡®åœ°è½¬æˆIRï¼Œå› ä¸ºæœ€åŽæ‰§è¡Œçš„æ˜¯çº¯ç²¹ç”±IRè½¬æˆçš„machine codeã€‚ copy-and-annotate (C&amp;A)ã€‚instructionsä¼šè¢«é€å­—åœ°å¤åˆ¶(é™¤äº†ä¸€äº› control flow æ”¹å˜)æ¯ä¸ªinstructionéƒ½åŠ ä¸Šæ³¨è§£æè¿°å…¶å½±å“(annotate)ï¼Œåˆ©ç”¨è¿™äº›æè¿°æ¥å¸®åŠ©åšinstrumentationé€šè¿‡ç»™æ¯æ¡æŒ‡ä»¤æ·»åŠ ä¸€ä¸ªé¢å¤–çš„data structure (DynamoRIO)é€šè¿‡æä¾›ç›¸åº”çš„èŽ·å–æŒ‡ä»¤ç›¸å…³ä¿¡æ¯çš„API (Intel Pin)è¿™äº›æ·»åŠ çš„æ³¨è§£å¯ä»¥æŒ‡å¯¼è¿›è¡Œç›¸åº”çš„instrumentï¼Œå¹¶ä¸”ä¸å½±å“åŽŸæ¥çš„native codeçš„æ‰§è¡Œæ•ˆæžœã€‚ Refæœ¬æ–‡ä¸»è¦å‚è€ƒäº†å®˜æ–¹çš„ç ”ç©¶è®ºæ–‡ï¼ˆ http://valgrind.org/docs/pubs.html ï¼‰ã€‚]]></content>
  </entry>
</search>
